{% extends "layout.html" %}
{% block title %}Licenses{% endblock %}

{% block content %}
<h2 class="text-2xl font-semibold mb-4">Licenses</h2>

<!-- Store radiologists data for JavaScript -->
<div id="radiologistsData" data-radiologists='{{ radiologists|tojson|safe }}' class="hidden"></div>

<div class="mb-4 flex flex-col md:flex-row gap-4">
  <div class="flex-1">
    <input
      type="text"
      id="licenseSearch"
      placeholder="Search by state..."
      class="w-full p-2 border rounded"
      onkeyup="debounceSearch()" />
  </div>
  <div class="w-64">
    <select
      id="doctorFilter"
      class="w-full p-2 border rounded"
      onchange="loadLicenses()">
      <option value="">All Doctors</option>
      {% for rad in radiologists %}
      <option value="{{ rad.id }}">{{ rad.name }}</option>
      {% endfor %}
    </select>
  </div>
  <!-- Add Status Filter Buttons -->
  <div class="flex gap-2">
    <button onclick="filterByStatus('all')" 
            class="px-4 py-2 rounded text-sm font-medium bg-blue-600 text-white hover:bg-blue-700 active-filter" 
            data-status="all">
      All
    </button>
    <button onclick="filterByStatus('Active')" 
            class="px-4 py-2 rounded text-sm font-medium bg-gray-100 hover:bg-gray-200" 
            data-status="Active">
      Active
    </button>
    <button onclick="filterByStatus('Expired')" 
            class="px-4 py-2 rounded text-sm font-medium bg-gray-100 hover:bg-gray-200" 
            data-status="Expired">
      Expired
    </button>
  </div>
</div>

<!-- Licenses Table -->
<div class="bg-white p-4 rounded-lg shadow">
  <h3 class="text-lg font-semibold mb-2">All Licenses</h3>
  <div class="overflow-x-auto">
    <table id="licensesTable" class="min-w-full border text-sm">
      <thead class="bg-gray-100">
        <tr>
          <th class="px-6 py-3 border">Doctor</th>
          <th class="px-6 py-3 border">State</th>
          <th class="px-6 py-3 border">Specialty</th>
          <th class="px-6 py-3 border">Status</th>
          <th class="px-6 py-3 border">Tags</th>
          <th class="px-6 py-3 border">Expiration</th>
          {% if session.user.role == 'admin' %}
          <th class="px-6 py-3 border">Actions</th>
          {% endif %}
          
        </tr>
      </thead>
      <tbody id="licensesTableBody">
        {% for cert in certifications %}
        {% set is_expired = cert.status == 'Expired' or cert.status == 'Revoked' or (cert.expiration_date and cert.expiration_date < now.strftime('%Y-%m-%d')) %}
        <tr id="license-row-{{ cert.id }}" 
            class="hover:bg-opacity-80 {% if is_expired %}bg-red-50{% else %}bg-green-50{% endif %}"
            data-doctor-id="{{ cert.radiologist_id }}">
          <td class="px-6 py-4 border">
            <span class="view-mode">
              <a href="/radmapping/doctors/{{ cert.radiologist_id }}" target="_blank" class="text-blue-700 hover:underline">
                {{ cert.radiologists.name }}
              </a>
            </span>
            <select class="edit-mode hidden w-full px-2 py-1 border rounded">
              {% for rad in radiologists %}
              <option value="{{ rad.id }}" {% if rad.id == cert.radiologist_id %}selected{% endif %}>{{ rad.name }}</option>
              {% endfor %}
            </select>
          </td>
          <td class="px-6 py-4 border">
            <span class="view-mode">{{ cert.state }}</span>
            <input type="text" class="edit-mode hidden w-full px-2 py-1 border rounded" value="{{ cert.state }}">
          </td>
          <td class="px-6 py-4 border">
            <span class="view-mode">{{ cert.specialty }}</span>
            <input type="text" class="edit-mode hidden w-full px-2 py-1 border rounded" value="{{ cert.specialty }}">
          </td>
          <td class="px-6 py-4 border">
            <span class="view-mode">{{ cert.status }}</span>
            <select class="edit-mode hidden w-full px-2 py-1 border rounded">
              <option value="Active" {% if cert.status == 'Active' %}selected{% endif %}>Active</option>
              <option value="Pending" {% if cert.status == 'Pending' %}selected{% endif %}>Pending</option>
              <option value="Expired" {% if cert.status == 'Expired' %}selected{% endif %}>Expired</option>
              <option value="Revoked" {% if cert.status == 'Revoked' %}selected{% endif %}>Revoked</option>
            </select>
          </td>
          <td class="px-6 py-4 border">
            <span class="view-mode">{{ cert.tags }}</span>
            <input type="text" class="edit-mode hidden w-full px-2 py-1 border rounded" value="{{ cert.tags }}">
          </td>
          <td class="px-6 py-4 border">
            <span class="view-mode">{{ cert.expiration_date }}</span>
            <input type="date" class="edit-mode hidden w-full px-2 py-1 border rounded" value="{{ cert.expiration_date }}">
          </td>
          {% if session.user.role == 'admin' %}
          <td class="px-6 py-4 border">
            <div class="view-mode">
              <button onclick="toggleEditMode('{{ cert.id }}')" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
              <form method="POST" action="/radmapping/doctors/{{ cert.radiologist_id }}/licenses/{{ cert.id }}/delete" class="inline">
                <button type="submit" class="text-red-600 hover:text-red-800">Delete</button>
              </form>
            </div>
            <div class="edit-mode hidden">
              <button onclick="saveLicense('{{ cert.id }}')" class="text-green-600 hover:text-green-900 mr-3">Save</button>
              <button onclick="cancelEdit('{{ cert.id }}')" class="text-gray-600 hover:text-gray-900">Cancel</button>
            </div>
          </td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  
  <!-- Pagination Controls -->
  <div class="mt-4 flex justify-between items-center">
    <div class="text-sm text-gray-700">
      Showing <span id="startItem">1</span> to <span id="endItem">{{ per_page }}</span> of <span id="totalItems">{{ total_count }}</span> entries
    </div>
    <div class="flex gap-2">
      <button onclick="changePage('prev')" id="prevPage" class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
        Previous
      </button>
      <button onclick="changePage('next')" id="nextPage" class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
        Next
      </button>
    </div>
  </div>
</div>

<script>
let currentStatusFilter = 'all';
let currentSearchTerm = '';
let currentPage = {{ current_page }};
const itemsPerPage = {{ per_page }};
let totalCount = {{ total_count }};
let searchTimeout;

// Get radiologists data from the hidden div
const radiologists = JSON.parse(document.getElementById('radiologistsData').dataset.radiologists);

// Load licenses when page loads
document.addEventListener('DOMContentLoaded', function() {
  loadLicenses();
});

function debounceSearch() {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    currentSearchTerm = document.getElementById('licenseSearch').value;
    currentPage = 1;
    loadLicenses();
  }, 300);
}

function loadLicenses() {
  const searchTerm = document.getElementById('licenseSearch').value;
  const doctorId = document.getElementById('doctorFilter').value;
  
  fetch(`/radmapping/licenses/search?page=${currentPage}&search=${encodeURIComponent(searchTerm)}&doctor=${encodeURIComponent(doctorId)}&status=${currentStatusFilter}`)
    .then(response => response.json())
    .then(data => {
      updateTable(data.certifications);
      updatePagination(data.total_count);
    });
}

function updateTable(certifications) {
  const tbody = document.getElementById('licensesTableBody');
  tbody.innerHTML = '';
  
  certifications.forEach(cert => {
    const isExpired = cert.status === 'Expired' || cert.status === 'Revoked' || 
                     (cert.expiration_date && cert.expiration_date < new Date().toISOString().split('T')[0]);
    
    const row = document.createElement('tr');
    row.id = `license-row-${cert.id}`;
    row.className = `hover:bg-opacity-80 ${isExpired ? 'bg-red-50' : 'bg-green-50'}`;
    row.dataset.doctorId = cert.radiologist_id;
    
    // Create doctor select options
    const doctorOptions = radiologists.map(rad => 
      `<option value="${rad.id}" ${rad.id === cert.radiologist_id ? 'selected' : ''}>${rad.name}</option>`
    ).join('');
    
    row.innerHTML = `
      <td class="px-6 py-4 border">
        <span class="view-mode">
          <a href="/radmapping/doctors/${cert.radiologist_id}" target="_blank" class="text-blue-700 hover:underline">
            ${cert.radiologists.name}
          </a>
        </span>
        <select class="edit-mode hidden w-full px-2 py-1 border rounded">
          ${doctorOptions}
        </select>
      </td>
      <td class="px-6 py-4 border">
        <span class="view-mode">${cert.state}</span>
        <input type="text" class="edit-mode hidden w-full px-2 py-1 border rounded" value="${cert.state}">
      </td>
      <td class="px-6 py-4 border">
        <span class="view-mode">${cert.specialty || ''}</span>
        <input type="text" class="edit-mode hidden w-full px-2 py-1 border rounded" value="${cert.specialty || ''}">
      </td>
      <td class="px-6 py-4 border">
        <span class="view-mode">${cert.status}</span>
        <select class="edit-mode hidden w-full px-2 py-1 border rounded">
          <option value="Active" ${cert.status === 'Active' ? 'selected' : ''}>Active</option>
          <option value="Pending" ${cert.status === 'Pending' ? 'selected' : ''}>Pending</option>
          <option value="Expired" ${cert.status === 'Expired' ? 'selected' : ''}>Expired</option>
          <option value="Revoked" ${cert.status === 'Revoked' ? 'selected' : ''}>Revoked</option>
        </select>
      </td>
      <td class="px-6 py-4 border">
        <span class="view-mode">${cert.tags || ''}</span>
        <input type="text" class="edit-mode hidden w-full px-2 py-1 border rounded" value="${cert.tags || ''}">
      </td>
      <td class="px-6 py-4 border">
        <span class="view-mode">${cert.expiration_date}</span>
        <input type="date" class="edit-mode hidden w-full px-2 py-1 border rounded" value="${cert.expiration_date}">
      </td>
      {% if session.user.role == 'admin' %}
      <td class="px-6 py-4 border">
        <div class="view-mode">
          <button onclick="toggleEditMode('${cert.id}')" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
          <form method="POST" action="/radmapping/doctors/${cert.radiologist_id}/licenses/${cert.id}/delete" class="inline">
            <button type="submit" class="text-red-600 hover:text-red-800">Delete</button>
          </form>
        </div>
        <div class="edit-mode hidden">
          <button onclick="saveLicense('${cert.id}')" class="text-green-600 hover:text-green-900 mr-3">Save</button>
          <button onclick="cancelEdit('${cert.id}')" class="text-gray-600 hover:text-gray-900">Cancel</button>
        </div>
      </td>
      {% endif %}
    `;
    
    tbody.appendChild(row);
  });
}

function updatePagination(total) {
  totalCount = total;
  const totalPages = Math.ceil(totalCount / itemsPerPage);
  const startItem = ((currentPage - 1) * itemsPerPage) + 1;
  const endItem = Math.min(currentPage * itemsPerPage, totalCount);

  document.getElementById('startItem').textContent = startItem;
  document.getElementById('endItem').textContent = endItem;
  document.getElementById('totalItems').textContent = totalCount;

  document.getElementById('prevPage').disabled = currentPage === 1;
  document.getElementById('nextPage').disabled = currentPage === totalPages;
}

function changePage(direction) {
  const totalPages = Math.ceil(totalCount / itemsPerPage);
  
  if (direction === 'next' && currentPage < totalPages) {
    currentPage++;
  } else if (direction === 'prev' && currentPage > 1) {
    currentPage--;
  }
  
  loadLicenses();
}

function filterByStatus(status) {
  currentStatusFilter = status;
  
  // Update button styles
  document.querySelectorAll('[data-status]').forEach(button => {
    button.classList.remove('active-filter', 'bg-blue-600', 'text-white');
    if (button.dataset.status === status) {
      button.classList.add('active-filter', 'bg-blue-600', 'text-white');
    }
  });
  
  currentPage = 1;
  loadLicenses();
}

function toggleEditMode(licenseId) {
  const row = document.getElementById(`license-row-${licenseId}`);
  row.querySelectorAll('.view-mode').forEach(el => el.classList.add('hidden'));
  row.querySelectorAll('.edit-mode').forEach(el => el.classList.remove('hidden'));
}

function cancelEdit(licenseId) {
  const row = document.getElementById(`license-row-${licenseId}`);
  row.querySelectorAll('.edit-mode').forEach(el => el.classList.add('hidden'));
  row.querySelectorAll('.view-mode').forEach(el => el.classList.remove('hidden'));
}

function saveLicense(licenseId) {
  const row = document.getElementById(`license-row-${licenseId}`);
  const formData = new FormData();
  
  formData.append('radiologist_id', row.querySelector('select').value);
  formData.append('state', row.querySelector('input[type="text"]').value);
  formData.append('specialty', row.querySelectorAll('input[type="text"]')[1].value);
  formData.append('status', row.querySelectorAll('select')[1].value);
  formData.append('tags', row.querySelectorAll('input[type="text"]')[2].value);
  formData.append('expiration_date', row.querySelector('input[type="date"]').value);

  fetch(`/radmapping/licenses/${licenseId}/update`, {
    method: 'POST',
    body: formData
  }).then(() => {
    loadLicenses();
  });
}
</script>
{% endblock %} 