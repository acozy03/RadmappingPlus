{% extends "layout.html" %}
{% block title %}Licenses{% endblock %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
{% endblock %}

{% block content %}
<div id="radiologistsData" data-radiologists='{{ radiologists|tojson|safe }}' class="hidden"></div>

<div class="licenses-page">
<div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-8">
  <div class="mb-4 lg:mb-0">
    <h2 class="text-3xl font-bold text-gray-900 mb-2">License Management</h2>
    <p class="text-gray-600">Track and manage radiologist certifications and licenses</p>
  </div>
  <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
  <div class="flex items-center gap-3">
    
  </div>

  {% if session.user.role == 'admin' %}
<div x-data="{ open: false }" class="relative" id ="addLicenseModal">
  <button @click="open = true"
          class="inline-flex items-center px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-semibold shadow-sm hover:bg-blue-700 transition">
    Add License
  </button>

  <div x-show="open"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
        style="display: none;"
        x-transition:enter="transition ease-out duration-150"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-100"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0">

    <div @click.away="open = false"
          class="bg-white rounded-xl shadow-xl max-w-lg w-full p-6 relative z-50"
          x-show="open"
          style="display: none;">

      <h3 class="text-lg font-semibold text-gray-800 mb-4">
        Add New License
      </h3>

      <form method="POST" action="{{ url_for('licenses.licenses_page') }}" class="space-y-4">

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Radiologist</label>
          <select name="doctor" required class="w-full border rounded px-3 py-2 text-sm">
            {% for doc in radiologists %}
              <option value="{{ doc.id }}">{{ doc.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">State</label>
          <input type="text" name="state" required class="w-full border rounded px-3 py-2 text-sm">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Specialty</label>
          <input type="text" name="specialty"  class="w-full border rounded px-3 py-2 text-sm">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Expiration Date</label>
          <input type="date" name="exp" required class="w-full border rounded px-3 py-2 text-sm">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
          <select name="status" class="w-full border rounded px-3 py-2 text-sm">
            <option value="Active">Active</option>
            <option value="Expired">Expired</option>
            <option value="Pending">Pending</option>
            <option value="Revoked">Revoked</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Tags (comma separated)</label>
          <input type="text" name="tags" class="w-full border rounded px-3 py-2 text-sm">
        </div>

        <div class="flex justify-end gap-3 pt-4">
          <button type="button"
                  @click="open = false"
                  class="px-4 py-2 text-sm text-gray-700 bg-gray-100 hover:bg-gray-200 rounded">
            Cancel
          </button>
          <button type="submit"
                  class="px-4 py-2 text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700 rounded">
            Add License
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}
</div>

</div>

<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
  <div class="flex flex-col lg:flex-row gap-4">
    <div class="flex-1 relative">
      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
        <i class="fas fa-search text-gray-400"></i>
      </div>
      <input
        type="text"
        id="licenseSearch"
        placeholder="Search by state, doctor, specialty, or tags..."
        class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
        onkeyup="debounceSearch()" />
    </div>
    
    <div class="w-full lg:w-64 relative">
      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
        <i class="fas fa-map-marker-alt text-gray-400"></i>
      </div>
      <select
        id="stateFilter"
        class="w-full pl-10 pr-8 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors appearance-none bg-white"
        onchange="applyFiltersAndSort()">
        <option value="">All States</option>
        {% for state in us_states %}
        <option value="{{ state }}">{{ state }}</option>
        {% endfor %}
      </select>
      <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
        <i class="fas fa-chevron-down text-gray-400"></i>
      </div>
    </div>
    
    <div class="flex gap-2">
      <button onclick="filterByStatus('all')" 
              class="px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 bg-blue-600 text-white shadow-sm hover:bg-blue-700 active-filter" 
              data-status="all">
        <i class="fas fa-list mr-2"></i>All
      </button>
      <button onclick="filterByStatus('true')" 
              class="px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 bg-gray-100 text-gray-700 hover:bg-green-100 hover:text-green-700" 
              data-status="true">
        <i class="fas fa-check-circle mr-2"></i>Active Doctors
      </button>
      <button onclick="filterByStatus('false')" 
              class="px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 bg-gray-100 text-gray-700 hover:bg-red-100 hover:text-red-700" 
              data-status="false">
        <i class="fas fa-exclamation-triangle mr-2"></i>Inactive Doctors
      </button>
    </div>
  </div>
</div>

<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
  <div class="overflow-x-auto">
    <table id="licensesTable" class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors" data-sort="doctor">
            <div class="flex items-center">
                <i class="fas fa-user-md mr-2"></i>Doctor
                <span class="ml-2 text-gray-400 sort-indicator">↕</span>
            </div>
          </th>
          <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors" data-sort="state">
            <div class="flex items-center">
                <i class="fas fa-map-marker-alt mr-2"></i>State
                <span class="ml-2 text-gray-400 sort-indicator">↕</span>
            </div>
          </th>
          <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors" data-sort="specialty">
            <div class="flex items-center">
                <i class="fas fa-stethoscope mr-2"></i>Specialty
                <span class="ml-2 text-gray-400 sort-indicator">↕</span>
            </div>
          </th>
          <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors" data-sort="status">
            <div class="flex items-center">
                <i class="fas fa-info-circle mr-2"></i>Status
                <span class="ml-2 text-gray-400 sort-indicator">↕</span>
            </div>
          </th>
          <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors" data-sort="tags">
            <div class="flex items-center">
                <i class="fas fa-tags mr-2"></i>Tags
                <span class="ml-2 text-gray-400 sort-indicator">↕</span>
            </div>
          </th>
          <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors" data-sort="expiration">
            <div class="flex items-center">
                <i class="fas fa-calendar-alt mr-2"></i>Expiration
                <span class="ml-2 text-gray-400 sort-indicator">↕</span>
            </div>
          </th>
          {% if session.user.role == 'admin' %}
          <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            <i class="fas fa-cog mr-2"></i>Actions
          </th>
          {% endif %}
        </tr>
      </thead>
      <tbody id="licensesTableBody" class="bg-white divide-y divide-gray-200">
        {# Initial rows will be loaded by JavaScript #}
      </tbody>
    </table>

    <div id="no-results" class="hidden p-8 text-center text-gray-500">
      <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 0112 15c-2.34 0-4.47.881-6.08 2.33l-.926-.926A9.953 9.953 0 0112 13c2.74 0 5.23 1.1 7.08 2.88l-.926.926A7.963 7.963 0 0112 15z"></path>
      </svg>
      <p class="text-lg font-medium">No matching licenses found</p>
      <p class="text-sm text-gray-400 mt-1">Try adjusting your search filters</p>
    </div>
      
    <div id="loading-more" class="hidden p-4 text-center text-gray-500">
      <div class="inline-flex items-center">
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Loading more entries...
      </div>
    </div>
  </div>
  
  <div class="bg-gray-50 px-4 py-3 border-t border-gray-200">
      <div class="flex justify-between items-center text-sm text-gray-600">
        <span id="showing-count">Showing 0 entries</span>
        <span id="total-count">Total: 0 entries</span>
      </div>
    </div>
</div>

<div id="delete-confirm-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <div class="header-icon-container">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <h3 class="text-lg font-semibold text-gray-800">Delete License</h3>
      <span class="close-delete-modal-btn">&times;</span>
    </div>
    <div class="modal-body">
      <div class="body-icon-container">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <div class="body-text">
        <p class="text-gray-900 font-medium">Are you sure you want to delete this license?</p>
        <p class="text-gray-600 text-sm mt-1">This action cannot be undone.</p>
      </div>
    </div>
    <div id="item-to-delete-info" class="info-box">
      </div>
    <div class="modal-actions">
      <button id="cancel-delete-btn" class="btn btn-cancel">Cancel</button>
      <button id="confirm-delete-btn" class="btn btn-delete">
        <i class="fas fa-trash-alt mr-2"></i>Delete License
      </button>
    </div>
  </div>
</div>

</div>


<style>
html[data-theme="dark"] body {
  background-color: #0f172a;
  color: #e2e8f0;
}

html[data-theme="dark"] .licenses-page {
  color: #e2e8f0;
}

html[data-theme="dark"] .licenses-page h2,
html[data-theme="dark"] .licenses-page .text-gray-900,
html[data-theme="dark"] .licenses-page .text-gray-800 {
  color: #f8fafc !important;
}

html[data-theme="dark"] .licenses-page .text-gray-700,
html[data-theme="dark"] .licenses-page .text-gray-600,
html[data-theme="dark"] .licenses-page .text-gray-500 {
  color: #cbd5f5 !important;
}

html[data-theme="dark"] .licenses-page .text-gray-400,
html[data-theme="dark"] .licenses-page .text-gray-300 {
  color: #9ca3af !important;
}

html[data-theme="dark"] .licenses-page .bg-white,
html[data-theme="dark"] .licenses-page .bg-gray-50,
html[data-theme="dark"] .licenses-page .bg-gray-100,
html[data-theme="dark"] .licenses-page .bg-gray-200 {
  background-color: #1e293b !important;
  color: inherit;
}

html[data-theme="dark"] .licenses-page .bg-black.bg-opacity-50 {
  background-color: rgba(2, 6, 23, 0.7) !important;
}

html[data-theme="dark"] .licenses-page .border-gray-200,
html[data-theme="dark"] .licenses-page .border-gray-300,
html[data-theme="dark"] .licenses-page .border-gray-400 {
  border-color: #334155 !important;
}

html[data-theme="dark"] .licenses-page thead.bg-gray-50 {
  background-color: #243045 !important;
}

html[data-theme="dark"] .licenses-page thead th {
  transition: background-color 0.2s ease, color 0.2s ease;
}

html[data-theme="dark"] .licenses-page thead th:hover {
  background-color: #2d3a52 !important;
  color: #e2e8f0 !important;
}

html[data-theme="dark"] .licenses-page tbody tr {
  border-bottom-color: #334155 !important;
}

html[data-theme="dark"] .licenses-page .license-row.hover\:bg-gray-50:hover,
html[data-theme="dark"] .licenses-page tbody tr:hover {
  background-color: #28344d !important;
  box-shadow: 0 4px 12px rgba(15, 23, 42, 0.4);
}

html[data-theme="dark"] .licenses-page .bg-green-50 {
  background-color: #243045 !important;
}

html[data-theme="dark"] .licenses-page .bg-red-50 {
  background-color: #243045 !important;
}

html[data-theme="dark"] .licenses-page .bg-blue-100 {
  background-color: rgba(37, 99, 235, 0.18) !important;
}

html[data-theme="dark"] .licenses-page .bg-yellow-100 {
  background-color: rgba(234, 179, 8, 0.18) !important;
}

html[data-theme="dark"] .licenses-page .bg-purple-100 {
  background-color: rgba(168, 85, 247, 0.2) !important;
}

html[data-theme="dark"] .licenses-page .bg-gray-100.text-gray-700,
html[data-theme="dark"] .licenses-page .bg-gray-100.text-gray-600,
html[data-theme="dark"] .licenses-page .bg-gray-100.text-gray-500 {
  color: #e2e8f0 !important;
}

html[data-theme="dark"] .licenses-page .status-badge {
  background-color: rgba(34, 197, 94, 0.18);
  color: #bbf7d0;
}

html[data-theme="dark"] .licenses-page .status-badge.status-expired {
  background-color: rgba(248, 113, 113, 0.2);
  color: #fecaca;
}

html[data-theme="dark"] .licenses-page .status-badge.status-pending {
  background-color: rgba(251, 191, 36, 0.22);
  color: #fde68a;
}

html[data-theme="dark"] .licenses-page .state-badge {
  background-color: rgba(59, 130, 246, 0.22);
  color: #bfdbfe;
}

html[data-theme="dark"] .licenses-page .shadow-sm {
  box-shadow: 0 10px 25px rgba(15, 23, 42, 0.35) !important;
}

html[data-theme="dark"] .licenses-page input,
html[data-theme="dark"] .licenses-page select,
html[data-theme="dark"] .licenses-page textarea {
  background-color: #0f172a !important;
  color: #e2e8f0 !important;
  border-color: #334155 !important;
}

html[data-theme="dark"] .licenses-page select option {
  background-color: #0f172a;
  color: #e2e8f0;
}

html[data-theme="dark"] .licenses-page input::placeholder,
html[data-theme="dark"] .licenses-page textarea::placeholder {
  color: #94a3b8 !important;
}

html[data-theme="dark"] .licenses-page .active-filter {
  box-shadow: 0 6px 18px rgba(59, 130, 246, 0.4) !important;
}

html[data-theme="dark"] .licenses-page .modal-content {
  background-color: #1e293b;
  color: #e2e8f0;
  box-shadow: 0 18px 30px rgba(2, 6, 23, 0.6);
  border: 1px solid #334155;
}

html[data-theme="dark"] .licenses-page .header-icon-container {
  background-color: rgba(248, 113, 113, 0.22);
  color: #fecaca;
}

html[data-theme="dark"] .licenses-page .modal-header {
  border-bottom-color: #334155;
}

html[data-theme="dark"] .licenses-page .btn-cancel {
  background-color: #334155;
  color: #e2e8f0;
}

html[data-theme="dark"] .licenses-page .btn-delete {
  background-color: rgba(248, 113, 113, 0.22);
  color: #fecaca;
}

html[data-theme="dark"] .licenses-page .btn-delete:hover {
  background-color: rgba(248, 113, 113, 0.35) !important;
}

html[data-theme="dark"] .licenses-page .info-box {
  background-color: rgba(248, 113, 113, 0.18);
  border-color: rgba(248, 113, 113, 0.5);
  color: #fecaca;
}

html[data-theme="dark"] .licenses-page #no-results {
  color: #cbd5f5;
}

html[data-theme="dark"] .licenses-page #no-results svg {
  color: #64748b;
}

html[data-theme="dark"] .licenses-page #loading-more {
  color: #94a3b8;
}

html[data-theme="dark"] .licenses-page .modal-overlay {
  background-color: rgba(2, 6, 23, 0.75);
}

html[data-theme="dark"] .licenses-page .license-row .view-mode a {
  color: #60a5fa;
}

html[data-theme="dark"] .licenses-page .license-row .view-mode a:hover {
  color: #93c5fd;
}

.active-filter {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}
.status-badge {
  transition: all 0.2s ease-in-out;
  background-color: #dcfce7;
  color: #166534;
}
.status-badge.status-expired {
  background-color: #fee2e2;
  color: #b91c1c;
}
.status-badge.status-pending {
  background-color: #fef3c7;
  color: #92400e;
}
.status-badge:hover { transform: scale(1.05); }
.state-badge {
  transition: color 0.2s ease-in-out, background-color 0.2s ease-in-out;
  background-color: #dbeafe;
  color: #1d4ed8;
}
tbody tr:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}
.overflow-x-auto::-webkit-scrollbar { height: 8px; }
.overflow-x-auto::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
.overflow-x-auto::-webkit-scrollbar-thumb { background: linear-gradient(to right, #3b82f6, #8b5cf6); border-radius: 4px; }
.overflow-x-auto::-webkit-scrollbar-thumb:hover { background: linear-gradient(to right, #2563eb, #7c3aed); }
.sort-indicator.active { color: #3b82f6; }
.license-row.hidden { display: none !important; }

/* CSS for Delete Modal */
.modal-overlay {
  display: none;
  position: fixed;
  z-index: 1000;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.6);
  justify-content: center;
  align-items: center;
}
.modal-content {
  background-color: #ffffff;
  padding: 24px;
  border-radius: 8px;
  width: 90%;
  max-width: 450px;
  font-family: sans-serif;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #eeeeee;
  padding-bottom: 12px;
  margin-bottom: 12px;
  gap: 12px; /* Adds space between icon and title */
}
.close-delete-modal-btn { font-size: 1.5rem; cursor: pointer; color: #888; }
.modal-actions { text-align: right; margin-top: 20px; }
.btn { padding: 10px 18px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; text-decoration: none; display: inline-block; }
.btn-cancel { background-color: #f1f1f1; color: #333; }
.btn-delete { background-color: #ef4444; color: white; margin-left: 10px; display: inline-flex; align-items: center; }

/* New CSS for enhanced modal design */
.header-icon-container {
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 40px;
  height: 40px;
  background-color: #fee2e2; /* Light red background */
  color: #ef4444; /* Red icon color */
  border-radius: 8px;
  font-size: 20px;
}
.modal-header h3 {
  margin-right: auto; /* Pushes the close button to the far right */
}
.modal-body {
  display: flex;
  align-items: flex-start;
  gap: 16px;
  margin-top: 16px;
}
.body-icon-container {
  font-size: 24px;
  color: #ef4444;
  margin-top: 4px;
}
.info-box {
  background-color: #fee2e2;
  border-left: 4px solid #ef4444;
  color: #b91c1c;
  padding: 12px;
  margin-top: 20px;
  border-radius: 4px;
  font-weight: 500;
}
</style>

<script>
let currentStatusFilter = 'all';
let currentSearchTerm = '';
const entriesPerPage = 25;
let visibleEntries = entriesPerPage;
let allLicensesData = []; 
let filteredLicenses = []; 
let currentSort = { column: 'doctor', direction: 'asc' }; 
let searchTimeout; 
const radiologists = JSON.parse(document.getElementById('radiologistsData').dataset.radiologists);

document.addEventListener('DOMContentLoaded', function() {
  fetchAllLicensesForClientSide(); 

  document.querySelectorAll('th[data-sort]').forEach(header => {
    header.addEventListener('click', function() {
      const column = this.dataset.sort;
      if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.column = column;
        currentSort.direction = 'asc';
      }
      
      updateSortIndicators();
      visibleEntries = entriesPerPage; 
      applyFiltersAndSort(); 
    });
  });

    let isLoading = false;
  window.addEventListener('scroll', function() {
    if (isLoading) return;
    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
      if (visibleEntries < filteredLicenses.length) {
        isLoading = true;
        document.getElementById('loading-more').classList.remove('hidden');
        setTimeout(() => {
          visibleEntries += entriesPerPage;
          updateVisibleRows();
          document.getElementById('loading-more').classList.add('hidden');
          isLoading = false;
        }, 300);
      }
    }
  });
});

// ... (All your existing functions: updateSortIndicators, debounceSearch, etc. remain here) ...
function updateSortIndicators() {
    document.querySelectorAll('.sort-indicator').forEach(i => {
        i.textContent = '↕';
        i.classList.remove('active');
    });

    if (currentSort.column) {
        const activeHeader = document.querySelector(`th[data-sort="${currentSort.column}"]`);
        if (activeHeader) {
            const indicator = activeHeader.querySelector('.sort-indicator');
            if (indicator) {
                indicator.textContent = currentSort.direction === 'asc' ? '↑' : '↓';
                indicator.classList.add('active');
            }
        }
    }
}


function debounceSearch() {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    currentSearchTerm = document.getElementById('licenseSearch').value;
    visibleEntries = entriesPerPage; 
    applyFiltersAndSort();
  }, 300);
}

function fetchAllLicensesForClientSide() {
    fetch(`/radmapping/licenses/search?no_pagination=true`) 
        .then(response => response.json())
        .then(data => {
            allLicensesData = data.certifications;
            applyFiltersAndSort(); 
        })
        .catch(error => console.error('Error fetching all licenses:', error));
}


function applyFiltersAndSort() {
  let tempFilteredData = [...allLicensesData];
  const searchTerm = document.getElementById('licenseSearch').value.toLowerCase();
  if (searchTerm) {
    tempFilteredData = tempFilteredData.filter(cert => 
      (cert.state && cert.state.toLowerCase().includes(searchTerm)) ||
      (cert.radiologists.name && cert.radiologists.name.toLowerCase().includes(searchTerm)) ||
      (cert.specialty && cert.specialty.toLowerCase().includes(searchTerm)) ||
      (cert.tags && cert.tags.toLowerCase().includes(searchTerm))
    );
  }

  const stateFilter = document.getElementById('stateFilter').value;
  if (stateFilter) {
    tempFilteredData = tempFilteredData.filter(cert => 
      cert.state === stateFilter
    );
  }
  
  if (currentStatusFilter !== 'all') {
    tempFilteredData = tempFilteredData.filter(cert => 
      String(cert.radiologists.active_status) === currentStatusFilter
    );
  }

  tempFilteredData.sort((a, b) => {
    let valueA, valueB;

    switch (currentSort.column) {
      case 'doctor':
        valueA = a.radiologists.name.toLowerCase();
        valueB = b.radiologists.name.toLowerCase();
        break;
      case 'state':
        valueA = a.state.toLowerCase();
        valueB = b.state.toLowerCase();
        break;
      case 'specialty':
        valueA = (a.specialty || '').toLowerCase();
        valueB = (b.specialty || '').toLowerCase();
        break;
      case 'status':
        valueA = a.status.toLowerCase();
        valueB = b.status.toLowerCase();
        break;
      case 'tags':
        valueA = (a.tags || '').toLowerCase();
        valueB = (b.tags || '').toLowerCase();
        break;
      case 'expiration':
        valueA = new Date(a.expiration_date);
        valueB = new Date(b.expiration_date);
        break;
      default:
        return 0; 
    }

    if (valueA < valueB) {
      return currentSort.direction === 'asc' ? -1 : 1;
    }
    if (valueA > valueB) {
      return currentSort.direction === 'asc' ? 1 : -1;
    }
    return 0;
  });

  filteredLicenses = tempFilteredData; 
  updateTable(); 
  updateCounts(); 
}

function updateTable() {
  const tbody = document.getElementById('licensesTableBody');
  tbody.innerHTML = ''; 

  const licensesToDisplay = filteredLicenses.slice(0, visibleEntries);
  
  if (licensesToDisplay.length === 0) {
      document.getElementById('no-results').classList.remove('hidden');
  } else {
      document.getElementById('no-results').classList.add('hidden');
  }

  licensesToDisplay.forEach(cert => {
    const isExpired = cert.status === 'Expired' || cert.status === 'Revoked' || 
                      (cert.expiration_date && cert.expiration_date < new Date().toISOString().split('T')[0]);
    
    const row = document.createElement('tr');
    row.id = `license-row-${cert.id}`;
    const isActiveDoctor = String(cert.radiologists.active_status) === 'true';
    row.className = `license-row hover:bg-gray-50 transition-colors duration-150 ${isActiveDoctor ? 'bg-green-50 ' : 'bg-red-50 '}`;
    row.dataset.doctorId = cert.radiologist_id;
    row.dataset.doctorName = cert.radiologists.name;
    row.dataset.state = cert.state;
    row.dataset.specialty = cert.specialty;
    row.dataset.status = cert.status;
    row.dataset.tags = cert.tags;
    row.dataset.expiration = cert.expiration_date;

    const doctorOptions = radiologists.map(rad => 
      `<option value="${rad.id}" ${rad.id === cert.radiologist_id ? 'selected' : ''}>${rad.name}</option>`
    ).join('');
    
    let statusBadge = '';
    if (cert.status === 'Active') {
      statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium status-badge status-active">
        <i class="fas fa-check-circle mr-1"></i>${cert.status}
      </span>`;
    } else if (cert.status === 'Expired' || cert.status === 'Revoked') {
      statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium status-badge status-expired">
        <i class="fas fa-times-circle mr-1"></i>${cert.status}
      </span>`;
    } else {
      statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium status-badge status-pending">
        <i class="fas fa-clock mr-1"></i>${cert.status}
      </span>`;
    }
    
    row.innerHTML = `
      <td class="px-6 py-4 whitespace-nowrap">
        <span class="view-mode">
          <div class="flex items-center">
            <div class="flex-shrink-0 h-10 w-10">
              <div class="h-10 w-10 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center">
                <span class="text-white font-medium text-sm">${cert.radiologists.name.substring(0, 2).toUpperCase()}</span>
              </div>
            </div>
            <div class="ml-4">
              <a href="/radmapping/doctors/${cert.radiologist_id}" target="_blank" class="text-blue-600 hover:text-blue-800 font-medium transition-colors">
                ${cert.radiologists.name}
              </a>
            </div>
          </div>
        </span>
        <select class="edit-mode hidden w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" name="doctor">
          ${doctorOptions}
        </select>
      </td>
      <td class="px-6 py-4 whitespace-nowrap">
        <span class="view-mode">
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium state-badge">
            <i class="fas fa-map-marker-alt mr-1"></i>${cert.state}
          </span>
        </span>
        <input type="text" class="edit-mode hidden w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" value="${cert.state}" name="state">
      </td>
      <td class="px-6 py-4 whitespace-nowrap">
        <span class="view-mode text-sm text-gray-900">${cert.specialty || ''}</span>
        <input type="text" class="edit-mode hidden w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" value="${cert.specialty || ''}" name="specialty">
      </td>
      <td class="px-6 py-4 whitespace-nowrap">
        <span class="view-mode">${statusBadge}</span>
        <select class="edit-mode hidden w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" name="status">
          <option value="Active" ${cert.status === 'Active' ? 'selected' : ''}>Active</option>
          <option value="Pending" ${cert.status === 'Pending' ? 'selected' : ''}>Pending</option>
          <option value="Expired" ${cert.status === 'Expired' ? 'selected' : ''}>Expired</option>
          <option value="Revoked" ${cert.status === 'Revoked' ? 'selected' : ''}>Revoked</option>
        </select>
      </td>
      <td class="px-6 py-4 whitespace-nowrap">
        <span class="view-mode">
          ${cert.tags ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
            <i class="fas fa-tag mr-1"></i>${cert.tags}
          </span>` : '<span class="text-gray-400 text-sm">No tags</span>'}
        </span>
        <input type="text" class="edit-mode hidden w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" value="${cert.tags || ''}" name="tags">
      </td>
      <td class="px-6 py-4 whitespace-nowrap">
        <span class="view-mode">
          <div class="flex items-center">
            <i class="fas fa-calendar-alt text-gray-400 mr-2"></i>
            <span class="text-sm text-gray-900">${cert.expiration_date}</span>
          </div>
        </span>
        <input type="date" class="edit-mode hidden w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" value="${cert.expiration_date}" name="exp">
      </td>
      {% if session.user.role == 'admin' %}
      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
        <div class="view-mode flex items-center gap-2">
          <button onclick="toggleEditMode('${cert.id}')" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 transition-colors">
            <i class="fas fa-edit mr-1"></i>Edit
          </button>
          
          <form method="POST" action="/radmapping/doctors/${cert.radiologist_id}/licenses/${cert.id}/delete" class="inline requires-confirmation" data-item-name="License for ${cert.radiologists.name} in ${cert.state}">
            <button type="submit" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-red-700 bg-red-100 hover:bg-red-200 transition-colors">
                <i class="fas fa-trash mr-1"></i>Delete
            </button>
          </form>

        </div>
        <div class="edit-mode hidden flex items-center gap-2">
          <button onclick="saveLicense('${cert.id}')" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-green-700 bg-green-100 hover:bg-green-200 transition-colors">
            <i class="fas fa-save mr-1"></i>
          </button>
          <button onclick="cancelEdit('${cert.id}')" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-gray-700 bg-gray-100 hover:bg-gray-200 transition-colors">
            <i class="fas fa-times mr-1"></i>
          </button>
        </div>
      </td>
      {% endif %}
    `;
    
    tbody.appendChild(row);
  });
}

function updateVisibleRows() {
    updateTable();
    updateCounts();
}


function updateCounts() {
    document.getElementById('showing-count').textContent = `Showing ${Math.min(visibleEntries, filteredLicenses.length)} entries`;
    document.getElementById('total-count').textContent = `Total: ${filteredLicenses.length} entries`;
}

function filterByStatus(status) {
  currentStatusFilter = status;
  document.querySelectorAll('[data-status]').forEach(button => {
    button.classList.remove('active-filter', 'bg-blue-600', 'text-white');
    button.classList.add('bg-gray-100', 'text-gray-700');
    if (button.dataset.status === status) {
      button.classList.remove('bg-gray-100', 'text-gray-700');
      button.classList.add('active-filter', 'bg-blue-600', 'text-white');
    }
  });
  
  visibleEntries = entriesPerPage; 
  applyFiltersAndSort();
}

function toggleEditMode(licenseId) {
  const row = document.getElementById(`license-row-${licenseId}`);
  row.querySelectorAll('.view-mode').forEach(el => el.classList.add('hidden'));
  row.querySelectorAll('.edit-mode').forEach(el => el.classList.remove('hidden'));
}

function cancelEdit(licenseId) {
  const row = document.getElementById(`license-row-${licenseId}`);
  row.querySelectorAll('.edit-mode').forEach(el => el.classList.add('hidden'));
  row.querySelectorAll('.view-mode').forEach(el => el.classList.remove('hidden'));
}

function saveLicense(licenseId) {
  const row = document.getElementById(`license-row-${licenseId}`);
  const formData = new FormData();

  const doctor = row.querySelector('select[name="doctor"]');
  const state = row.querySelector('input[name="state"]');
  const specialty = row.querySelector('input[name="specialty"]');
  const status = row.querySelector('select[name="status"]');
  const tags = row.querySelector('input[name="tags"]');
  const exp = row.querySelector('input[name="exp"]');

  formData.append('radiologist_id', doctor?.value || '');
  formData.append('state', state?.value || '');
  formData.append('specialty', specialty?.value || '');
  formData.append('status', status?.value || '');
  formData.append('tags', tags?.value || '');
  formData.append('expiration_date', exp?.value || '');

  fetch(`/radmapping/licenses/${licenseId}/update`, {
    method: 'POST',
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    console.log("Update success:", data);
    fetchAllLicensesForClientSide();
  })
  .catch(err => {
    console.error("Save error:", err);
  });
}

// Get modal elements
const deleteModal = document.getElementById('delete-confirm-modal');
const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
const closeDeleteModalBtn = document.querySelector('.close-delete-modal-btn');

// This variable will hold the form that needs to be submitted
let formToSubmit = null;

// Function to open the modal
const openDeleteModal = () => deleteModal.style.display = 'flex';

// Function to close the modal
const closeModal = () => deleteModal.style.display = 'none';

// Use event delegation to catch submit events on dynamically created forms
document.addEventListener('submit', function(event) {
  // Check if the submitted element is a form with our class
  if (event.target.matches('form.requires-confirmation')) {
    // Prevent the form from submitting immediately
    event.preventDefault();
    
    // Store the form that was just submitted
    formToSubmit = event.target;
    
    // Get the item name from the data attribute
    const itemName = formToSubmit.getAttribute('data-item-name');
    
    // Find the info box and update its text
    const infoBox = document.getElementById('item-to-delete-info');
    infoBox.textContent = itemName;

    // Open the modal
    openDeleteModal();
  }
});

// When the user clicks the final "Delete" button in the modal...
confirmDeleteBtn.addEventListener('click', () => {
  // ...check if we have a form stored and then submit it
  if (formToSubmit) {
    formToSubmit.submit();
  }
});

// Add event listeners to close the modal
cancelDeleteBtn.addEventListener('click', closeModal);
closeDeleteModalBtn.addEventListener('click', closeModal);

// Also close if the user clicks on the dark background
window.addEventListener('click', (event) => {
  if (event.target === deleteModal) {
    closeModal();
  }
});

</script>
{% endblock %}