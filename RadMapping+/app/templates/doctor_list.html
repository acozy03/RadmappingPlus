{% extends "layout.html" %}

{% block title %}Doctor Directory{% endblock %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6 border-b pb-2">
  <h2 class="text-2xl font-semibold">Doctor Directory</h2>
  {% if session.user.role == 'admin' %}
  <button onclick="openAddDoctorModal()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-medium">
    Add Doctor
  </button>
  {% endif %}
</div>

<!-- Search and Status Filter Row -->
<div class="mb-4 flex flex-col md:flex-row gap-4">
  <div class="flex-1">
    <input type="text"
           id="searchBox"
           placeholder="Search by name..."
           class="w-full p-2 border rounded"
           onkeyup="debounceSearch()" />
  </div>
  <!-- Status Filter Buttons -->
  <div class="flex gap-2">
    <button onclick="filterByStatus('all')"
            class="px-4 py-2 rounded text-sm font-medium bg-gray-100 hover:bg-gray-200"
            data-status="all">
      All
    </button>
    <button onclick="filterByStatus('active')"
            class="px-4 py-2 rounded text-sm font-medium bg-gray-100 hover:bg-gray-200 active-filter"
            data-status="active">
      Active
    </button>
    <button onclick="filterByStatus('inactive')"
            class="px-4 py-2 rounded text-sm font-medium bg-gray-100 hover:bg-gray-200"
            data-status="inactive">
      Inactive
    </button>
  </div>
</div>

<!-- Doctor List -->
<ul id="doctorList" class="space-y-4">
  {% for doc in doctors %}
  <li class="relative flex items-center justify-between p-4 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer doctor-item"
      onclick="window.location.href='/dashboard/doctors/{{ doc.id }}'"
      onmouseenter="showPopup(this)"
      onmouseleave="hidePopup(this)">
      <div class="flex items-center gap-3">
        <div class="w-2 h-2 rounded-full {% if doc.active_status %}bg-green-500{% else %}bg-red-500{% endif %}"></div>
        <div>
          <p class="text-lg font-medium name">{{ doc.name }}</p>
          <p class="text-sm text-gray-500 email">{{ doc.email }}</p>
        </div>
      </div>
      <span class="text-blue-600 font-semibold">Details →</span>
      <!-- Hover Popup -->
      <div class="doctor-popup absolute left-0 top-full mt-2 w-[20rem] bg-white border p-3 rounded shadow-md text-left pointer-events-none opacity-0 transition-opacity duration-150 z-50">
        <p class="text-sm font-medium">Timezone: <span class="text-gray-700">{{ doc.timezone }}</span></p>
        <p class="text-sm font-medium">Modalities: <span class="text-gray-700">{{ doc.modalities }}</span></p>
        <p class="text-sm font-medium">PACS: <span class="text-gray-700">{{ doc.pacs }}</span></p>
        <p class="text-sm font-medium">Contact: <span class="text-gray-700">{{ doc.email }}</span></p>
        <p class="text-sm font-medium">Phone: <span class="text-gray-700">{{ doc.phone }}</span></p>
      </div>
  </li>
  {% endfor %}
</ul>

<!-- Pagination Controls -->
<div class="mt-4 flex justify-between items-center">
  <div class="text-sm text-gray-700">
    Showing <span id="startItem">1</span> to <span id="endItem">{{ per_page }}</span> of <span id="totalItems">{{ total_count }}</span> entries
  </div>
  <div class="flex gap-2">
    <button onclick="changePage('prev')" id="prevPage" class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
      Previous
    </button>
    <button onclick="changePage('next')" id="nextPage" class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
      Next
    </button>
  </div>
</div>

<!-- Add Doctor Modal -->
<div id="addDoctorModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg w-[90%] max-w-2xl max-h-[90vh] overflow-y-auto p-6 relative">
    <button onclick="closeAddDoctorModal()" class="absolute top-2 right-2 text-2xl font-bold text-gray-500 hover:text-black">×</button>
    <h3 class="text-xl font-semibold mb-4">Add New Doctor</h3>

    <form method="POST" action="{{ url_for('dashboard.add_doctor') }}" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <label class="block">
          <span class="text-sm font-medium text-gray-700">Name*</span>
          <input type="text" name="name" required class="mt-1 w-full border rounded px-3 py-2 text-sm">
        </label>

        <label class="block">
          <span class="text-sm font-medium text-gray-700">Email*</span>
          <input type="email" name="email" required class="mt-1 w-full border rounded px-3 py-2 text-sm">
        </label>

        <label class="block">
          <span class="text-sm font-medium text-gray-700">Phone</span>
          <input type="tel" name="phone" class="mt-1 w-full border rounded px-3 py-2 text-sm">
        </label>

        <label class="block">
          <span class="text-sm font-medium text-gray-700">PACS</span>
          <input type="text" name="pacs" class="mt-1 w-full border rounded px-3 py-2 text-sm">
        </label>

        <label class="block">
          <span class="text-sm font-medium text-gray-700">Primary Contact Method</span>
          <select name="primary_contact_method" class="mt-1 w-full border rounded px-3 py-2 text-sm">
            <option value="">Select method...</option>
            <option value="email">Email</option>
            <option value="phone">Phone</option>
            <option value="pacs">PACS</option>
          </select>
        </label>

        <label class="block">
          <span class="text-sm font-medium text-gray-700">Timezone</span>
          <input type="text" name="timezone" placeholder="EST" class="mt-1 w-full border rounded px-3 py-2 text-sm">
        </label>

        <label class="block col-span-2">
          <span class="text-sm font-medium text-gray-700">Modalities</span>
          <input type="text" name="modalities" placeholder="e.g., CT, MRI, X-Ray" class="mt-1 w-full border rounded px-3 py-2 text-sm">
        </label>

        <label class="block col-span-2">
          <span class="text-sm font-medium text-gray-700">Additional Info</span>
          <textarea name="additional_info" rows="3" class="mt-1 w-full border rounded px-3 py-2 text-sm"></textarea>
        </label>

        <div class="col-span-2">
          <label class="flex items-center space-x-2">
            <input type="checkbox" name="active_status" value="true" checked class="form-checkbox h-5 w-5 text-blue-600">
            <span class="text-sm font-medium">Active Status</span>
          </label>
        </div>
      </div>

      <div class="flex justify-end pt-4 border-t">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-medium">
          Add Doctor
        </button>
      </div>
    </form>
  </div>
</div>

<script>
let currentPage = {{ current_page }};
const itemsPerPage = {{ per_page }};
let totalCount = {{ total_count }};
let searchTimeout;
let currentStatusFilter = 'active';

function debounceSearch() {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    currentPage = 1;
    loadDoctors();
  }, 300);
}

function filterByStatus(status) {
  currentStatusFilter = status;
  // Update button styles
  document.querySelectorAll('[data-status]').forEach(button => {
    button.classList.remove('active-filter', 'bg-blue-600', 'text-white');
    if (button.dataset.status === status) {
      button.classList.add('active-filter', 'bg-blue-600', 'text-white');
    }
  });
  currentPage = 1;
  loadDoctors();
}

function loadDoctors() {
  const searchTerm = document.getElementById('searchBox').value;
  fetch(`/dashboard/doctors/search?page=${currentPage}&search=${encodeURIComponent(searchTerm)}&status=${currentStatusFilter}`)
    .then(response => response.json())
    .then(data => {
      updateTable(data.doctors);
      updatePagination(data.total_count);
    });
}

function updateTable(doctors) {
  const tbody = document.getElementById('doctorList');
  tbody.innerHTML = '';
  
  doctors.forEach(doc => {
    const li = document.createElement('li');
    li.className = 'relative flex items-center justify-between p-4 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer doctor-item';
    li.onclick = () => window.location.href = `/dashboard/doctors/${doc.id}`;
    li.onmouseenter = () => showPopup(li);
    li.onmouseleave = () => hidePopup(li);
    
    const statusDot = `<div class="w-2 h-2 rounded-full ${doc.active_status ? 'bg-green-500' : 'bg-red-500'}"></div>`;

li.innerHTML = `
  <div class="flex items-center gap-3">
    ${statusDot}
    <div>
      <p class="text-lg font-medium name">${doc.name}</p>
      <p class="text-sm text-gray-500 email">${doc.email}</p>
    </div>
  </div>
  <span class="text-blue-600 font-semibold">Details →</span>

  <div class="doctor-popup absolute left-0 top-full mt-2 w-[20rem] bg-white border p-3 rounded shadow-md text-left pointer-events-none opacity-0 transition-opacity duration-150 z-50">
    <p class="text-sm font-medium">Timezone: <span class="text-gray-700">${doc.timezone || 'N/A'}</span></p>
    <p class="text-sm font-medium">Modalities: <span class="text-gray-700">${doc.modalities || 'N/A'}</span></p>
    <p class="text-sm font-medium">PACS: <span class="text-gray-700">${doc.pacs || 'N/A'}</span></p>
    <p class="text-sm font-medium">Contact: <span class="text-gray-700">${doc.email || 'N/A'}</span></p>
    <p class="text-sm font-medium">Phone: <span class="text-gray-700">${doc.phone || 'N/A'}</span></p>
  </div>
`;

    
    tbody.appendChild(li);
  });
}

function updatePagination(total) {
  totalCount = total;
  const totalPages = Math.ceil(totalCount / itemsPerPage);
  const startItem = ((currentPage - 1) * itemsPerPage) + 1;
  const endItem = Math.min(currentPage * itemsPerPage, totalCount);

  document.getElementById('startItem').textContent = startItem;
  document.getElementById('endItem').textContent = endItem;
  document.getElementById('totalItems').textContent = totalCount;

  document.getElementById('prevPage').disabled = currentPage === 1;
  document.getElementById('nextPage').disabled = currentPage === totalPages;
}

function changePage(direction) {
  const totalPages = Math.ceil(totalCount / itemsPerPage);
  
  if (direction === 'next' && currentPage < totalPages) {
    currentPage++;
  } else if (direction === 'prev' && currentPage > 1) {
    currentPage--;
  }
  
  loadDoctors();
}

function showPopup(element) {
  const popup = element.querySelector('.doctor-popup');
  if (popup) {
    popup.classList.remove('opacity-0');
    popup.classList.add('opacity-100');
  }
}

function hidePopup(element) {
  const popup = element.querySelector('.doctor-popup');
  if (popup) {
    popup.classList.remove('opacity-100');
    popup.classList.add('opacity-0');
  }
}

function openAddDoctorModal() {
  document.getElementById('addDoctorModal').classList.remove('hidden');
}

function closeAddDoctorModal() {
  document.getElementById('addDoctorModal').classList.add('hidden');
}

window.addEventListener('DOMContentLoaded', () => {
  // Set the active filter button style on page load
  document.querySelectorAll('[data-status]').forEach(button => {
    button.classList.remove('active-filter', 'bg-blue-600', 'text-white');
    if (button.dataset.status === 'active') {
      button.classList.add('active-filter', 'bg-blue-600', 'text-white');
    }
  });
  loadDoctors();
});
</script>

<style>
/* Form Styles */
.form-checkbox {
  border-radius: 0.25rem;
  border-color: #d1d5db;
}

.form-checkbox:checked {
  background-color: #2563eb;
  border-color: #2563eb;
}

/* Modal Styles */
#addDoctorModal {
  backdrop-filter: blur(4px);
}
</style>
{% endblock %}
