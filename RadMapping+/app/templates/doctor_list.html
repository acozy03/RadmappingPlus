{% extends "layout.html" %}

{% block title %}Doctor Directory{% endblock %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6 border-b pb-2">
  <h2 class="text-2xl font-semibold">Doctor Directory</h2>
  {% if session.user.role == 'admin' %}
  <button onclick="openAddDoctorModal()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-medium">
    Add Doctor
  </button>
  {% endif %}
</div>

<!-- Search Box -->
<input type="text"
       id="searchBox"
       placeholder="Search by name or email..."
       class="w-full mb-6 p-3 border rounded text-sm"
       onkeyup="filterDoctors()" />

<!-- Doctor List -->
<ul id="doctorList" class="space-y-4">
  {% for doc in doctors %}
  <li class="relative flex items-center justify-between p-4 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer doctor-item"
      onclick="window.location.href='/dashboard/doctors/{{ doc.id }}'"
      onmouseenter="showPopup(this)"
      onmouseleave="hidePopup(this)">
    <div>
      <p class="text-lg font-medium name">{{ doc.name }}</p>
      <p class="text-sm text-gray-500 email">{{ doc.email }}</p>
    </div>
    <span class="text-blue-600 font-semibold">Details →</span>

    <!-- Hover Popup -->
    <div class="doctor-popup absolute left-0 top-full mt-2 w-[20rem] bg-white border p-3 rounded shadow-md text-left pointer-events-none opacity-0 transition-opacity duration-150 z-50">
      <p class="text-sm font-medium">Timezone: <span class="text-gray-700">{{ doc.timezone }}</span></p>
      <p class="text-sm font-medium">Modalities: <span class="text-gray-700">{{ doc.modalities or 'N/A' }}</span></p>
      <p class="text-sm font-medium">PACS: <span class="text-gray-700">{{ doc.pacs or 'N/A' }}</span></p>
      <p class="text-sm font-medium">Schedule: {{ doc.schedule_info_est or "N/A" }}</p>
    </div>
  </li>
  {% endfor %}
</ul>

<!-- Add Doctor Modal -->
<div id="addDoctorModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg w-[90%] max-w-2xl max-h-[90vh] overflow-y-auto p-6 relative">
    <button onclick="closeAddDoctorModal()" class="absolute top-2 right-2 text-2xl font-bold text-gray-500 hover:text-black">×</button>
    <h3 class="text-xl font-semibold mb-4">Add New Doctor</h3>

    <form method="POST" action="{{ url_for('dashboard.add_doctor') }}" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <label class="block">
          <span class="text-sm font-medium text-gray-700">Name*</span>
          <input type="text" name="name" required class="mt-1 w-full border rounded px-3 py-2 text-sm">
        </label>

        <label class="block">
          <span class="text-sm font-medium text-gray-700">Email*</span>
          <input type="email" name="email" required class="mt-1 w-full border rounded px-3 py-2 text-sm">
        </label>

        <label class="block">
          <span class="text-sm font-medium text-gray-700">Phone</span>
          <input type="tel" name="phone" class="mt-1 w-full border rounded px-3 py-2 text-sm">
        </label>

        <label class="block">
          <span class="text-sm font-medium text-gray-700">PACS</span>
          <input type="text" name="pacs" class="mt-1 w-full border rounded px-3 py-2 text-sm">
        </label>

        <label class="block">
          <span class="text-sm font-medium text-gray-700">Primary Contact Method</span>
          <select name="primary_contact_method" class="mt-1 w-full border rounded px-3 py-2 text-sm">
            <option value="">Select method...</option>
            <option value="email">Email</option>
            <option value="phone">Phone</option>
            <option value="pacs">PACS</option>
          </select>
        </label>

        <label class="block">
          <span class="text-sm font-medium text-gray-700">Timezone</span>
          <input type="text" name="timezone" placeholder="EST" class="mt-1 w-full border rounded px-3 py-2 text-sm">
        </label>

        <label class="block col-span-2">
          <span class="text-sm font-medium text-gray-700">Modalities</span>
          <input type="text" name="modalities" placeholder="e.g., CT, MRI, X-Ray" class="mt-1 w-full border rounded px-3 py-2 text-sm">
        </label>

        <label class="block col-span-2">
          <span class="text-sm font-medium text-gray-700">Additional Info</span>
          <textarea name="additional_info" rows="3" class="mt-1 w-full border rounded px-3 py-2 text-sm"></textarea>
        </label>

        <div class="col-span-2">
          <label class="flex items-center space-x-2">
            <input type="checkbox" name="active_status" value="true" checked class="form-checkbox h-5 w-5 text-blue-600">
            <span class="text-sm font-medium">Active Status</span>
          </label>
        </div>
      </div>

      <div class="flex justify-end pt-4 border-t">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-medium">
          Add Doctor
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Scripts -->
<script>
  function filterDoctors() {
    const input = document.getElementById("searchBox").value.toLowerCase();
    const doctors = document.querySelectorAll(".doctor-item");

    doctors.forEach(doc => {
      const name = doc.querySelector(".name").textContent.toLowerCase();
      const email = doc.querySelector(".email").textContent.toLowerCase();
      const match = name.includes(input) || email.includes(input);
      doc.style.display = match ? "flex" : "none";
    });
  }

  function showPopup(parent) {
    const popup = parent.querySelector('.doctor-popup');
    if (popup) {
      popup.classList.remove('opacity-0');
      popup.classList.add('opacity-100');
    }
  }

  function hidePopup(parent) {
    const popup = parent.querySelector('.doctor-popup');
    if (popup) {
      popup.classList.remove('opacity-100');
      popup.classList.add('opacity-0');
    }
  }

  function openAddDoctorModal() {
    document.getElementById('addDoctorModal').classList.remove('hidden');
  }

  function closeAddDoctorModal() {
    document.getElementById('addDoctorModal').classList.add('hidden');
  }
</script>

<style>
/* Form Styles */
.form-checkbox {
  border-radius: 0.25rem;
  border-color: #d1d5db;
}

.form-checkbox:checked {
  background-color: #2563eb;
  border-color: #2563eb;
}

/* Modal Styles */
#addDoctorModal {
  backdrop-filter: blur(4px);
}
</style>
{% endblock %}
