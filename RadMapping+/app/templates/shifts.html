{% extends "layout.html" %}
{% block title %}Capacity Gaps{% endblock %}

{% block content %}
<script>
  document.body.classList.add('hour-sort-initializing');
</script>
<style>
  .shifts-loading-skeleton {
    display: none;
  }

  body.hour-sort-initializing .shifts-loading-skeleton {
    display: block;
  }

  body.hour-sort-initializing .sorted-hour-container {
    display: none;
  }

  body.hour-sort-initializing .capacity-section[data-sorted-view="true"],
  body.hour-sort-active .capacity-section[data-sorted-view="true"] {
    display: none !important;
  }

  body.hour-sort-ready .shifts-loading-skeleton {
    display: none;
  }
</style>
<div x-data="{
    show: false,
    doctors: [],
    time: '',
    date: '',
    uncoveredStates: [],
    coveredStates: [],
    stateDoctorMap: {},
    stateQuery: '',
    matchedStates: [],
    hoveredState: '',
    facilityDoctorMap: {},
    facilityQuery: '',
    matchedFacilities: [],
    hoveredFacility: '',
    hourDetail: null,
    hourLoading: false,
    // Units toggle for modal values: 'rvus' or 'cases'
    units: 'rvus',
    // Match backend modality RVU chunks for case conversion
    modalityChunks: {
      'XR': 0.2,
      'CT': 1.1,
      'US': 0.5,
      'MRI': 1.4,
      'MG': 0.8,
      'NM': 2.5,
      'PT': 2.5,
      'IR': 4.0,
      'RF': 0.7,
      'SC': 0.6,
      'OT': 0.3,
      'XA': 0.8,
      'ECG': 0.2,
    },
    chunkFor(mod) {
      const m = (mod || '').toUpperCase();
      return this.modalityChunks[m] || 0.2;
    },
    toCases(v, mod) {
      const ch = this.chunkFor(mod);
      if (!ch || !isFinite(ch) || ch <= 0) return 0;
      const n = Math.round((Number(v) || 0) / ch);
      return isFinite(n) ? n : 0;
    },
    fmtNumber(v) {
      const val = Number(v) || 0;
      return Math.abs(val) < 1 ? val.toFixed(3) : val.toFixed(1);
    },
    fmtValue(v, mod) {
      return this.units === 'rvus' ? this.fmtNumber(v) : String(this.toCases(v, mod));
    },
    sumCasesByModality(list) {
      return (list || []).reduce((t, m) => t + this.toCases(m?.expected_rvus || 0, m?.modality), 0);
    },
    totalExpectedCases() {
      return this.sumCasesByModality(this.hourDetail?.by_modality || []);
    },
    totalSupplyCases() {
      const allocs = (this.hourDetail?.doctor_allocations || []).flatMap(d => d.allocations || []);
      return allocs.reduce((t, a) => t + this.toCases(a?.allocated_rvus || 0, a?.modality), 0);
    }
}"
          x-effect="document.body.classList.toggle(&quot;overflow-hidden&quot;, show)"
     class="shifts-page">

<div class="shifts-filter-bar rounded-xl shadow-sm p-4 sm:p-6 mb-6 w-full border border-blue-100">
    <div class="flex items-center justify-between flex-wrap gap-4">
        <a href="{{ url_for('shifts.shifts', date=prev_week_start) }}"
           class="p-2 hover:bg-blue-100 rounded-full transition-colors shifts-nav-button">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
        </a>

        <div class="relative">
            <button type="button"
                    onclick="toggleCalendar()"
                    class="flex items-center gap-2 bg-blue-100 hover:bg-blue-200 text-blue-700 px-4 py-2 rounded-lg transition-colors shadow-sm shifts-filter-button">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <span class="font-medium">{{ start_date }} - {{ end_date }}</span>
            </button>

            <div id="calendarPopup" class="hidden absolute top-full left-0 mt-2 bg-black rounded-xl shadow-2xl border border-gray-200 z-50 p-4 min-w-[320px] shifts-calendar">
                <div class="flex items-center justify-between mb-4">
                    <button type="button" onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-lg transition-colors shifts-calendar__nav">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <div class="text-center">
                        <h3 id="calendarMonth" class="text-lg font-semibold text-gray-800"></h3>
                        <p id="calendarYear" class="text-sm text-gray-600"></p>
                    </div>
                    <button type="button" onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
                <div class="grid grid-cols-7 gap-1 mb-2">
                    <div class="text-center text-xs font-medium text-gray-500 py-2">Sun</div>
                    <div class="text-center text-xs font-medium text-gray-500 py-2">Mon</div>
                    <div class="text-center text-xs font-medium text-gray-500 py-2">Tue</div>
                    <div class="text-center text-xs font-medium text-gray-500 py-2">Wed</div>
                    <div class="text-center text-xs font-medium text-gray-500 py-2">Thu</div>
                    <div class="text-center text-xs font-medium text-gray-500 py-2">Fri</div>
                    <div class="text-center text-xs font-medium text-gray-500 py-2">Sat</div>
                </div>
                <div id="calendarDays" class="grid grid-cols-7 gap-1">
                    </div>
                <div class="flex gap-2 mt-4 pt-4 border-t border-gray-200">
                    <button type="button" onclick="selectToday()" class="flex-1 px-3 py-2 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors shifts-filter-button">
                        This Week
                    </button>
                    <button type="button" onclick="closeCalendar()" class="flex-1 px-3 py-2 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors shifts-filter-button">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <a href="{{ url_for('shifts.shifts', date=next_week_start) }}"
           class="p-2 hover:bg-blue-100 rounded-full transition-colors shifts-nav-button">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
        </a>
    </div>
</div>

{# Filter Controls #}
<div x-data="{
  showRed: true,
  showYellow: true,
  showGreen: true,
  stateQuery: '',
  facilityQuery: '',
  facilityMatches: [],
  init() {
    const reapplyFilters = () => {
      window.requestAnimationFrame(() => this.applyFilters());
    };

    document.addEventListener('shifts:refreshFilters', reapplyFilters);

    this.$el.addEventListener('alpine:destroy', () => {
      document.removeEventListener('shifts:refreshFilters', reapplyFilters);
    });

    this.$nextTick(() => this.applyFilters());
  },
  applyFilters() {
    const normalize = s => s.toLowerCase().replace(/\s+/g, ' ').replace(/\n/g, ' ').trim();
    const facilityQuery = normalize(this.facilityQuery);
    const stateQuery = normalize(this.stateQuery || '');

    document.querySelectorAll('.hour-slot-div').forEach(slotElement => {
      const facilityDataRaw = slotElement.getAttribute('data-facility-doctor-map') || '{}';
      const coveredStatesRaw = slotElement.getAttribute('data-covered-states') || '[]';
      let facilityData = {};
      let coveredStates = [];
      try {
        facilityData = JSON.parse(facilityDataRaw);
        coveredStates = JSON.parse(coveredStatesRaw);
      } catch {
        return;
      }

      const facilityNames = Object.keys(facilityData);
      const stateMatch = stateQuery
        ? coveredStates.some(state => normalize(state).includes(stateQuery))
        : true;
      const facilityMatch = facilityQuery
        ? facilityNames.some(name => normalize(name).includes(facilityQuery) && facilityData[name].length > 0)
        : true;

      const match = stateMatch && facilityMatch;

      slotElement.classList.remove('ring-red-500', 'ring-green-500', 'ring-2');

      if (stateQuery || facilityQuery) {
        slotElement.classList.add(match ? 'ring-green-500' : 'ring-red-500', 'ring-2');
      }
    });

    // NEW: Filter visibility of capacity sections
    const sortActive = document.body.classList.contains('hour-sort-active');

    document.querySelectorAll('.capacity-section').forEach(section => {
      const isRed = section.classList.contains('bg-red-100');
      const isYellow = section.classList.contains('bg-yellow-100');
      const isGreen = section.classList.contains('bg-green-100');

      const shouldShow =
        (isRed && this.showRed) ||
        (isYellow && this.showYellow) ||
        (isGreen && this.showGreen);

      if (sortActive && section.dataset.sortedView === 'true') {
        section.style.display = 'none';
      } else {
        section.style.display = shouldShow ? '' : 'none';
      }
    });

    if (sortActive) {
      document.querySelectorAll('.sorted-hour-container [data-color-group]').forEach(wrapper => {
        const colorGroup = wrapper.getAttribute('data-color-group');
        const isRed = colorGroup === 'red';
        const isYellow = colorGroup === 'yellow';
        const isGreen = colorGroup === 'green';

        const shouldShow =
          (isRed && this.showRed) ||
          (isYellow && this.showYellow) ||
          (isGreen && this.showGreen);

        wrapper.style.display = shouldShow ? '' : 'none';
      });
    }
  },
  updateFilters: debounce(function () {
    this.applyFilters();
  }, 150),

  updateStateSuggestions() {
    const query = this.stateQuery.trim().toLowerCase();
    const allStates = new Set();

    document.querySelectorAll('.hour-slot-div').forEach(slotElement => {
      const states = JSON.parse(slotElement.getAttribute('data-covered-states') || '[]');
      states.forEach(s => allStates.add(s));
    });

    this.matchedStates = [...allStates].filter(s => s.toLowerCase().includes(query)).slice(0, 10);
  },

  updateFacilitySuggestions() {
    const query = this.facilityQuery.trim().toLowerCase();
    const allFacilities = new Set();

    document.querySelectorAll('.hour-slot-div').forEach(slotElement => {
      const facilityData = JSON.parse(slotElement.getAttribute('data-facility-doctor-map') || '{}');
      Object.keys(facilityData).forEach(fac => allFacilities.add(fac));
    });

    this.facilityMatches = [...allFacilities]
      .filter(f => f.toLowerCase().includes(query))
      .slice(0, 10);
  }
}"

 class="mb-6 p-4 bg-white rounded-lg shadow-sm border border-gray-200 shifts-filter-panel">
    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div class="flex items-center flex-wrap gap-3">
            <span class="text-sm font-medium text-gray-700">Show Sections:</span>
            <label class="inline-flex items-center">
                <input type="checkbox" class="form-checkbox h-4 w-4 text-red-600" checked x-model="showRed" @change="updateFilters()">
                <span class="ml-2 text-sm text-gray-700">Below 60% Capacity</span>
            </label>
            <label class="inline-flex items-center">
                <input type="checkbox" class="form-checkbox h-4 w-4 text-yellow-500" checked x-model="showYellow" @change="updateFilters()">
                <span class="ml-2 text-sm text-gray-700">60-90% Capacity</span>
            </label>
            <label class="inline-flex items-center">
                <input type="checkbox" class="form-checkbox h-4 w-4 text-green-600" checked x-model="showGreen" @change="updateFilters()">
                <span class="ml-2 text-sm text-gray-700">Above 90% Capacity</span>
            </label>
        </div>
        <div class="flex items-center gap-2 flex-wrap md:justify-end">
          <label for="sort-metric-select" class="text-sm font-medium text-gray-700">Sort By:</label>
          <select
            id="sort-metric-select"
            class="px-2 py-1.5 text-sm border border-blue-200 rounded-md bg-white text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-300"
          >
            <option value="time">Hour</option>
            <option value="capacity" selected>Capacity Ratio</option>
          </select>
          <button
            id="hour-sort-toggle"
            type="button"
            class="px-3 py-1.5 text-sm font-medium bg-blue-100 text-blue-700 rounded-md shadow-sm hover:bg-blue-200 transition-colors shifts-filter-button"
          >
            Direction: Ascending
          </button>
        </div>
    </div>
    <div class="mt-4 pt-4 border-t border-gray-200 flex flex-col md:flex-row gap-4">
         <div class="flex-1">
  <label class="block text-sm font-medium text-gray-700 mb-1" for="global-state-search">Filter by State Coverage:</label>
  <div class="relative">
    <input
      id="global-state-search"
      type="text"
      placeholder="Enter state name"
      class="w-full px-2 py-1 border rounded text-sm"
      x-model="stateQuery"
      @input="updateFilters(); updateStateSuggestions();"
      @focus="updateStateSuggestions()"
      @click.outside="matchedStates = []"
    />

    <ul 
      x-show="matchedStates.length > 0" 
      class="absolute z-50 bg-white border border-gray-300 mt-1 w-full rounded shadow text-sm shifts-suggestion"
    >
      <template x-for="state in matchedStates" :key="state">
        <li
          class="px-3 py-1 hover:bg-gray-100 cursor-pointer shifts-suggestion__item"
          @click="stateQuery = state; matchedStates = []; updateFilters();"
          x-text="state"
        ></li>
      </template>
    </ul>
  </div>
</div>

        <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-1" for="global-facility-search">Filter by Facility Coverage:</label>
             <div class="relative">
  <input
    id="global-facility-search"
    type="text"
    placeholder="Enter facility name"
    class="w-full px-2 py-1 border rounded text-sm"
    x-model="facilityQuery"
    @input="updateFilters(); updateFacilitySuggestions();"
    @focus="updateFacilitySuggestions()"
    @click.outside="facilityMatches = []"
  />

  <ul 
    x-show="facilityMatches.length > 0" 
    class="absolute z-50 bg-white border border-gray-300 mt-1 w-full rounded shadow text-sm shifts-suggestion"
  >
    <template x-for="fac in facilityMatches" :key="fac">
      <li
        class="px-3 py-1 hover:bg-gray-100 cursor-pointer shifts-suggestion__item"
        @click="facilityQuery = fac; facilityMatches = []; updateFilters();"
        x-text="fac"
      ></li>
    </template>
  </ul>
</div>

        </div>
    </div>
</div>

<div class="overflow-x-auto">
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 xl:grid-cols-7 gap-4 px-2 py-2">
        {% set today_date = namespace(value=(datetime.utcnow().date())) %}

        {% for day, color_grouped_slots in weekly_data_by_day_and_color.items() %}
        {% set is_today = (day == today_date.value) %}
        <div class="{{ 'ring-2 ring-blue-300 ring-offset-1' if is_today else '' }} flex flex-col min-w-0 rounded-md bg-white shifts-day-card">
            {% set first_color_group = color_grouped_slots.values() | first %}
            {% set first_slot_of_day = first_color_group | first if first_color_group %}
            {% if first_slot_of_day %}
            <div class="bg-gray-200 p-4 rounded-t-lg text-center mt-1 shifts-day-header">
                <h2 class="text-base md:text-xl font-semibold text-gray-700">{{ first_slot_of_day.day_label }}</h2>
                <p class="text-xs md:text-sm text-gray-600">{{ day.strftime("%Y-%m-%d") }}</p>
            </div>
            {% endif %}

            <div class="flex-1 bg-white rounded-b-lg border border-gray-200 p-2 md:p-4 shifts-day-body">
                <div class="shifts-loading-skeleton space-y-3" aria-hidden="true">
                    <div class="h-20 rounded-lg bg-gray-200 animate-pulse"></div>
                    <div class="h-20 rounded-lg bg-gray-200 animate-pulse"></div>
                    <div class="h-20 rounded-lg bg-gray-200 animate-pulse"></div>
                </div>
                <div class="sorted-hour-container space-y-2"></div>
                {% for color_class, slots_in_color_group in color_grouped_slots.items() %}
                <div class="mb-4 capacity-section {{ color_class }} rounded-lg p-2 shifts-capacity-section" data-sorted-view="true">
                    <div class="space-y-2">
                        {% for slot in slots_in_color_group %}
  {% set stats = hourly_rvu_stats[slot.datetime] %}
  {% set current = stats['current'] if stats else None %}
  {% set expected = stats['historical'] if stats else None %}
  {% set ratio = (current / expected) if current is not none and expected and expected > 0 else None %}
  {% set ratio_percent = (ratio * 100) | round(1) if ratio is not none else None %}
  {% set slot_key = slot.datetime.isoformat() %}
  {% set facility_doctor_map = facility_doctor_map_by_hour.get(slot_key, {}) %}
  {% set uncovered_states = uncovered_states_by_hour.get(slot_key, []) %}
  {% set covered_states = covered_states_by_hour.get(slot_key, []) %}
  {% set state_doctor_map = state_doctor_map_by_hour.get(slot_key, {}) %}
  {% set modal_doctors = [] %}
  {% for doc in doctors_by_hour.get(slot.datetime, []) %}
    {% set _ = modal_doctors.append({
      'id': doc.id,
      'name': doc.name | trim,
      'url': url_for('doctors.doctor_profile', rad_id=doc.id),
      'modalities': doc.modalities | default('', true) | trim
    }) %}
  {% endfor %}

  {% set color_group_name = 'red' if 'red' in color_class else 'yellow' if 'yellow' in color_class else 'green' if 'green' in color_class else 'neutral' %}
  <div
    class="relative group"
    data-sort-time="{{ slot.datetime.isoformat() }}"
    data-color-group="{{ color_group_name }}"
    data-capacity-ratio="{{ ratio if ratio is not none else '' }}"
  >

    <div
      @click="
        show = true;
        doctors = JSON.parse($el.getAttribute('data-doctors'));
        time = '{{ slot.label }}';
        date = '{{ slot.datetime.strftime('%Y-%m-%d') }}';
        uncoveredStates = JSON.parse($el.getAttribute('data-uncovered-states'));
        coveredStates = JSON.parse($el.getAttribute('data-covered-states'));
        stateDoctorMap = JSON.parse($el.getAttribute('data-state-doctor-map'));
        facilityDoctorMap = JSON.parse($el.getAttribute('data-facility-doctor-map'));
        const rvu = JSON.parse($el.getAttribute('data-rvu'));
        if (doctors.length > 0) {
          doctors[0].current = rvu.current;
          doctors[0].expected = rvu.expected;
          doctors[0].ratio = rvu.ratio;
        }
        // Load per-facility/state demand for this hour
        hourDetail = null; hourLoading = true;
        const _date = $el.getAttribute('data-date');
        const _hour = $el.getAttribute('data-hour');
        const url = '{{ url_for("shifts.hour_detail") }}?date=' + encodeURIComponent(_date) + '&hour=' + encodeURIComponent(_hour);
        try {
          console.log('[shifts] Fetch hour_detail', { date: _date, hour: _hour, url });
        } catch {}
        fetch(url)
          .then(r => {
            try { console.log('[shifts] hour_detail status', r.status); } catch {}
            if (!r.ok) throw new Error('HTTP '+r.status);
            return r.json();
          })
          .then(data => {
            try { console.log('[shifts] hour_detail data', data); } catch {}
            hourDetail = data;
          })
          .catch(err => {
            try { console.error('[shifts] hour_detail error', err); } catch {}
            hourDetail = { error: 'Failed to load' };
          })
          .finally(() => { hourLoading = false; });
      "
      data-doctors='{{ modal_doctors | tojson | escape }}'
      data-uncovered-states='{{ uncovered_states | tojson | escape }}'
      data-covered-states='{{ covered_states | tojson | escape }}'
      data-state-doctor-map='{{ state_doctor_map | tojson | escape }}'
      data-facility-doctor-map='{{ facility_doctor_map | tojson | safe }}'

      data-rvu='{{ {
        "current": current,
        "expected": expected,
        "ratio": ratio
      } | tojson | escape }}'
      data-date='{{ slot.date }}'
      data-hour='{{ slot.hour }}'
      class="group rounded-md p-2 md:p-3 shadow-sm border border-gray-300 {{ color_class }} relative cursor-pointer hour-slot-div shifts-slot-card min-w-0"
    >
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-1 md:gap-0">
        <h4 class="text-xs md:text-sm font-semibold text-gray-800">
          <span>{{ slot.label }}</span>
        </h4>
        <span class="flex flex-wrap items-center text-xs text-gray-700 relative gap-x-1 gap-y-0.5 md:gap-x-2" style="min-width:0;">
          <span class="text-blue-700 font-semibold">
            {{ (current | round(1)) if current is not none else '—' }}
          </span>
          <span class="text-gray-400">vs</span>
          <span class="text-green-700 font-semibold">
            {{ (expected | round(1)) if expected is not none else '—' }}
          </span>
        </span>
      </div>
    </div>

    {% if ratio_percent is not none %}
    <div
      class="absolute left-1/2 -translate-x-1/2 bottom-full mb-1 w-max bg-white border border-gray-300 rounded shadow-lg px-3 py-1 text-xs text-gray-900 opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity z-50 whitespace-nowrap shifts-tooltip"
    >
      Capacity Ratio: {{ ratio_percent }}%
    </div>
    {% endif %}
  </div>
{% endfor %}

                      
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<div 
     x-show="show"
     @close-modal.window="show = false"
     class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center shifts-modal-overlay"
     x-transition
     style="display: none;"
>
  <div @click.away="show = false" class="relative bg-white rounded-lg p-6 w-[48rem] min-h-[32rem] shadow-xl shifts-modal">

    <button @click="show = false"
            class="absolute top-3 right-4 text-gray-500 hover:text-gray-800 text-2xl font-bold focus:outline-none"
            aria-label="Close">
      &times;
    </button>
    <!-- Units toggle -->
    <div class="absolute top-3 left-4 flex items-center gap-2 text-xs">
      <span class="text-gray-600">Display:</span>
      <div class="inline-flex rounded border border-gray-300 overflow-hidden">
        <button type="button" @click="units='rvus'"
                :class="units==='rvus' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700'"
                class="px-2 py-1">RVUs</button>
        <button type="button" @click="units='cases'"
                :class="units==='cases' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700'"
                class="px-2 py-1">Cases</button>
      </div>
    </div>
    <p class="text-sm text-gray-700 mb-2">
  <template x-if="!hourLoading && hourDetail && hourDetail.supply_effective_allocated_rvus !== undefined">
    <span>
      <!-- RVUs view -->
      <span x-show="units==='rvus'">
        <span class="text-blue-700 font-semibold" x-text="fmtNumber(hourDetail.supply_effective_allocated_rvus||0)"></span>
        <span class="text-gray-400">vs</span>
        <span class="text-green-700 font-semibold" x-text="fmtNumber(hourDetail.total_expected_rvus||0)"></span>
      </span>
      <!-- Cases view -->
      <span x-show="units==='cases'">
        <span class="text-blue-700 font-semibold" x-text="totalSupplyCases()"></span>
        <span class="text-gray-400">vs</span>
        <span class="text-green-700 font-semibold" x-text="totalExpectedCases()"></span>
      </span>
      <span class="text-gray-700 font-medium">(
        <span x-text="(hourDetail.total_expected_rvus>0 ? ((hourDetail.supply_effective_allocated_rvus/hourDetail.total_expected_rvus)*100).toFixed(1) : '0.0') + '%' "></span>
      )</span>
    </span>
  </template>
  <template x-if="hourLoading || !hourDetail || hourDetail.supply_effective_allocated_rvus === undefined">
    <span>
      <template x-if="doctors.length > 0 && doctors[0].current !== undefined">
        <span class="text-blue-700 font-semibold" x-text="doctors[0].current.toFixed(1)"></span>
      </template>
      <template x-if="doctors.length === 0 || doctors[0].current === undefined">
        <span class="text-blue-700 font-semibold">—</span>
      </template>
      <span class="text-gray-400">vs</span>
      <template x-if="doctors.length > 0 && doctors[0].expected !== undefined">
        <span class="text-green-700 font-semibold" x-text="doctors[0].expected.toFixed(1)"></span>
      </template>
      <template x-if="doctors.length === 0 || doctors[0].expected === undefined">
        <span class="text-green-700 font-semibold">—</span>
      </template>
      <template x-if="doctors.length > 0 && doctors[0].ratio !== undefined">
        <span class="text-gray-700 font-medium">
          (<span x-text="(doctors[0].ratio * 100).toFixed(1) + '%'"></span>)
        </span>
      </template>
    </span>
  </template>
</p>

      
      
    <h2 class="text-sm font-semibold mb-2 text-gray-800">Scheduled Doctors
    <template x-if="false">
      <div class="mt-2 grid grid-cols-1 md:grid-cols-3 gap-2">
          <div>
            <h4 class="text-xs font-semibold text-gray-700 mb-1">By Facility</h4>
            <div class="max-h-36 overflow-y-auto space-y-1">
              <template x-for="f in hourDetail.facilities" :key="f.facility_id">
                <div x-data="{ open: false }" class="text-xs bg-white border rounded">
                  <button @click="open = !open" class="w-full px-2 py-1 flex items-center justify-between">
                    <div class="truncate text-left">
                      <span class="font-medium" x-text="f.facility_name || f.facility_id"></span>
                      <span class="text-gray-500" x-text="f.state ? ' ('+f.state+')' : ''"></span>
                    </div>
                    <div class="ml-2 shrink-0 flex items-center gap-2">
                      <span class="text-green-700 font-semibold" x-text="units==='rvus' 
                        ? (f.expected_rvus || 0).toFixed(1) 
                        : (()=>{ const CH={XR:0.2,CT:1.1,US:0.5,MRI:1.4,MG:0.8,NM:2.5,PT:2.5,IR:4.0,RF:0.7,SC:0.6,OT:0.3,XA:0.8,ECG:0.2}; const mods=(f.modalities||[]); return mods.reduce((t,md)=>{ const m=(md.modality||'').toUpperCase(); const ch=CH[m]||0.2; return t + Math.round(((md.expected_rvus||0)/ch)); },0); })()"></span>
                      <span class="text-gray-400">|</span>
                      <span class="text-gray-500" x-text="(hourDetail.total_expected_rvus>0 ? ((f.expected_rvus/hourDetail.total_expected_rvus)*100).toFixed(1)+'%' : '—%')"></span>
                    </div>
                  </button>
                  <div x-show="open" x-transition class="px-2 pb-2">
                    <template x-for="md in (f.modalities || [])" :key="md.modality">
                      <div class="flex items-center justify-between mt-1">
                        <span class="inline-block text-[10px] px-1.5 py-0.5 rounded bg-blue-50 text-blue-700 border border-blue-200" x-text="md.modality"></span>
                        <div class="ml-2 shrink-0 flex items-center gap-2">
                          <span class="text-green-700 font-semibold" x-text="units==='rvus' 
                            ? (md.expected_rvus || 0).toFixed(1) 
                            : (()=>{ const m=(md.modality||'').toUpperCase(); const CH={XR:0.2,CT:1.1,US:0.5,MRI:1.4,MG:0.8,NM:2.5,PT:2.5,IR:4.0,RF:0.7,SC:0.6,OT:0.3,XA:0.8,ECG:0.2}; const ch=CH[m]||0.2; return Math.round(((md.expected_rvus||0)/ch)); })()"></span>
                          <span class="text-gray-400">|</span>
                          <span class="text-gray-500" x-text="(hourDetail.total_expected_rvus>0 ? ((md.expected_rvus/hourDetail.total_expected_rvus)*100).toFixed(1)+'%' : '—%')"></span>
                        </div>
                      </div>
                    </template>
                  </div>
                </div>
              </template>
            </div>
          </div>
          <div>
            <h4 class="text-xs font-semibold text-gray-700 mb-1">By State</h4>
            <div class="max-h-36 overflow-y-auto space-y-1">
              <template x-for="s in hourDetail.by_state_merged" :key="s.state">
                <div x-data="{ open: false }" class="text-xs bg-white border rounded">
                  <button @click="open = !open" class="w-full px-2 py-1 flex items-center justify-between">
                    <span class="truncate font-medium" x-text="s.state || 'Unknown'"></span>
                    <div class="ml-2 shrink-0 flex items-center gap-2">
                      <span class="text-green-700 font-semibold" x-text="units==='rvus' 
                        ? (s.expected_rvus || 0).toFixed(1) 
                        : (()=>{ const CH={XR:0.2,CT:1.1,US:0.5,MRI:1.4,MG:0.8,NM:2.5,PT:2.5,IR:4.0,RF:0.7,SC:0.6,OT:0.3,XA:0.8,ECG:0.2}; const br=(hourDetail.state_breakdown[s.state]||[]); return br.reduce((t,md)=>{ const m=(md.modality||'').toUpperCase(); const ch=CH[m]||0.2; return t + Math.round(((md.expected_rvus||0)/ch)); },0); })()"></span>
                      <span class="text-gray-400">|</span>
                      <span class="text-gray-500" x-text="(hourDetail.total_expected_rvus>0 ? ((s.expected_rvus/hourDetail.total_expected_rvus)*100).toFixed(1)+'%' : '—%')"></span>
                    </div>
                  </button>
                  <div x-show="open" x-transition class="px-2 pb-2">
                    <template x-for="md in (hourDetail.state_breakdown[s.state] || [])" :key="md.modality">
                      <div class="flex items-center justify-between mt-1">
                        <span class="inline-block text-[10px] px-1.5 py-0.5 rounded bg-blue-50 text-blue-700 border border-blue-200" x-text="md.modality || 'Unknown'"></span>
                        <div class="ml-2 shrink-0 flex items-center gap-2">
                          <span class="text-green-700 font-semibold" x-text="units==='rvus' 
                            ? (md.expected_rvus || 0).toFixed(1) 
                            : (()=>{ const m=(md.modality||'').toUpperCase(); const CH={XR:0.2,CT:1.1,US:0.5,MRI:1.4,MG:0.8,NM:2.5,PT:2.5,IR:4.0,RF:0.7,SC:0.6,OT:0.3,XA:0.8,ECG:0.2}; const ch=CH[m]||0.2; return Math.round(((md.expected_rvus||0)/ch)); })()"></span>
                          <span class="text-gray-400">|</span>
                          <span class="text-gray-500" x-text="(hourDetail.total_expected_rvus>0 ? ((md.expected_rvus/hourDetail.total_expected_rvus)*100).toFixed(1)+'%' : '—%')"></span>
                        </div>
                      </div>
                    </template>
                  </div>
                </div>
              </template>
            </div>
          </div>
          <div>
            <h4 class="text-xs font-semibold text-gray-700 mb-1">By Modality</h4>
            <div class="max-h-36 overflow-y-auto space-y-1">
              <template x-for="m in hourDetail.by_modality" :key="m.modality">
                <div x-data="{ open: false }" class="text-xs bg-white border rounded">
                  <button @click="open = !open" class="w-full px-2 py-1 flex items-center justify-between">
                    <span class="inline-block text-[10px] px-1.5 py-0.5 rounded bg-blue-50 text-blue-700 border border-blue-200" x-text="m.modality || 'Unknown'"></span>
                    <div class="ml-2 shrink-0 flex items-center gap-2">
                      <span class="text-green-700 font-semibold" x-text="units==='rvus' 
                        ? (m.expected_rvus || 0).toFixed(1) 
                        : (()=>{ const m2=(m.modality||'').toUpperCase(); const CH={XR:0.2,CT:1.1,US:0.5,MRI:1.4,MG:0.8,NM:2.5,PT:2.5,IR:4.0,RF:0.7,SC:0.6,OT:0.3,XA:0.8,ECG:0.2}; const ch=CH[m2]||0.2; return Math.round(((m.expected_rvus||0)/ch)); })()"></span>
                      <span class="text-gray-400">|</span>
                      <span class="text-gray-500" x-text="(hourDetail.total_expected_rvus>0 ? ((m.expected_rvus/hourDetail.total_expected_rvus)*100).toFixed(1)+'%' : '—%')"></span>
                    </div>
                  </button>
                  <div x-show="open" x-transition class="px-2 pb-2">
                    <template x-for="st in (hourDetail.modality_breakdown[m.modality] || [])" :key="st.state">
                      <div class="flex items-center justify-between mt-1">
                        <span class="font-medium" x-text="st.state || 'Unknown'"></span>
                        <div class="ml-2 shrink-0 flex items-center gap-2">
                          <span class="text-green-700 font-semibold" x-text="units==='rvus' 
                            ? (st.expected_rvus || 0).toFixed(1) 
                            : (()=>{ const m3=(m.modality||'').toUpperCase(); const CH={XR:0.2,CT:1.1,US:0.5,MRI:1.4,MG:0.8,NM:2.5,PT:2.5,IR:4.0,RF:0.7,SC:0.6,OT:0.3,XA:0.8,ECG:0.2}; const ch=CH[m3]||0.2; return Math.round(((st.expected_rvus||0)/ch)); })()"></span>
                          <span class="text-gray-400">|</span>
                          <span class="text-gray-500" x-text="(hourDetail.total_expected_rvus>0 ? ((st.expected_rvus/hourDetail.total_expected_rvus)*100).toFixed(1)+'%' : '—%')"></span>
                        </div>
                      </div>
                    </template>
                  </div>
                </div>
              </template>
            </div>
          </div>
      </div>
    </template>
    <template x-if="!hourLoading && hourDetail && (!hourDetail.facilities || hourDetail.facilities.length === 0)">
      <div class="mt-2 text-xs text-gray-500">
        No facility-level demand records were found for the expected prior-week hour.
      </div>
    </template>
    <p class="text-sm text-gray-500 mb-2">
        <span x-text="date"></span>
        &nbsp;&mdash;&nbsp;
        <span x-text="time"></span>
      </p>
    
      
    </h2>
        <!-- Doctor allocations (expand on doctor name; only > 0.0 entries) -->
        <template x-if="!hourLoading && hourDetail && (hourDetail.doctor_allocations||[]).length">
          <div class="space-y-2 max-h-64 overflow-y-auto">
            <template x-for="doc in hourDetail.doctor_allocations" :key="doc.id">
              <div class="border rounded p-2 bg-white" x-data="{ open: false }">
                <button class="flex items-center justify-between w-full text-left" @click="open = !open">
                  <div>
                    <a @click.stop :href="(doctors.find(d=>d.id===doc.id)||{}).url" target="_blank" rel="noopener" class="text-sm font-semibold text-blue-800 hover:text-blue-900" x-text="doc.name || ('ID ' + doc.id)"></a>
                    <span class="ml-2 text-[11px] text-gray-600">
                      <span x-text="units==='rvus' ? 'Contributing RVUs:' : 'Contributing Cases:'"></span>
                      <span x-text="units==='rvus' 
                        ? (() => { const v=(doc.contributing_rvus||0); return Math.abs(v) < 1 ? v.toFixed(3) : v.toFixed(1); })() 
                        : ((doc.allocations||[]).reduce((t,a)=>{ const m=(a.modality||'').toUpperCase(); const CH={XR:0.2,CT:1.1,US:0.5,MRI:1.4,MG:0.8,NM:2.5,PT:2.5,IR:4.0,RF:0.7,SC:0.6,OT:0.3,XA:0.8,ECG:0.2}; const ch=CH[m]||0.2; return t + Math.round(((a.allocated_rvus||0)/ch)); },0))"></span>
                    </span>
                  </div>
                  <span class="text-xs text-gray-500" x-text="open ? '▲' : '▼'"></span>
                </button>
                <div class="mt-1 text-[11px]" x-show="open" x-transition>
                  <template x-if="(doc.allocations||[]).length > 0">
                    <div class="space-y-0.5">
                      <template x-for="al in (doc.allocations || []).filter(a => (a.allocated_rvus||0) >= 0)" :key="al.facility_id + '-' + al.modality">
                        <div class="flex items-center justify-between">
                          <div class="truncate">
                            <span class="font-medium" x-text="al.facility_name || al.facility_id"></span>
                            <span class="text-gray-500" x-text="al.state ? ' ('+al.state+')' : ''"></span>
                            <span class="ml-1 inline-block text-[10px] px-1 py-0.5 rounded bg-blue-50 text-blue-700 border border-blue-200" x-text="al.modality"></span>
                          </div>
                          <div class="shrink-0 text-gray-800">
                            <span class="text-green-700 font-semibold" x-text="units==='rvus' 
                              ? (() => { const v=(al.allocated_rvus||0); return Math.abs(v) < 1 ? v.toFixed(3) : v.toFixed(1); })() 
                              : (() => { const m=(al.modality||'').toUpperCase(); const CH={XR:0.2,CT:1.1,US:0.5,MRI:1.4,MG:0.8,NM:2.5,PT:2.5,IR:4.0,RF:0.7,SC:0.6,OT:0.3,XA:0.8,ECG:0.2}; const ch=CH[m]||0.2; return Math.round(((al.allocated_rvus||0)/ch)); })()"></span>
                          </div>
                        </div>
                      </template>
                    </div>
                  </template>
                </div>
              </div>
            </template>
          </div>
        </template>
        <template x-if="!hourLoading && hourDetail && !(hourDetail.doctor_allocations||[]).length">
          <div class="text-xs text-gray-500">No doctors contributed RVUs for this hour.</div>
        </template>
        
        <!-- Facility/State/Modality breakdown moved below the doctor list -->
        <template x-if="!hourLoading && hourDetail && hourDetail.facilities">
          <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-2">
            <div>
              <h4 class="text-xs font-semibold text-gray-700 mb-1">By Facility</h4>
              <div class="max-h-36 overflow-y-auto space-y-1">
                <template x-for="f in hourDetail.facilities" :key="f.facility_id">
                  <div x-data="{ open: false }" class="text-xs bg-white border rounded">
                    <button @click="open = !open" class="w-full px-2 py-1 flex items-center justify-between" :title="(f.facility_name || f.facility_id) + (f.state ? ' ('+f.state+')' : '')">
                      <div class="truncate text-left">
                        <span class="font-medium" x-text="f.facility_name || f.facility_id" :title="f.facility_name || f.facility_id"></span>
                        <span class="text-gray-500" x-text="f.state ? ' ('+f.state+')' : ''" :title="f.state ? ('State: '+f.state) : ''"></span>
                      </div>
                      <div class="ml-2 shrink-0 flex items-center gap-2">
                        <span class="text-green-700 font-semibold" x-text="units==='rvus' 
                          ? (f.expected_rvus || 0).toFixed(1) 
                          : (()=>{ const CH={XR:0.2,CT:1.1,US:0.5,MRI:1.4,MG:0.8,NM:2.5,PT:2.5,IR:4.0,RF:0.7,SC:0.6,OT:0.3,XA:0.8,ECG:0.2}; const mods=(f.modalities||[]); return mods.reduce((t,md)=>{ const m=(md.modality||'').toUpperCase(); const ch=CH[m]||0.2; return t + Math.round(((md.expected_rvus||0)/ch)); },0); })()"></span>
                        <span class="text-gray-400">|</span>
                        <span :class="(() => { const sup=(hourDetail.doctor_allocations||[]).flatMap(d=>d.allocations||[]).filter(a=>a.facility_id===f.facility_id).reduce((s,a)=>s+(a.allocated_rvus||0),0); const pct=f.expected_rvus>0? (sup/f.expected_rvus*100):0; return pct<60?'text-red-600':(pct<90?'text-yellow-600':'text-green-700'); })()" x-text="(() => { const sup=(hourDetail.doctor_allocations||[]).flatMap(d=>d.allocations||[]).filter(a=>a.facility_id===f.facility_id).reduce((s,a)=>s+(a.allocated_rvus||0),0); return f.expected_rvus>0 ? ( (sup/f.expected_rvus*100).toFixed(1) + '%') : '—%'; })()"></span>
                      </div>
                    </button>
                    <div x-show="open" x-transition class="px-2 pb-2">
                      <template x-for="md in (f.modalities || [])" :key="md.modality">
                        <div class="flex items-center justify-between mt-1">
                          <span class="inline-block text-[10px] px-1.5 py-0.5 rounded bg-blue-50 text-blue-700 border border-blue-200" x-text="md.modality" :title="(md.modality || 'Unknown') + ' — ' + ((md.expected_rvus||0).toFixed(1)) + ' RVUs'"></span>
                          <div class="ml-2 shrink-0 flex items-center gap-2">
                            <span class="text-green-700 font-semibold" x-text="units==='rvus' 
                              ? (md.expected_rvus || 0).toFixed(1) 
                              : (()=>{ const m=(md.modality||'').toUpperCase(); const CH={XR:0.2,CT:1.1,US:0.5,MRI:1.4,MG:0.8,NM:2.5,PT:2.5,IR:4.0,RF:0.7,SC:0.6,OT:0.3,XA:0.8,ECG:0.2}; const ch=CH[m]||0.2; return Math.round(((md.expected_rvus||0)/ch)); })()"></span>
                            <span class="text-gray-400">|</span>
                            <span :class="(() => { const sup=(hourDetail.doctor_allocations||[]).flatMap(d=>d.allocations||[]).filter(a=>a.facility_id===f.facility_id && a.modality===md.modality).reduce((s,a)=>s+(a.allocated_rvus||0),0); const pct=md.expected_rvus>0? (sup/md.expected_rvus*100):0; return pct<60?'text-red-600':(pct<90?'text-yellow-600':'text-green-700'); })()" x-text="(() => { const sup=(hourDetail.doctor_allocations||[]).flatMap(d=>d.allocations||[]).filter(a=>a.facility_id===f.facility_id && a.modality===md.modality).reduce((s,a)=>s+(a.allocated_rvus||0),0); return md.expected_rvus>0 ? ( (sup/md.expected_rvus*100).toFixed(1) + '%') : '—%'; })()"></span>
                          </div>
                        </div>
                      </template>
                    </div>
                  </div>
                </template>
              </div>
            </div>

            <div>
              <h4 class="text-xs font-semibold text-gray-700 mb-1">By State</h4>
              <div class="max-h-36 overflow-y-auto space-y-1">
                <template x-for="s in hourDetail.by_state_merged" :key="s.state">
                  <div x-data="{ open: false }" class="text-xs bg-white border rounded">
                    <button @click="open = !open" class="w-full px-2 py-1 flex items-center justify-between" :title="(s.state || 'Unknown') + ' — ' + ((s.expected_rvus||0).toFixed(1)) + ' RVUs'">
                      <span class="truncate font-medium" x-text="s.state || 'Unknown'" :title="s.state || 'Unknown'"></span>
                      <div class="ml-2 shrink-0 flex items-center gap-2">
                        <span class="text-green-700 font-semibold" x-text="units==='rvus' 
                          ? (s.expected_rvus || 0).toFixed(1) 
                          : (()=>{ const CH={XR:0.2,CT:1.1,US:0.5,MRI:1.4,MG:0.8,NM:2.5,PT:2.5,IR:4.0,RF:0.7,SC:0.6,OT:0.3,XA:0.8,ECG:0.2}; const br=(hourDetail.state_breakdown[s.state]||[]); return br.reduce((t,md)=>{ const m=(md.modality||'').toUpperCase(); const ch=CH[m]||0.2; return t + Math.round(((md.expected_rvus||0)/ch)); },0); })()"></span>
                        <span class="text-gray-400">|</span>
                        <span :class="(() => { const sup=(hourDetail.doctor_allocations||[]).flatMap(d=>d.allocations||[]).filter(a=>a.state===s.state).reduce((t,a)=>t+(a.allocated_rvus||0),0); const pct=s.expected_rvus>0? (sup/s.expected_rvus*100):0; return pct<60?'text-red-600':(pct<90?'text-yellow-600':'text-green-700'); })()" x-text="(() => { const sup=(hourDetail.doctor_allocations||[]).flatMap(d=>d.allocations||[]).filter(a=>a.state===s.state).reduce((t,a)=>t+(a.allocated_rvus||0),0); return s.expected_rvus>0 ? ((sup/s.expected_rvus*100).toFixed(1)+'%') : '—%'; })()"></span>
                      </div>
                    </button>
                    <div x-show="open" x-transition class="px-2 pb-2">
                      <template x-for="md in (hourDetail.state_breakdown[s.state] || [])" :key="md.modality">
                        <div class="flex items-center justify-between mt-1">
                          <span class="inline-block text-[10px] px-1.5 py-0.5 rounded bg-blue-50 text-blue-700 border border-blue-200" x-text="md.modality || 'Unknown'" :title="(md.modality || 'Unknown') + ' — ' + ((md.expected_rvus||0).toFixed(1)) + ' RVUs'"></span>
                          <div class="ml-2 shrink-0 flex items-center gap-2">
                            <span class="text-green-700 font-semibold" x-text="units==='rvus' 
                              ? (md.expected_rvus || 0).toFixed(1) 
                              : (()=>{ const m=(md.modality||'').toUpperCase(); const CH={XR:0.2,CT:1.1,US:0.5,MRI:1.4,MG:0.8,NM:2.5,PT:2.5,IR:4.0,RF:0.7,SC:0.6,OT:0.3,XA:0.8,ECG:0.2}; const ch=CH[m]||0.2; return Math.round(((md.expected_rvus||0)/ch)); })()"></span>
                            <span class="text-gray-400">|</span>
                          <span :class="(() => { const sup=(hourDetail.doctor_allocations||[]).flatMap(d=>d.allocations||[]).filter(a=>a.state===s.state && a.modality===md.modality).reduce((t,a)=>t+(a.allocated_rvus||0),0); const pct=md.expected_rvus>0? (sup/md.expected_rvus*100):0; return pct<60?'text-red-600':(pct<90?'text-yellow-600':'text-green-700'); })()" x-text="(() => { const sup=(hourDetail.doctor_allocations||[]).flatMap(d=>d.allocations||[]).filter(a=>a.state===s.state && a.modality===md.modality).reduce((t,a)=>t+(a.allocated_rvus||0),0); return md.expected_rvus>0 ? ((sup/md.expected_rvus*100).toFixed(1)+'%') : '—%'; })()"></span>
                          </div>
                        </div>
                      </template>
                    </div>
                  </div>
                </template>
              </div>
            </div>

            <div>
              <h4 class="text-xs font-semibold text-gray-700 mb-1">By Modality</h4>
              <div class="max-h-36 overflow-y-auto space-y-1">
                <template x-for="m in hourDetail.by_modality" :key="m.modality">
                  <div x-data="{ open: false }" class="text-xs bg-white border rounded">
                    <button @click="open = !open" class="w-full px-2 py-1 flex items-center justify-between" :title="(m.modality || 'Unknown') + ' — ' + ((m.expected_rvus||0).toFixed(1)) + ' RVUs'">
                      <span class="inline-block text-[10px] px-1.5 py-0.5 rounded bg-blue-50 text-blue-700 border border-blue-200" x-text="m.modality || 'Unknown'" :title="m.modality || 'Unknown'"></span>
                      <div class="ml-2 shrink-0 flex items-center gap-2">
                        <span class="text-green-700 font-semibold" x-text="units==='rvus' 
                          ? (m.expected_rvus || 0).toFixed(1) 
                          : (()=>{ const m2=(m.modality||'').toUpperCase(); const CH={XR:0.2,CT:1.1,US:0.5,MRI:1.4,MG:0.8,NM:2.5,PT:2.5,IR:4.0,RF:0.7,SC:0.6,OT:0.3,XA:0.8,ECG:0.2}; const ch=CH[m2]||0.2; return Math.round(((m.expected_rvus||0)/ch)); })()"></span>
                        <span class="text-gray-400">|</span>
                        <span :class="(() => { const sup=(hourDetail.doctor_allocations||[]).flatMap(d=>d.allocations||[]).filter(a=>a.modality===m.modality).reduce((t,a)=>t+(a.allocated_rvus||0),0); const pct=m.expected_rvus>0? (sup/m.expected_rvus*100):0; return pct<60?'text-red-600':(pct<90?'text-yellow-600':'text-green-700'); })()" x-text="(() => { const sup=(hourDetail.doctor_allocations||[]).flatMap(d=>d.allocations||[]).filter(a=>a.modality===m.modality).reduce((t,a)=>t+(a.allocated_rvus||0),0); return m.expected_rvus>0 ? ((sup/m.expected_rvus*100).toFixed(1)+'%') : '—%'; })()"></span>
                      </div>
                    </button>
                    <div x-show="open" x-transition class="px-2 pb-2">
                      <template x-for="st in (hourDetail.modality_breakdown[m.modality] || [])" :key="st.state">
                        <div class="flex items-center justify-between mt-1">
                          <span class="font-medium" x-text="st.state || 'Unknown'" :title="st.state || 'Unknown'"></span>
                          <div class="ml-2 shrink-0 flex items-center gap-2">
                            <span class="text-green-700 font-semibold" x-text="units==='rvus' 
                              ? (st.expected_rvus || 0).toFixed(1) 
                              : (()=>{ const m3=(m.modality||'').toUpperCase(); const CH={XR:0.2,CT:1.1,US:0.5,MRI:1.4,MG:0.8,NM:2.5,PT:2.5,IR:4.0,RF:0.7,SC:0.6,OT:0.3,XA:0.8,ECG:0.2}; const ch=CH[m3]||0.2; return Math.round(((st.expected_rvus||0)/ch)); })()"></span>
                            <span class="text-gray-400">|</span>
                          <span :class="(() => { const sup=(hourDetail.doctor_allocations||[]).flatMap(d=>d.allocations||[]).filter(a=>a.modality===m.modality && a.state===st.state).reduce((t,a)=>t+(a.allocated_rvus||0),0); const pct=st.expected_rvus>0? (sup/st.expected_rvus*100):0; return pct<60?'text-red-600':(pct<90?'text-yellow-600':'text-green-700'); })()" x-text="(() => { const sup=(hourDetail.doctor_allocations||[]).flatMap(d=>d.allocations||[]).filter(a=>a.modality===m.modality && a.state===st.state).reduce((t,a)=>t+(a.allocated_rvus||0),0); return st.expected_rvus>0 ? ((sup/st.expected_rvus*100).toFixed(1)+'%') : '—%'; })()"></span>
                          </div>
                        </div>
                      </template>
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </template>
        <template x-if="!hourLoading && hourDetail && (!hourDetail.facilities || hourDetail.facilities.length === 0)">
          <div class="mt-3 text-xs text-gray-500">
            No facility-level demand records were found for the expected prior-week hour.
          </div>
        </template>
        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-xs font-semibold text-gray-700 mb-1" for="state-search">Check State Coverage:</label>
<div x-data="{ stateQueryModal: '', matchedStatesModal: [] }">
  <input
      id="state-search"
      type="text"
      x-model="stateQueryModal"
      placeholder="Enter state name"
      class="w-full px-2 py-1 border rounded text-sm mb-2"
      @input="
          let q = stateQueryModal.trim().toLowerCase();
          matchedStatesModal = q ? [...coveredStates, ...uncoveredStates].filter(s => s.toLowerCase().includes(q)) : [];
          hoveredState = '';
      "
  >

  <div class="flex flex-wrap gap-1 mt-2">
    <template x-for="state in matchedStatesModal.slice(0, 5)" :key="state">
      <div x-data="{ open: false }" class="w-full">
        <button
          @click="open = !open"
          class="w-full text-left px-2 py-1 pl-2 rounded text-xs font-semibold transition"
          :class="coveredStates.includes(state) ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'"
        >
          <span x-text="state"></span>
        </button>

        <ul x-show="open" x-transition class="ml-1 mt-1 space-y-1 text-xs text-gray-800">
          <template x-for="doc in stateDoctorMap[state]" :key="doc">
            <li class="pl-1" x-text="doc"></li>
          </template>
        </ul>
      </div>
    </template>
  </div>
</div>

                <div class="flex flex-wrap gap-1">
                    <template x-for="state in matchedStates.slice(0, 30)" :key="state">

                      <span
                        class="inline-block px-2 py-0.5 rounded text-xs font-semibold cursor-pointer transition relative group"
                        :class="coveredStates.includes(state) ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'"
                      >
                        <span x-text="state"></span>
                        <span
                          class="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-max bg-white border border-gray-300 rounded shadow-lg px-3 py-2 text-xs text-gray-900 opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity z-50 whitespace-nowrap"
                        >
                          <template x-for="doc in stateDoctorMap[state]" :key="doc">
                            <span class="block" x-text="doc"></span>
                          </template>
                        </span>
                      </span>
                    </template>
                </div>
            </div>
        
            <div>
                <label class="block text-xs font-semibold text-gray-700 mb-1" for="facility-search">Check Facility Coverage:</label>
                <input
                    id="facility-search"
                    type="text"
                    x-model="facilityQuery"
                    placeholder="Enter facility name"
                    class="w-full px-2 py-1 border rounded text-sm mb-2"
                    @input="
                        let fq = facilityQuery.trim().toLowerCase();
                        matchedFacilities = fq ? Object.keys(facilityDoctorMap).filter(f => f.toLowerCase().includes(fq)) : [];
                        hoveredFacility = '';
                    "
                >
                <div class="flex flex-wrap gap-1">
<template x-for="fac in matchedFacilities.slice(0, 5)" :key="fac">
  <div x-data="{ open: false }" class="w-full">
    <button
      @click="open = !open"
      class="w-full text-left px-2 py-1 pl-2 rounded text-xs font-semibold transition"
      :class="facilityDoctorMap[fac] && facilityDoctorMap[fac].length > 0 
                ? 'bg-green-100 text-green-700' 
                : 'bg-red-100 text-red-700'"
    >
      <span x-text="fac"></span>
    </button>

    <ul x-show="open" x-transition class="ml-2 mt-1 space-y-1 text-xs text-gray-800">
      <template x-for="doc in facilityDoctorMap[fac]" :key="doc">
        <li class="pl-0" x-text="doc"></li>
      </template>
    </ul>
  </div>
</template>



                      </span>
                    </template>
                </div>
            </div>
        </div>
        
        <div class="text-xs text-gray-400 mt-2">
    
        </div>
        
          
</div>
</div>
</div>
</div>


<script>
    let currentCalendarDate = new Date('{{ now.strftime("%Y-%m-%d") }}');
    
    function toggleCalendar() {
      const popup = document.getElementById('calendarPopup');
      if (popup.classList.contains('hidden')) {
        popup.classList.remove('hidden');
        renderCalendar();
      } else {
        popup.classList.add('hidden');
      }
    }

    function closeCalendar() {
      document.getElementById('calendarPopup').classList.add('hidden');
    }

    function changeMonth(direction) {
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
      renderCalendar();
    }
    
    function selectDate(year, month, day) {
        const date = new Date(year, month, day);
        const dateString = date.toISOString().split('T')[0];
        window.location.href = `{{ url_for('shifts.shifts') }}?date=${dateString}`;
    }

    function selectToday() {
        const today = new Date();
        const dateString = today.toISOString().split('T')[0];
        window.location.href = `{{ url_for('shifts.shifts') }}?date=${dateString}`;
    }

    function renderCalendar() {
      const monthNames = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
      ];
      const year = currentCalendarDate.getFullYear();
      const month = currentCalendarDate.getMonth();
      document.getElementById('calendarMonth').textContent = monthNames[month];
      document.getElementById('calendarYear').textContent = year;

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDate = new Date(firstDay);
      startDate.setDate(startDate.getDate() - firstDay.getDay());

      const calendarDays = document.getElementById('calendarDays');
      calendarDays.innerHTML = '';
      const today = new Date();
      
      const currentWeekStart = new Date('{{ start_date }}');
      const currentWeekEnd = new Date('{{ end_date }}');

      for (let i = 0; i < 42; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        const dayElement = document.createElement('button');
        dayElement.type = 'button';
        dayElement.className = 'w-8 h-8 text-sm rounded-lg transition-colors hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-500';
        dayElement.textContent = date.getDate();
        dayElement.onclick = () => selectDate(date.getFullYear(), date.getMonth(), date.getDate());
        calendarDays.appendChild(dayElement);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const sortButton = document.getElementById('hour-sort-toggle');
      const sortMetricSelect = document.getElementById('sort-metric-select');

      if (!sortButton) {
        document.body.classList.remove('hour-sort-initializing');
        document.body.classList.add('hour-sort-ready');
        return;
      }

      let sortDescending = false;
      let sortMetric = sortMetricSelect ? sortMetricSelect.value || 'capacity' : 'capacity';

      const markSortReady = () => {
        document.body.classList.remove('hour-sort-initializing');
        document.body.classList.add('hour-sort-ready');
      };

      const updateButtonLabel = () => {
        sortButton.textContent = sortDescending ? 'Direction: Descending' : 'Direction: Ascending';
      };

      const parseSortTime = (value) => {
        const parsed = Date.parse(value);
        return Number.isNaN(parsed) ? null : parsed;
      };

      const parseCapacityRatio = (value) => {
        if (value === null || value === undefined || value === '') {
          return null;
        }
        const parsed = Number.parseFloat(value);
        return Number.isNaN(parsed) ? null : parsed;
      };

      const getSortValue = (wrapper, metric) => {
        const fallbackValue = sortDescending ? Number.NEGATIVE_INFINITY : Number.POSITIVE_INFINITY;

        if (metric === 'capacity') {
          const ratio = parseCapacityRatio(wrapper.getAttribute('data-capacity-ratio'));
          return ratio === null ? fallbackValue : ratio;
        }

        const time = parseSortTime(wrapper.getAttribute('data-sort-time'));
        return time === null ? fallbackValue : time;
      };

      const sortHourTiles = () => {
        document.body.classList.add('hour-sort-active');

        document.querySelectorAll('.shifts-day-body').forEach(dayBody => {
          const wrappers = Array.from(dayBody.querySelectorAll('.relative.group[data-sort-time]'));
          if (!wrappers.length) {
            return;
          }

          wrappers.sort((a, b) => {
            const valueA = getSortValue(a, sortMetric);
            const valueB = getSortValue(b, sortMetric);
            return sortDescending ? valueB - valueA : valueA - valueB;
          });

          let sortedContainer = dayBody.querySelector('.sorted-hour-container');
          if (!sortedContainer) {
            sortedContainer = document.createElement('div');
            sortedContainer.className = 'sorted-hour-container space-y-2';
            dayBody.appendChild(sortedContainer);
          }

          sortedContainer.innerHTML = '';
          wrappers.forEach(wrapper => {
            sortedContainer.appendChild(wrapper);
          });
        });

        window.requestAnimationFrame(() => {
          document.dispatchEvent(new CustomEvent('shifts:refreshFilters'));
          markSortReady();
        });
      };

      sortButton.addEventListener('click', () => {
        sortDescending = !sortDescending;
        updateButtonLabel();
        sortHourTiles();
      });

      if (sortMetricSelect) {
        sortMetricSelect.addEventListener('change', (event) => {
          sortMetric = event.target.value;
          sortHourTiles();
        });
      }

      updateButtonLabel();
      sortHourTiles();
    });

    document.addEventListener('DOMContentLoaded', function() {
        document.addEventListener('click', function(event) {
            const calendarPopup = document.getElementById('calendarPopup');
            const dateButton = event.target.closest('button[onclick="toggleCalendar()"]');
            if (!calendarPopup.contains(event.target) && !dateButton) {
                calendarPopup.classList.add('hidden');
            }
        });
    });


  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }
</script>
{# closes Alpine scope #}
{% endblock %}
