{% extends "layout.html" %}
{% block title %}Shifts Needing Attention{% endblock %}

{% block content %}
<div x-data="{ show: false, doctors: [], time: '', uncoveredStates: [], coveredStates: [], stateDoctorMap: {}, stateQuery: '', matchedStates: [], hoveredState: '' }">

<h1 class="text-3xl font-bold text-gray-800 mb-6">Shifts Needing Attention - Week of {{ start_date }} to {{ end_date }}</h1>

{# Filter Controls #}
<div x-data="{ 
    showRed: true, 
    showYellow: true, 
    showGreen: true,
    updateFilters() {
        document.querySelectorAll('.capacity-section').forEach(section => {
            const isRed = section.classList.contains('bg-red-100');
            const isYellow = section.classList.contains('bg-yellow-100');
            const isGreen = section.classList.contains('bg-green-100');
            
            if ((isRed && !this.showRed) || 
                (isYellow && !this.showYellow) || 
                (isGreen && !this.showGreen)) {
                section.style.display = 'none';
            } else {
                section.style.display = 'block';
            }
        });
    }
}" class="mb-6 p-4 bg-white rounded-lg shadow-sm border border-gray-200">
    <div class="flex items-center space-x-6">
        <span class="text-sm font-medium text-gray-700">Show Sections:</span>
        <div class="flex items-center space-x-4">
            <label class="inline-flex items-center">
                <input type="checkbox" class="form-checkbox h-4 w-4 text-red-600" checked x-model="showRed" @change="updateFilters()">
                <span class="ml-2 text-sm text-gray-700">Below 60% Capacity</span>
            </label>
            <label class="inline-flex items-center">
                <input type="checkbox" class="form-checkbox h-4 w-4 text-yellow-500" checked x-model="showYellow" @change="updateFilters()">
                <span class="ml-2 text-sm text-gray-700">60-90% Capacity</span>
            </label>
            <label class="inline-flex items-center">
                <input type="checkbox" class="form-checkbox h-4 w-4 text-green-600" checked x-model="showGreen" @change="updateFilters()">
                <span class="ml-2 text-sm text-gray-700">Above 90% Capacity</span>
            </label>
        </div>
    </div>
</div>

<div class="overflow-x-auto">
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 xl:grid-cols-7 gap-4">
        {% for day, color_grouped_slots in weekly_data_by_day_and_color.items() %}
            <div class="flex flex-col min-w-0">
                {% set first_color_group = color_grouped_slots.values() | first %}
                {% set first_slot_of_day = first_color_group | first if first_color_group %}
                {% if first_slot_of_day %}
                    <div class="bg-gray-200 p-4 rounded-t-lg text-center">
                        <h2 class="text-base md:text-xl font-semibold text-gray-700">{{ first_slot_of_day.day_label }}</h2>
                        <p class="text-xs md:text-sm text-gray-600">{{ day.strftime("%Y-%m-%d") }}</p>
                    </div>
                {% endif %}

                <div class="flex-1 bg-white rounded-b-lg border border-gray-200 p-2 md:p-4">
                    {% for color_class, slots_in_color_group in color_grouped_slots.items() %}
                        <div class="mb-4 capacity-section {{ color_class }} rounded-lg p-2">
                            <h3 class="text-xs md:text-sm font-semibold text-gray-700 mb-2">
                                {% if color_class == 'bg-red-100' %}
                                {% elif color_class == 'bg-yellow-100' %}
                                {% elif color_class == 'bg-green-100' %}
                                {% else %}
                                    No RVU Data
                                {% endif %}
                            </h3>
                            <div class="space-y-2">
                                {% for slot in slots_in_color_group %}
                                    {% set stats = hourly_rvu_stats[slot.datetime] %}
                                    {% set current = stats['current'] if stats else None %}
                                    {% set expected = stats['historical'] if stats else None %}
                                    {% set ratio = (current / expected) if current is not none and expected and expected > 0 else None %}
                                    {% set slot_doctors = doctors_by_hour.get(slot.datetime, []) %}
                                    {% set modal_doctors = [] %}
                                    {% for doc in slot_doctors %}
                                    {% set _ = modal_doctors.append({'name': doc.name | trim, 'url': url_for('doctors.doctor_profile', rad_id=doc.id)}) %}

                                    {% endfor %}
                                    {% set slot_key = slot.datetime.isoformat() %}
                                    {% set uncovered_states = uncovered_states_by_hour.get(slot.datetime.isoformat(), []) %}
                                    {% set covered_states = covered_states_by_hour.get(slot.datetime.isoformat(), []) %}
                                    
                                    {% set state_doctor_map = state_doctor_map_by_hour.get(slot_key, {}) %}


                                    <div 
                                    @click="
                                        show = true;
                                        doctors = JSON.parse($el.getAttribute('data-doctors'));
                                        time = '{{ slot.label }}';
                                        uncoveredStates = JSON.parse($el.getAttribute('data-uncovered-states'));
                                        coveredStates = JSON.parse($el.getAttribute('data-covered-states'));
                                        const rawMap = $el.getAttribute('data-state-doctor-map');
                                        stateDoctorMap = JSON.parse(rawMap);
                                        stateQuery = '';
                                        matchedStates = [];
                                        hoveredState = '';
                                    "
                                    
                                        data-doctors='{{ modal_doctors | tojson | escape }}'
                                        data-uncovered-states='{{ uncovered_states | tojson | escape }}'
                                        data-covered-states='{{ covered_states | tojson | escape }}'
                                        data-state-doctor-map='{{ state_doctor_map | tojson | escape }}'
                                        class="group rounded-md p-2 md:p-3 shadow-sm border border-gray-300 {{ color_class }} relative cursor-pointer"
                                        style="background-color: inherit; min-width: 0;"
                                    >
                                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-1 md:gap-0">
                                            <h4 class="text-xs md:text-sm font-semibold text-gray-800">
                                                <span>{{ slot.label }}</span>
                                            </h4>
                                            <span class="flex flex-wrap items-center text-xs text-gray-700 relative gap-x-1 gap-y-0.5 md:gap-x-2" style="min-width:0;">
                                                <span class="text-blue-700 font-semibold">
                                                    {{ (current | round(1)) if current is not none else '—' }}
                                                </span>
                                                <span class="text-gray-400">vs</span>
                                                <span class="text-green-700 font-semibold">
                                                    {{ (expected | round(1)) if expected is not none else '—' }}
                                                </span>
                                                {% if ratio is not none %}
                            
                                                    <span class="text-xs font-semibold text-gray-800">({{ (ratio * 100) | round(1) }}%)</span>
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<!-- Modal -->
<div 
     x-show="show"
     @close-modal.window="show = false"
     class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
     x-transition
     style="display: none;"
>
    <div @click.away="show = false" class="bg-white rounded-lg p-6 w-[48rem] shadow-xl">
        <h2 class="text-lg font-semibold mb-2 text-gray-800">Scheduled Doctors</h2>
        <p class="text-sm text-gray-500 mb-4" x-text="time"></p>
        <ul class="space-y-1 max-h-60 overflow-y-auto">
            <template x-for="doc in doctors" :key="doc.url">
                <li :class="hoveredState && stateDoctorMap[hoveredState]?.some(n => n.trim().toLowerCase() === doc.name.trim().toLowerCase()) ? 'bg-green-100 font-bold' : ''">
                    <a :href="doc.url" target="_blank" class="text-blue-700 hover:underline font-medium">
                        <span x-text="doc.name"></span>
                    </a>
                </li>
            </template>
        </ul>
        <div class="mt-4">
            <label class="block text-xs font-semibold text-gray-700 mb-1" for="state-search">Check State Coverage:</label>
            <input
                id="state-search"
                type="text"
                x-model="stateQuery"
                placeholder="Enter state name (e.g. Texas)"
                class="w-full px-2 py-1 border rounded text-sm mb-2"
                @input="
                    let q = stateQuery.trim().toLowerCase();
                    matchedStates = q ? [...coveredStates, ...uncoveredStates].filter(s => s.toLowerCase().includes(q)) : [];
                    hoveredState = '';
                "
            >
            <div class="flex flex-wrap gap-1">
                <template x-for="state in matchedStates" :key="state">
                  <span
                    class="inline-block px-2 py-0.5 rounded text-xs font-semibold cursor-pointer transition relative group"
                    :class="coveredStates.includes(state) ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'"
                  >
                    <span x-text="state"></span>
                    <span
                      class="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-max bg-white border border-gray-300 rounded shadow-lg px-3 py-2 text-xs text-gray-900 opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity z-50 whitespace-nowrap"
                    >

                      <template x-for="doc in stateDoctorMap[state]" :key="doc">
                        <span class="block" x-text="doc"></span>
                      </template>
                    </span>
                  </span>
                </template>
            </div>
        </div>
        <div class="text-xs text-gray-400 mt-2">
    
        </div>
        <button @click="show = false" class="mt-4 px-3 py-1 bg-gray-200 hover:bg-gray-300 text-sm rounded">
            Close
        </button>
    </div>
</div>

</div> {# closes Alpine scope #}
{% endblock %}
