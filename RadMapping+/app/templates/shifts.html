{# RadMapping+/app/templates/shifts.html #}

{% extends "layout.html" %}
{% block title %}Shifts Needing Attention{% endblock %}

{% block content %}

<h1 class="text-3xl font-bold text-gray-800 mb-6">Shifts Needing Attention - Week of {{ start_date }} to {{ end_date }}</h1>

{# Filter Controls #}
<div x-data="{ 
    showRed: true, 
    showYellow: true, 
    showGreen: true,
    updateFilters() {
        document.querySelectorAll('.capacity-section').forEach(section => {
            const isRed = section.classList.contains('bg-red-100');
            const isYellow = section.classList.contains('bg-yellow-100');
            const isGreen = section.classList.contains('bg-green-100');
            
            if ((isRed && !this.showRed) || 
                (isYellow && !this.showYellow) || 
                (isGreen && !this.showGreen)) {
                section.style.display = 'none';
            } else {
                section.style.display = 'block';
            }
        });
    }
}" class="mb-6 p-4 bg-white rounded-lg shadow-sm border border-gray-200">
    <div class="flex items-center space-x-6">
        <span class="text-sm font-medium text-gray-700">Show Sections:</span>
        <div class="flex items-center space-x-4">
            <label class="inline-flex items-center">
                <input type="checkbox" class="form-checkbox h-4 w-4 text-red-600" checked x-model="showRed" @change="updateFilters()">
                <span class="ml-2 text-sm text-gray-700">Below 60% Capacity</span>
            </label>
            <label class="inline-flex items-center">
                <input type="checkbox" class="form-checkbox h-4 w-4 text-yellow-500" checked x-model="showYellow" @change="updateFilters()">
                <span class="ml-2 text-sm text-gray-700">60-90% Capacity</span>
            </label>
            <label class="inline-flex items-center">
                <input type="checkbox" class="form-checkbox h-4 w-4 text-green-600" checked x-model="showGreen" @change="updateFilters()">
                <span class="ml-2 text-sm text-gray-700">Above 90% Capacity</span>
            </label>
        </div>
    </div>
</div>

<div class="overflow-x-auto">
    <div class="grid grid-cols-7 gap-4 min-w-[1400px]">
        {% for day, color_grouped_slots in weekly_data_by_day_and_color.items() %}
            <div class="flex flex-col">
                {# Day Header #}
                {% set first_color_group = color_grouped_slots.values() | first %}
                {% set first_slot_of_day = first_color_group | first if first_color_group %}
                {% if first_slot_of_day %}
                    <div class="bg-gray-200 p-4 rounded-t-lg">
                        <h2 class="text-xl font-semibold text-gray-700">{{ first_slot_of_day.day_label }}</h2>
                        <p class="text-sm text-gray-600">{{ day.strftime("%Y-%m-%d") }}</p>
                    </div>
                {% endif %}

                {# Color Groups #}
                <div class="flex-1 bg-white rounded-b-lg border border-gray-200 p-4">
                    {% for color_class, slots_in_color_group in color_grouped_slots.items() %}
                        <div class="mb-4 capacity-section {{ color_class }} rounded-lg p-2">
                            <h3 class="text-sm font-semibold text-gray-700 mb-2">
                                {% if color_class == 'bg-red-100' %}
                                    Below 60% of Expected Capacity
                                {% elif color_class == 'bg-yellow-100' %}
                                    60% to 90% of Expected Capacity
                                {% elif color_class == 'bg-green-100' %}
                                    Above 90% of Expected Capacity
                                {% else %}
                                    No RVU Data
                                {% endif %}
                            </h3>
                            <div class="space-y-2">
                                {% for slot in slots_in_color_group %}
                                    {% set stats = hourly_rvu_stats[slot.datetime] %}
                                    {% set current = stats['current'] if stats else None %}
                                    {% set expected = stats['historical'] if stats else None %}
                                    {% set ratio = (current / expected) if current is not none and expected and expected > 0 else None %}

                                    <div class="rounded-md p-3 shadow-sm border border-gray-300 {{ color_class }}" x-data="{ open: false }" style="background-color: inherit;">
                                        <div class="flex items-center justify-between cursor-pointer" @click="open = !open">
                                            <h4 class="text-sm font-semibold text-gray-800">
                                                <span>{{ slot.label }}</span>
                                            </h4>
                                            <span class="flex items-center text-xs text-gray-700 relative" style="gap: 0.25rem;">
                                                <span class="relative group">
                                                    <span class="text-blue-700 font-semibold">
                                                        {{ (current | round(1)) if current is not none else '—' }}
                                                    </span>
                                                    <span class="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-max bg-white border border-gray-300 rounded shadow-lg px-3 py-2 text-xs text-blue-700 opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity z-50 whitespace-nowrap">
                                                        Hourly RVU Sum
                                                    </span>
                                                </span>
                                                <span class="mx-1 text-gray-400">vs</span>
                                                <span class="relative group">
                                                    <span class="text-green-700 font-semibold">
                                                        {{ (expected | round(1)) if expected is not none else '—' }}
                                                    </span>
                                                    <span class="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-max bg-white border border-gray-300 rounded shadow-lg px-3 py-2 text-xs text-green-700 opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity z-50 whitespace-nowrap">
                                                        Expected Capacity In RVU
                                                    </span>
                                                </span>
                                                <span class="ml-2 transform transition-transform" :class="{ 'rotate-180': open }">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                                                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                                    </svg>
                                                </span>
                                            </span>
                                        </div>

                                        <div x-show="open" x-collapse>
                                            {% set slot_doctors = doctors_by_hour.get(slot.datetime, []) %}
                                            {% if slot_doctors %}
                                                <ul class="space-y-1 mt-2">
                                                    {% for doc in slot_doctors %}
                                                        <li class="text-xs text-gray-700 relative border p-2 rounded bg-gray-50 hover:bg-gray-100 transition-colors duration-200"
                                                            onmouseenter="showDoctorPopup(this)"
                                                            onmouseleave="hideDoctorPopup(this)">
                                                            <a href="{{ url_for('doctors.doctor_profile', rad_id=doc.id) }}" target="_blank" class="text-blue-700 font-semibold hover:underline">
                                                                {{ doc.name }}
                                                            </a>
                                                            ({% if doc.start_dt.date() == slot.datetime.date() %}{{ doc.start_time | ampm }}{% else %}Prev Day{% endif %} - {% if doc.end_dt.date() == slot.datetime.date() %}{{ doc.end_time | ampm }}{% else %}Next Day{% endif %})

                                                            <div class="doctor-popup absolute left-full top-0 ml-2 w-[20rem] bg-white border p-4 rounded-lg shadow-lg text-left pointer-events-none opacity-0 transition-all duration-200 z-50 transform scale-95">
                                                                <h4 class="font-medium text-lg text-gray-900 mb-2">{{ doc.name }}</h4>
                                                                <div class="space-y-2">
                                                                    <p class="text-sm"><span class="font-medium">Phone:</span> <span class="text-gray-700">{{ doc.phone or 'N/A' }}</span></p>
                                                                    <p class="text-sm"><span class="font-medium">Email:</span> <span class="text-gray-700">{{ doc.email or 'N/A' }}</span></p>
                                                                    <p class="text-sm"><span class="font-medium">PACS:</span> <span class="text-gray-700">{{ doc.pacs or 'N/A' }}</span></p>
                                                                    {% if doc.modalities %}
                                                                        <p class="text-sm"><span class="font-medium">Modalities:</span> <span class="text-gray-700">{{ doc.modalities }}</span></p>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                            {% else %}
                                                <p class="text-xs italic text-gray-400 mt-2">No doctors scheduled.</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<script>
function showDoctorPopup(parent) {
    const popup = parent.querySelector('.doctor-popup');
    if (popup) {
        const rect = parent.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        
        // Check if popup would go off screen to the right
        if (rect.right + 340 > viewportWidth) {  // 340 = popup width (320) + margin (20)
            popup.style.left = 'auto';
            popup.style.right = '100%';
            popup.style.marginLeft = '0';
            popup.style.marginRight = '0.5rem';
        } else {
            // Position to the right
            popup.style.left = '100%';
            popup.style.right = 'auto';
            popup.style.marginLeft = '0.5rem';
            popup.style.marginRight = '0';
        }
        // Vertical positioning - align top of popup with top of list item
        popup.style.top = '0';

        popup.classList.remove('opacity-0', 'scale-95');
        popup.classList.add('opacity-100', 'scale-100');
    }
}

function hideDoctorPopup(parent) {
    const popup = parent.querySelector('.doctor-popup');
    if (popup) {
        popup.classList.remove('opacity-100', 'scale-100');
        popup.classList.add('opacity-0', 'scale-95');
    }
}
</script>

{% endblock %} 