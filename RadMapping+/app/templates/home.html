{% extends "layout.html" %}
{% block title %}Daily Schedule{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-sm p-4 sm:p-6 mb-6 w-full">
  <div class="flex flex-col md:flex-row items-center justify-between gap-4">
    <!-- Date Navigation -->
    <div class="flex items-center gap-4">
      <a href="{{ url_for('dashboard.home') }}?date={{ prev_date }}" 
         class="p-2 hover:bg-gray-100 rounded-full transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </a>
      
      <form method="get" action="{{ url_for('dashboard.home') }}" class="flex items-center gap-4">
        <button
          type="button"
          class="flex items-center gap-2 bg-blue-50 hover:bg-blue-100 text-blue-700 px-4 py-2 rounded-lg transition-colors"
          onclick="document.getElementById('date-picker').showPicker()"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          <span class="font-medium">{{ today }}</span>
        </button>
        <input
          type="date"
          name="date"
          id="date-picker"
          value="{{ today }}"
          onchange="this.form.submit()"
          class="hidden"
        />
        
        <!-- Timezone Selector -->
        <select 
          name="timezone" 
          onchange="this.form.submit()"
          class="bg-gray-50 border border-gray-200 text-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        >
          <option value="EST" {% if selected_timezone == 'EST' %}selected{% endif %}>Eastern Time (EST)</option>
          <option value="CST" {% if selected_timezone == 'CST' %}selected{% endif %}>Central Time (CST)</option>
          <option value="PST" {% if selected_timezone == 'PST' %}selected{% endif %}>Pacific Time (PST)</option>
          <option value="UTC" {% if selected_timezone == 'UTC' %}selected{% endif %}>UTC</option>
        </select>
      </form>

      <a href="{{ url_for('dashboard.home') }}?date={{ next_date }}" 
         class="p-2 hover:bg-gray-100 rounded-full transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </a>
    </div>

    <!-- Timezone Display -->
    <div class="flex flex-wrap gap-2 sm:gap-3 w-full md:w-auto">
      {% for zone in ["EST", "CST", "PST", "UTC"] %}
        <div class="bg-gray-50 hover:bg-gray-100 border border-gray-200 rounded-lg px-3 sm:px-4 py-2 shadow-sm relative timezone-tile transition-colors"
             onmouseenter="showTimezonePopup(this)"
             onmouseleave="hideTimezonePopup(this)">
          <div class="flex items-center gap-2">
            <span class="text-sm font-medium text-gray-700">{{ zone }}</span>
            <span id="tz-{{ zone|lower }}" class="text-sm text-gray-600">...</span>
          </div>
          <div class="timezone-popup fixed z-10 mt-2 bg-white border rounded-lg shadow-lg p-4 text-left w-64 sm:w-72 opacity-0 transition-all duration-200 pointer-events-auto transform scale-95"
               style="left: 50%; transform: translateX(-50%) scale(0.95);">
            <h5 class="font-medium text-gray-900 mb-3">Doctors in {{ zone }}</h5>
            {% set tz_docs = doctors_by_timezone.get(zone, []) %}
            {% if tz_docs %}
              <ul class="space-y-2 max-h-60 overflow-y-auto">
                {% for doc in tz_docs %}
                <li class="text-sm">
                  <a href="{{ url_for('dashboard.doctor_profile', rad_id=doc.id) }}" target="_blank" class="hover:underline text-blue-700 font-medium">
                    {{ doc.name }}
                  </a>
                  {% if doc.id in doctors_currently_on_shift_ids %}
                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full ml-2">On shift now</span>
                  {% elif doc.id in doctors_on_shift_ids %}
                    <span class="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full ml-2">Scheduled Today</span>
                  {% endif %}
                </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-sm italic text-gray-500">No doctors in this timezone.</p>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Daily Schedule -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
  {% for hour in range(0, 24) %}
    {% set ampm_label = '%02d:00 %s' % (((hour - 1) % 12 + 1), 'AM' if hour < 12 else 'PM') %}
    <div id="hour-{{ hour }}" class="bg-white border rounded shadow p-4">
      <h4 class="text-md font-semibold text-blue-800 border-b pb-1 mb-2">
        {{ ampm_label }}
        {% if selected_timezone != 'UTC' %}
          <span class="text-sm text-gray-500 ml-2">({{ (hour - timezone_offset)|int }}:00 {{ selected_timezone }})</span>
        {% endif %}
      </h4>
      {% if doctors_by_hour[hour] %}
        <ul class="space-y-2">
          {% for doc in doctors_by_hour[hour] %}
            <li class="relative border p-2 rounded bg-gray-50 hover:bg-gray-100 transition-colors duration-200"
                onmouseenter="showDoctorPopup(this)"
                onmouseleave="hideDoctorPopup(this)">
              <div class="flex items-center justify-between">
                <a href="{{ url_for('dashboard.doctor_profile', rad_id=doc.id) }}" class="text-blue-700 font-semibold hover:underline">
                  {{ doc.name }}
                </a>
                <span class="text-sm text-gray-500">{{ doc.timezone or '—' }}</span>
              </div>
              <div class="text-sm text-gray-600 mt-1">
                Shift: {{ doc.start_time | ampm }} – {{ doc.end_time | ampm }}
                {% if selected_timezone != doc.timezone %}
                  <span class="text-gray-500">({{ doc.start_time | convert_timezone(selected_timezone) }} – {{ doc.end_time | convert_timezone(selected_timezone) }})</span>
                {% endif %}
              </div>
              <div class="text-sm text-gray-500 mt-1">
                {% if doc.modalities %}
                  <span class="mr-2">Modalities: {{ doc.modalities }}</span>
                {% endif %}
                {% if doc.pacs %}
                  <span>PACS: {{ doc.pacs }}</span>
                {% endif %}
              </div>

              <!-- Doctor Hover Popup -->
              <div class="doctor-popup absolute left-full top-0 ml-2 w-[20rem] bg-white border p-4 rounded-lg shadow-lg text-left pointer-events-none opacity-0 transition-all duration-200 z-50 transform scale-95">
                <h4 class="font-medium text-lg text-gray-900 mb-2">{{ doc.name }}</h4>
                <div class="space-y-2">
                  <p class="text-sm"><span class="font-medium">Timezone:</span> <span class="text-gray-700">{{ doc.timezone or 'N/A' }}</span></p>
                  <p class="text-sm"><span class="font-medium">Modalities:</span> <span class="text-gray-700">{{ doc.modalities or 'N/A' }}</span></p>
                  <p class="text-sm"><span class="font-medium">PACS:</span> <span class="text-gray-700">{{ doc.pacs or 'N/A' }}</span></p>
                  <p class="text-sm"><span class="font-medium">Contact:</span> <span class="text-gray-700">{{ doc.email or 'N/A' }}</span></p>
                  <p class="text-sm"><span class="font-medium">Phone:</span> <span class="text-gray-700">{{ doc.phone or 'N/A' }}</span></p>
                  {% if doc.schedule_info_est %}
                    <p class="text-sm"><span class="font-medium">Schedule Info:</span> <span class="text-gray-700">{{ doc.schedule_info_est }}</span></p>
                  {% endif %}
                </div>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-sm italic text-gray-400">No doctors on shift.</p>
      {% endif %}
    </div>
  {% endfor %}
</div>

<script>
  function showTimezonePopup(parent) {
    const popup = parent.querySelector('.timezone-popup');
    if (popup) {
      const rect = parent.getBoundingClientRect();
      popup.style.left = `${rect.left + (rect.width / 2)}px`;
      popup.style.top = `${rect.bottom + 8}px`;
      popup.classList.remove('opacity-0', 'scale-95');
      popup.classList.add('opacity-100', 'scale-100');
    }
  }

  function hideTimezonePopup(parent) {
    const popup = parent.querySelector('.timezone-popup');
    if (popup) {
      popup.classList.remove('opacity-100', 'scale-100');
      popup.classList.add('opacity-0', 'scale-95');
    }
  }

  function showDoctorPopup(parent) {
    const popup = parent.querySelector('.doctor-popup');
    if (popup) {
      const rect = parent.getBoundingClientRect();
      const viewportWidth = window.innerWidth;
      
      // Check if popup would go off screen to the right
      if (rect.right + 340 > viewportWidth) {  // 340 = popup width (320) + margin (20)
        popup.style.left = 'auto';
        popup.style.right = '100%';
        popup.style.marginLeft = '0';
        popup.style.marginRight = '0.5rem';
      }
      
      popup.classList.remove('opacity-0', 'scale-95');
      popup.classList.add('opacity-100', 'scale-100');
    }
  }

  function hideDoctorPopup(parent) {
    const popup = parent.querySelector('.doctor-popup');
    if (popup) {
      popup.classList.remove('opacity-100', 'scale-100');
      popup.classList.add('opacity-0', 'scale-95');
    }
  }

  function updateTimezoneClocks() {
    const zoneMap = {
      EST: "America/New_York",
      CST: "America/Chicago",
      PST: "America/Los_Angeles",
      UTC: "UTC"
    };

    const now = new Date();
    Object.keys(zoneMap).forEach(label => {
      const formatter = new Intl.DateTimeFormat('en-US', {
        hour: 'numeric',
        minute: '2-digit',
        hour12: true,
        timeZone: zoneMap[label]
      });
      const el = document.getElementById(`tz-${label.toLowerCase()}`);
      if (el) {
        el.textContent = formatter.format(now);
      }
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    updateTimezoneClocks();
    setInterval(updateTimezoneClocks, 60_000); // update every minute
  });
</script>
{% endblock %}
