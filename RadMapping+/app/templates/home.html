{% extends "layout.html" %}
{% block title %}Daily Schedule{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-sm p-4 sm:p-6 mb-6 w-full">
  <div class="flex flex-col md:flex-row items-center justify-between gap-4">
    <!-- Date Navigation -->
    <div class="flex items-center gap-4">
      <a href="{{ url_for('dashboard.home') }}?date={{ prev_date }}" 
         class="p-2 hover:bg-gray-100 rounded-full transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </a>
      
      <form method="get" action="{{ url_for('dashboard.home') }}" class="flex items-center gap-4">
        <button
          type="button"
          class="flex items-center gap-2 bg-blue-50 hover:bg-blue-100 text-blue-700 px-4 py-2 rounded-lg transition-colors"
          onclick="document.getElementById('date-picker').showPicker()"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          <span class="font-medium">{{ today }}</span>
        </button>
        <input
          type="date"
          name="date"
          id="date-picker"
          value="{{ today }}"
          onchange="this.form.submit()"
          class="hidden"
        />
        
        <select 
        name="timezone" 
        onchange="this.form.submit()"
        class="bg-gray-50 border border-gray-200 text-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
      >
        <option value="EST" {% if selected_timezone == 'EST' %}selected{% endif %}>Eastern Time (EST)</option>
        <option value="CST" {% if selected_timezone == 'CST' %}selected{% endif %}>Central Time (CST)</option>
        <option value="PST" {% if selected_timezone == 'PST' %}selected{% endif %}>Pacific Time (PST)</option>
        <option value="UTC" {% if selected_timezone == 'UTC' %}selected{% endif %}>UTC</option>
      </select>
       <a href="{{ url_for('dashboard.home') }}?date={{ next_date }}" 
         class="p-2 hover:bg-gray-100 rounded-full transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </a>
      <!-- Custom Hour Range Filter -->
      <label class="text-sm font-medium text-gray-700">Show hours:</label>
      <select id="startHour" onchange="filterByCustomRange()" class="border rounded px-2 py-1 text-sm">
        {% for slot in hour_slots %}
          <option value="{{ loop.index0 }}">{{ slot.label }} {{ slot.day_label }}</option>
        {% endfor %}
      </select>
      <span class="text-sm">to</span>
      <select id="endHour" onchange="filterByCustomRange()" class="border rounded px-2 py-1 text-sm">
        {% for slot in hour_slots %}
          <option value="{{ loop.index0 }}">{{ slot.label }} {{ slot.day_label }}</option>
        {% endfor %}
      </select>
      </form>

     
    </div>

    <!-- Timezone Display -->
    <div class="flex flex-wrap gap-2 sm:gap-3 w-full md:w-auto">
      {% for zone in ["EST", "CST", "PST", "UTC"] %}
        <div class="bg-gray-50 hover:bg-gray-100 border border-gray-200 rounded-lg px-3 sm:px-4 py-2 shadow-sm relative timezone-tile transition-colors"
             onmouseenter="showTimezonePopup(this)"
             onmouseleave="hideTimezonePopup(this)">
          <div class="flex items-center gap-2">
            <span class="text-sm font-medium text-gray-700">{{ zone }}</span>
            <span id="tz-{{ zone|lower }}" class="text-sm text-gray-600">...</span>
          </div>
          <div class="timezone-popup fixed z-10 mt-2 bg-white border rounded-lg shadow-lg p-4 text-left w-64 sm:w-72 opacity-0 transition-all duration-200 pointer-events-auto transform scale-95"
               style="left: 50%; transform: translateX(-50%) scale(0.95);">
            <h5 class="font-medium text-gray-900 mb-3">Doctors in {{ zone }}</h5>
            {% set tz_docs = doctors_by_timezone.get(zone, []) %}
            {% if tz_docs %}
              <ul class="space-y-2 max-h-60 overflow-y-auto">
                {% for doc in tz_docs %}
                <li class="text-sm">
                  <a href="{{ url_for('dashboard.doctor_profile', rad_id=doc.id) }}" target="_blank" class="hover:underline text-blue-700 font-medium">
                    {{ doc.name }}
                  </a>
                  {% if doc.id in doctors_currently_on_shift_ids %}
                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full ml-2">On shift now</span>
                  {% elif doc.id in doctors_on_shift_ids %}
                    <span class="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full ml-2">Scheduled Today</span>
                  {% endif %}
                </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-sm italic text-gray-500">No doctors in this timezone.</p>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>


<!-- Daily Schedule -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
  {% for slot in hour_slots %}
    <div id="hour-{{ loop.index0 }}" class="bg-white border rounded shadow p-4" data-slot-datetime="{{ slot.datetime.isoformat() }}">
      <h4 class="text-md font-semibold text-blue-800 border-b pb-1 mb-2">
        {{ slot.label }}
        <span class="text-xs text-gray-500 ml-2">({{ slot.date }})</span>
        {% if selected_timezone != 'UTC' %}
          <span class="text-sm text-gray-500 ml-2">({{ (slot.hour - timezone_offset)|int }}:00 {{ selected_timezone }})</span>
        {% endif %}
      </h4>
      {% set slot_doctors = [] %}
      {% for doc in doctors_on_shift %}
        {% if doc.start_dt <= slot.datetime < doc.end_dt %}
          {% set _ = slot_doctors.append(doc) %}
        {% endif %}
      {% endfor %}
      {% if slot_doctors %}
        <ul class="space-y-2">
          {% for doc in slot_doctors %}
          <li class="relative border p-2 rounded bg-gray-50 hover:bg-gray-100 transition-colors duration-200"
          onmouseenter="showDoctorPopup(this)"
          onmouseleave="hideDoctorPopup(this)"
          data-start-dt="{{ doc.start_dt.isoformat() }}"
          data-end-dt="{{ doc.end_dt.isoformat() }}"
          data-schedule-details="{{ doc.schedule_details or '' }}">
              <div class="flex items-center justify-between">
                <a href="{{ url_for('dashboard.doctor_profile', rad_id=doc.id) }}" class="text-blue-700 font-semibold hover:underline">
                  {{ doc.name }}
                </a>
                <span class="text-sm text-gray-500">{{ doc.timezone or '—' }}</span>
              </div>
              <div class="text-sm text-gray-600 mt-1">
                Shift: {{ doc.start_time | ampm }} – {{ doc.end_time | ampm }}
                {% if selected_timezone != doc.timezone %}
                  <span class="text-gray-500">({{ doc.start_time | convert_timezone(selected_timezone) }} – {{ doc.end_time | convert_timezone(selected_timezone) }})</span>
                {% endif %}
              </div>
              <div class="text-sm text-gray-500 mt-1">
                {% if doc.modalities %}
                <div>
                  <span class="font-semibold text-gray-800">Modalities:</span>
                  <span class="text-gray-700">{{ doc.modalities }}</span>
                </div>
                {% endif %}
                {% if doc.pacs %}
                <span class="font-semibold text-gray-800">PACS:</span>
                <span class="text-gray-700">{{ doc.pacs }}</span>
                {% endif %}
              </div>
              <div class="doctor-popup absolute left-full top-0 ml-2 w-[20rem] bg-white border p-4 rounded-lg shadow-lg text-left pointer-events-none opacity-0 transition-all duration-200 z-50 transform scale-95">
                <h4 class="font-medium text-lg text-gray-900 mb-2">{{ doc.name }}</h4>
                <div class="space-y-2">
                  <p class="text-sm"><span class="font-medium">Phone:</span> <span class="text-gray-700">{{ doc.phone or 'N/A' }}</span></p>
                  <p class="text-sm"><span class="font-medium">Email:</span> <span class="text-gray-700">{{ doc.email or 'N/A' }}</span></p>
                  {% if doc.schedule_details %}
                    <p class="text-sm"><span class="font-medium">Schedule Notes:</span> <span class="text-gray-700">{{ doc.schedule_details }}</span></p>
                  {% endif %}
                </div>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-sm italic text-gray-400">No doctors on shift.</p>
      {% endif %}
    </div>
  {% endfor %}
</div>


<script>
  function showTimezonePopup(parent) {
    const popup = parent.querySelector('.timezone-popup');
    if (popup) {
      const rect = parent.getBoundingClientRect();
      popup.style.left = `${rect.left + (rect.width / 2)}px`;
      popup.style.top = `${rect.bottom + 8}px`;
      popup.classList.remove('opacity-0', 'scale-95');
      popup.classList.add('opacity-100', 'scale-100');
    }
  }

  function hideTimezonePopup(parent) {
    const popup = parent.querySelector('.timezone-popup');
    if (popup) {
      popup.classList.remove('opacity-100', 'scale-100');
      popup.classList.add('opacity-0', 'scale-95');
    }
  }

  function showDoctorPopup(parent) {
    const popup = parent.querySelector('.doctor-popup');
    if (popup) {
      const rect = parent.getBoundingClientRect();
      const viewportWidth = window.innerWidth;
      
      // Check if popup would go off screen to the right
      if (rect.right + 340 > viewportWidth) {  // 340 = popup width (320) + margin (20)
        popup.style.left = 'auto';
        popup.style.right = '100%';
        popup.style.marginLeft = '0';
        popup.style.marginRight = '0.5rem';
      }
      
      popup.classList.remove('opacity-0', 'scale-95');
      popup.classList.add('opacity-100', 'scale-100');
    }
  }

  function hideDoctorPopup(parent) {
    const popup = parent.querySelector('.doctor-popup');
    if (popup) {
      popup.classList.remove('opacity-100', 'scale-100');
      popup.classList.add('opacity-0', 'scale-95');
    }
  }

  function updateTimezoneClocks() {
    const zoneMap = {
      EST: "America/New_York",
      CST: "America/Chicago",
      PST: "America/Los_Angeles",
      UTC: "UTC"
    };

    const now = new Date();
    Object.keys(zoneMap).forEach(label => {
      const formatter = new Intl.DateTimeFormat('en-US', {
        hour: 'numeric',
        minute: '2-digit',
        hour12: true,
        timeZone: zoneMap[label]
      });
      const el = document.getElementById(`tz-${label.toLowerCase()}`);
      if (el) {
        el.textContent = formatter.format(now);
      }
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
  updateTimezoneClocks();
  colorDoctorBlocks();
  setInterval(updateTimezoneClocks, 60_000);
  scrollToCurrentHour();
  setInitialHourFilter();    
  
});


  function filterByCustomRange() {
  const start = parseInt(document.getElementById("startHour").value, 10);
  const end = parseInt(document.getElementById("endHour").value, 10);
  const total = document.querySelectorAll('[id^="hour-"]').length;
  for (let i = 0; i < total; i++) {
    const block = document.getElementById(`hour-${i}`);
    if (!block) continue;
    // Handle ranges that wrap past midnight (shouldn't happen with linear hour_slots, but keep logic robust)
    const isInRange = start <= end ? (i >= start && i <= end) : (i >= start || i <= end);
    block.style.display = isInRange ? "block" : "none";
  }
}

function scrollToCurrentHour() {
  const now = new Date();
  const currentHour = now.getHours();
  const target = document.getElementById(`hour-${currentHour}`);

  // Only apply if we're viewing today's date
  if (target && "{{ today }}" === new Date().toISOString().split('T')[0]) {
    // Add highlight class
    target.classList.add("ring-2", "ring-blue-200", "ring-offset-2");
  }
}

function setInitialHourFilter() {
  // Only set initial filter if we're viewing today's date
  if ("{{ today }}" === new Date().toISOString().split('T')[0]) {
    const now = new Date();
    const currentHour = now.getHours();
    const endHour = (currentHour - 24);

    const startSelect = document.getElementById("startHour");
    const endSelect = document.getElementById("endHour");

    if (startSelect && endSelect) {
      startSelect.value = currentHour;
      endSelect.value = endHour;
      filterByCustomRange();
    }
  }
}


function colorDoctorBlocks() {
  document.querySelectorAll("li[data-start-dt][data-end-dt]").forEach(el => {
    const slotDiv = el.closest('[id^="hour-"]');
    if (!slotDiv) return;
    const slotDtStr = slotDiv.getAttribute('data-slot-datetime');
    if (!slotDtStr) return;
    const slotDt = new Date(slotDtStr);
    const startDt = new Date(el.dataset.startDt);
    const endDt = new Date(el.dataset.endDt);

    // Reset any existing color classes
    el.classList.remove("bg-green-50", "border-green-200", "bg-yellow-50", "border-yellow-200", "bg-red-50", "border-red-200");

    if (slotDt >= startDt && slotDt < endDt) {
      // Calculate percentage remaining in shift
      const totalMs = endDt - startDt;
      const msSinceStart = slotDt - startDt;
      const msRemaining = totalMs - msSinceStart;
      const percentageRemaining = (msRemaining / totalMs) * 100;
      // Check if this is the last hour block of the shift
      const nextHourDt = new Date(slotDt.getTime() + 60 * 60 * 1000);
      const isLastHourBlock = nextHourDt >= endDt;
      if (isLastHourBlock) {
        el.classList.add("bg-red-50", "border-red-200");
      } else if (percentageRemaining > 75) {
        el.classList.add("bg-green-50", "border-green-200");
      } else if (percentageRemaining > 25) {
        el.classList.add("bg-yellow-50", "border-yellow-200");
      } else {
        el.classList.add("bg-red-50", "border-red-200");
      }
    }
  });
}

function applyDateTimeFilter() {
  const startDate = document.getElementById('filterStartDate').value;
  const startTime = document.getElementById('filterStartTime').value;
  const endDate = document.getElementById('filterEndDate').value;
  const endTime = document.getElementById('filterEndTime').value;
  const errorSpan = document.getElementById('filterError');
  errorSpan.textContent = '';
  if (!startDate || !startTime || !endDate || !endTime) {
    errorSpan.textContent = 'All fields required.';
    return;
  }
  if (endDate > startDate) {
    errorSpan.textContent = 'End date cannot be after start date.';
    return;
  }
  // Optionally, add logic to filter the hour slots here
  // ...
}

</script>


{% endblock %}
