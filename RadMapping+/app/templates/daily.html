{% extends "layout.html" %}
{% block title %}Daily Schedule{% endblock %}

{% block content %}
<!-- Add these hidden elements at the top of your template -->
<script type="application/json" id="doctors-by-timezone">
  {{ doctors_by_timezone | tojson | safe }}
</script>
<script type="application/json" id="doctors-currently-on-shift">
  {{ doctors_currently_on_shift_ids | tojson | safe }}
</script>
<script type="application/json" id="doctors-on-shift">
  {{ doctors_on_shift_ids | tojson | safe }}
</script>

<div class="bg-white rounded-lg shadow-sm p-4 sm:p-6 mb-6 w-full">
  <div class="flex flex-col md:flex-row items-center justify-between gap-4">
    <!-- Date Navigation -->
    <div class="flex items-center gap-4">
      <a href="{{ url_for('daily.daily') }}?date={{ prev_date }}" 
         class="p-2 hover:bg-gray-100 rounded-full transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </a>
      
      <form method="get" action="{{ url_for('daily.daily') }}" class="flex items-center gap-4">
        <button
          type="button"
          class="flex items-center gap-2 bg-blue-50 hover:bg-blue-100 text-blue-700 px-4 py-2 rounded-lg transition-colors"
          onclick="document.getElementById('date-picker').showPicker()"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          <span class="font-medium">{{ today }}</span>
        </button>
        <input
          type="date"
          name="date"
          id="date-picker"
          value="{{ today }}"
          onchange="this.form.submit()"
          class="hidden"
        />
        
        <select 
        name="timezone" 
        onchange="this.form.submit()"
        class="bg-gray-50 border border-gray-200 text-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
      >
        <option value="EST" {% if selected_timezone == 'EST' %}selected{% endif %}>Eastern Time (EST)</option>
        <option value="CST" {% if selected_timezone == 'CST' %}selected{% endif %}>Central Time (CST)</option>
        <option value="PST" {% if selected_timezone == 'PST' %}selected{% endif %}>Pacific Time (PST)</option>
  
      </select>
       <a href="{{ url_for('daily.daily') }}?date={{ next_date }}" 
         class="p-2 hover:bg-gray-100 rounded-full transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </a>
      <!-- Custom Hour Range Filter -->
      <label class="text-sm font-medium text-gray-700">Show hours:</label>
      <select id="startHour" onchange="filterByCustomRange()" class="border rounded px-2 py-1 text-sm">
        {% for slot in hour_slots %}
          <option value="{{ loop.index0 }}">{{ slot.label }} {{ slot.day_label }}</option>
        {% endfor %}
      </select>
      <span class="text-sm">to</span>
      <select id="endHour" onchange="filterByCustomRange()" class="border rounded px-2 py-1 text-sm">
        {% for slot in hour_slots %}
          <option value="{{ loop.index0 }}">{{ slot.label }} {{ slot.day_label }}</option>
        {% endfor %}
      </select>
      </form>

     
    </div>

    <!-- Search Box -->
    <div class="flex-1 max-w-md">
      <input type="text"
             id="doctorSearch"
             placeholder="Search doctors..."
             class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
             onkeyup="filterDoctors()" />
    </div>

    <!-- Timezone Display -->
<div class="flex flex-wrap gap-2 sm:gap-3 w-full md:w-auto">
  {% for zone in ["EST", "CST", "PST", "UTC"] %}
    <div class="bg-gray-50 hover:bg-gray-100 px-3 py-2 rounded-lg shadow-sm timezone-tile transition-colors cursor-pointer"
         onclick="openTimezonePopup('{{ zone }}')">
      <div class="flex items-center gap-2">
        <span class="text-sm font-medium text-gray-700">{{ zone }}</span>
        <span id="tz-{{ zone|lower }}" class="text-sm text-gray-600">...</span>
      </div>
    </div>
  {% endfor %}
</div>

<!-- ✅ Modal should go here, once only -->
<div id="timezoneModal" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50 hidden">
  <div class="bg-white w-full max-w-md p-6 rounded-lg shadow-lg relative">
    <button onclick="closeTimezonePopup()" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-xl">
      &times;
    </button>
    <h3 id="modalTimezoneTitle" class="text-lg font-semibold mb-4"></h3>
    <div id="modalTimezoneContent" class="space-y-2 max-h-72 overflow-y-auto text-sm">
      <!-- Filled dynamically -->
    </div>
  </div>
</div>

  </div>
</div>


<!-- Daily Schedule -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
  {% for slot in hour_slots %}
    <div id="hour-{{ loop.index0 }}" class="bg-white border rounded shadow p-4" data-slot-datetime="{{ slot.datetime.isoformat() }}">
      <h4 class="text-md font-semibold text-blue-800 border-b pb-1 mb-2 flex items-center justify-between">
        <span>
          {{ slot.label }}
          {% if selected_timezone != "sST" %}
            <span class="text-sm text-gray-500 ml-1">({{ (slot.hour - timezone_offset)|int }}:00 {{ selected_timezone }})</span>
          {% endif %}
        </span>
        <span class="flex items-center text-sm text-gray-700 relative" style="gap: 0.25rem;">
          <span class="relative group" style="pointer-events: auto; cursor: pointer;">
            <span class="text-blue-700 font-semibold text-base">
              {{ (hourly_rvu_stats[slot.datetime]['current'] | round(1)) if hourly_rvu_stats[slot.datetime] and hourly_rvu_stats[slot.datetime]['current'] is not none else '—' }}
            </span>
            <span class="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-max bg-white border border-gray-300 rounded shadow-lg px-3 py-2 text-xs text-blue-700 opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity z-50 whitespace-nowrap">
              Hourly RVU Sum
            </span>
          </span>
          <span class="mx-1 text-gray-400">vs</span>
          <span class="relative group" style="pointer-events: auto; cursor: pointer;">
            <span class="text-green-700 font-semibold text-base">
              {{ (hourly_rvu_stats[slot.datetime]['historical'] | round(1)) if hourly_rvu_stats[slot.datetime] and hourly_rvu_stats[slot.datetime]['historical'] is not none else '—' }}
            </span>
            <span class="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-max bg-white border border-gray-300 rounded shadow-lg px-3 py-2 text-xs text-green-700 opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity z-50 whitespace-nowrap">
              Expected Capacity In RVU
            </span>
          </span>

          {# Indicator logic #}
          {% set current = hourly_rvu_stats[slot.datetime]['current'] if hourly_rvu_stats[slot.datetime] else None %}
          {% set expected = hourly_rvu_stats[slot.datetime]['historical'] if hourly_rvu_stats[slot.datetime] else None %}
          {% set ratio = (current / expected) if current is not none and expected and expected > 0 else None %}
          {% if ratio is not none %}
            {% if ratio <= 0.6 %}
              <span class="ml-2 relative" style="display: flex; align-items: flex-start; pointer-events: none;">
                <span class="text-red-600 text-2xl font-bold align-middle relative group" style="position: relative; top: -0.1em; pointer-events: auto; cursor: pointer;">
                  &#9679;
                  <span class="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-max bg-white border border-gray-300 rounded shadow-lg px-3 py-2 text-xs text-red-700 opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity z-50 whitespace-nowrap">
                   Current RVU is at or below 60% of expected capacity
                  </span>
                </span>
              </span>
            {% elif ratio <= 0.9 %}
              <span class="ml-2 relative" style="display: flex; align-items: flex-start; pointer-events: none;">
                <span class="text-yellow-500 text-2xl font-bold align-middle relative group" style="position: relative; top: -0.1em; pointer-events: auto; cursor: pointer;">
                  &#9679;
                  <span class="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-max bg-white border border-gray-300 rounded shadow-lg px-3 py-2 text-xs text-yellow-700 opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity z-50 whitespace-nowrap">
                    <b>Notice:</b> Current RVU is between 60% and 90% of expected capacity.
                  </span>
                </span>
              </span>
            {% else %}
              <span class="ml-2 relative" style="display: flex; align-items: flex-start; pointer-events: none;">
                <span class="text-green-600 text-2xl font-bold align-middle relative group" style="position: relative; top: -0.1em; pointer-events: auto; cursor: pointer;">
                  &#9679;
                  <span class="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-max bg-white border border-gray-300 rounded shadow-lg px-3 py-2 text-xs text-green-700 opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity z-50 whitespace-nowrap">
                    <b>Good:</b> Current RVU is above 90% of expected capacity.
                  </span>
                </span>
              </span>
            {% endif %}
          {% endif %}
        </span>
      </h4>

      {% set slot_doctors = doctors_by_hour.get(slot.datetime, []) %}
      {% if slot_doctors %}
        <ul class="space-y-2">
          {% for doc in slot_doctors %}
          <li class="relative border p-2 rounded bg-gray-50 hover:bg-gray-100 transition-colors duration-200"
              onmouseenter="showDoctorPopup(this)"
              onmouseleave="hideDoctorPopup(this)"
              data-start-dt="{{ doc.start_dt.isoformat() }}"
              data-end-dt="{{ doc.end_dt.isoformat() }}"
              data-schedule-details="{{ doc.schedule_details or '' }}">
              <div class="flex items-center justify-between">
                <a href="{{ url_for('doctors.doctor_profile', rad_id=doc.id) }}" target="_blank" class="text-blue-700 font-semibold hover:underline">
                  {{ doc.name }}
                </a>
                <span class="text-sm text-gray-500">{{ doc.timezone or '—' }}</span>
              </div>
              <div class="text-sm text-gray-600 mt-1">
                <span class="font-semibold text-gray-800">Shift:</span>
                {{ doc.start_time | ampm }} – {{ doc.end_time | ampm }}
                {% if doc.break_start_dt and doc.break_end_dt %}
                  <br>
              
                {% endif %}
              </div>
              <div class="text-sm text-gray-500 mt-1">
                {% if doc.modalities %}
                  <div>
                    <span class="font-semibold text-gray-800">Modalities:</span>
                    <span class="text-gray-700">{{ doc.modalities }}</span>
                  </div>
                {% endif %}
                <span class="font-semibold text-gray-800">RVU:</span>
                <span class="text-gray-800 ">
                  {% set doc_rvu = None %}
                  {% if doc.id in rvu_rows %}
                    {% set doc_rvu = rvu_rows[doc.id]|default({}) %}
                  {% endif %}
                  {% if doc_rvu %}
                    {{ (get_latest_nonzero_rvu(doc_rvu) | round(1)) }}
                  {% else %}
                    —
                  {% endif %}
                </span>
              </div>
              <div class="doctor-popup absolute left-full top-0 ml-2 w-[20rem] bg-white border p-4 rounded-lg shadow-lg text-left pointer-events-none opacity-0 transition-all duration-200 z-50 transform scale-95">
                <h4 class="font-medium text-lg text-gray-900 mb-2">{{ doc.name }}</h4>
                <div class="space-y-2">
                  <p class="text-sm"><span class="font-medium">Phone:</span> <span class="text-gray-700">{{ doc.phone or 'N/A' }}</span></p>
                  <p class="text-sm"><span class="font-medium">Email:</span> <span class="text-gray-700">{{ doc.email or 'N/A' }}</span></p>
                  <p class="text-sm"><span class="font-medium">PACS:</span> <span class="text-gray-700">{{ doc.pacs or 'N/A' }}</span></p>
                  {% if doc.schedule_details %}
                    <p class="text-sm"><span class="font-medium">Schedule Notes:</span> <span class="text-gray-700">{{ doc.schedule_details }}</span></p>
                  {% endif %}
                </div>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-sm italic text-gray-400">No doctors on shift.</p>
      {% endif %}
    </div>
  {% endfor %}
</div>


<script>
  function showTimezonePopup(parent) {
    const popup = parent.querySelector('.timezone-popup');
    if (popup) {
      const rect = parent.getBoundingClientRect();
      popup.style.left = `${rect.left + (rect.width / 2)}px`;
      popup.style.top = `${rect.bottom + 8}px`;
      popup.classList.remove('opacity-0', 'scale-95');
      popup.classList.add('opacity-100', 'scale-100');
    }
  }

  function hideTimezonePopup(parent) {
    const popup = parent.querySelector('.timezone-popup');
    if (popup) {
      popup.classList.remove('opacity-100', 'scale-100');
      popup.classList.add('opacity-0', 'scale-95');
    }
  }

  function showDoctorPopup(parent) {
    const popup = parent.querySelector('.doctor-popup');
    if (popup) {
      const rect = parent.getBoundingClientRect();
      const viewportWidth = window.innerWidth;
      
      // Check if popup would go off screen to the right
      if (rect.right + 340 > viewportWidth) {  // 340 = popup width (320) + margin (20)
        popup.style.left = 'auto';
        popup.style.right = '100%';
        popup.style.marginLeft = '0';
        popup.style.marginRight = '0.5rem';
      }
      
      popup.classList.remove('opacity-0', 'scale-95');
      popup.classList.add('opacity-100', 'scale-100');
    }
  }

  function hideDoctorPopup(parent) {
    const popup = parent.querySelector('.doctor-popup');
    if (popup) {
      popup.classList.remove('opacity-100', 'scale-100');
      popup.classList.add('opacity-0', 'scale-95');
    }
  }

  function updateTimezoneClocks() {
    const zoneMap = {
      EST: "America/New_York",
      CST: "America/Chicago",
      PST: "America/Los_Angeles",
      UTC: "UTC"
    };

    const now = new Date();
    Object.keys(zoneMap).forEach(label => {
      const formatter = new Intl.DateTimeFormat('en-US', {
        hour: 'numeric',
        minute: '2-digit',
        hour12: true,
        timeZone: zoneMap[label]
      });
      const el = document.getElementById(`tz-${label.toLowerCase()}`);
      if (el) {
        el.textContent = formatter.format(now);
      }
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
  updateTimezoneClocks();
  colorDoctorBlocks();
  setInterval(updateTimezoneClocks, 60_000);
  scrollToCurrentHour();
  setInitialHourFilter();    
  
});


  function filterByCustomRange() {
  const start = parseInt(document.getElementById("startHour").value, 10);
  const end = parseInt(document.getElementById("endHour").value, 10);
  const total = document.querySelectorAll('[id^="hour-"]').length;
  for (let i = 0; i < total; i++) {
    const block = document.getElementById(`hour-${i}`);
    if (!block) continue;
    // Handle ranges that wrap past midnight (shouldn't happen with linear hour_slots, but keep logic robust)
    const isInRange = start <= end ? (i >= start && i <= end) : (i >= start || i <= end);
    block.style.display = isInRange ? "block" : "none";
  }
}

function scrollToCurrentHour() {
  const now = new Date();
  const currentHour = now.getHours();
  const target = document.getElementById(`hour-${currentHour}`);

  // Only apply if we're viewing today's date
  if (target && "{{ today }}" === new Date().toISOString().split('T')[0]) {
    // Add highlight class
    target.classList.add("ring-2", "ring-blue-200", "ring-offset-2");
  }
}

function setInitialHourFilter() {
  // Only set initial filter if we're viewing today's date
  if ("{{ today }}" === new Date().toISOString().split('T')[0]) {
    const now = new Date();
    const currentHour = now.getHours();
    const endHour = (currentHour - 24);

    const startSelect = document.getElementById("startHour");
    const endSelect = document.getElementById("endHour");

    if (startSelect && endSelect) {
      startSelect.value = currentHour;
      endSelect.value = endHour;
      filterByCustomRange();
    }
  }
}


function colorDoctorBlocks() {
  document.querySelectorAll("li[data-start-dt][data-end-dt]").forEach(el => {
    const slotDiv = el.closest('[id^="hour-"]');
    if (!slotDiv) return;
    const slotDtStr = slotDiv.getAttribute('data-slot-datetime');
    if (!slotDtStr) return;
    const slotDt = new Date(slotDtStr);
    const startDt = new Date(el.dataset.startDt);
    const endDt = new Date(el.dataset.endDt);

    // Reset any existing color classes
    el.classList.remove("bg-green-50", "border-green-200", "bg-yellow-50", "border-yellow-200", "bg-red-50", "border-red-200");
    el.classList.add("bg-green-50", "border-green-200");
    if (slotDt >= startDt && slotDt < endDt) {
      // Calculate percentage remaining in shift
      const totalMs = endDt - startDt;
      const msSinceStart = slotDt - startDt;
      const msRemaining = totalMs - msSinceStart;
      const percentageRemaining = (msRemaining / totalMs) * 100;
      // Check if this is the last hour block of the shift
      const nextHourDt = new Date(slotDt.getTime() + 60 * 60 * 1000);
      const isLastHourBlock = nextHourDt >= endDt;
      if (isLastHourBlock) {
        el.classList.add("bg-red-50", "border-red-200");
      } else if (percentageRemaining > 75) {
        el.classList.add("bg-green-50", "border-green-200");
      } else if (percentageRemaining > 25) {
        el.classList.add("bg-yellow-50", "border-yellow-200");
      } else {
        el.classList.add("bg-red-50", "border-red-200");
      }
    }
  });
}

function applyDateTimeFilter() {
  const startDate = document.getElementById('filterStartDate').value;
  const startTime = document.getElementById('filterStartTime').value;
  const endDate = document.getElementById('filterEndDate').value;
  const endTime = document.getElementById('filterEndTime').value;
  const errorSpan = document.getElementById('filterError');
  errorSpan.textContent = '';
  if (!startDate || !startTime || !endDate || !endTime) {
    errorSpan.textContent = 'All fields required.';
    return;
  }
  if (endDate > startDate) {
    errorSpan.textContent = 'End date cannot be after start date.';
    return;
  }
  // Optionally, add logic to filter the hour slots here
  // ...
}

function filterDoctors() {
  const searchTerm = document.getElementById('doctorSearch').value.toLowerCase();
  const startSelect = document.getElementById("startHour");
  const endSelect = document.getElementById("endHour");

  const isToday = "{{ today }}" === new Date().toISOString().split('T')[0];
  const currentHour = new Date().getHours();

  if (searchTerm) {
    // Expand hour range to full day on search
    if (startSelect.value !== "0" || endSelect.value !== "23") {
      startSelect.value = "0";
      endSelect.value = "23";
      filterByCustomRange();
    }
  } else {
    // Reset to original hour range
    if (isToday) {
      setInitialHourFilter();
    } else {
      startSelect.value = "0";
      endSelect.value = "23";
      filterByCustomRange();
    }
  }


  const startHour = parseInt(startSelect.value, 10);
  const endHour = parseInt(endSelect.value, 10);

  // Filter timezone popups
  document.querySelectorAll('.doctor-item').forEach(item => {
    const doctorName = item.querySelector('.doctor-name').textContent.toLowerCase();
    item.style.display = doctorName.includes(searchTerm) ? '' : 'none';
  });

  // Filter main schedule
  const scheduleItems = document.querySelectorAll('[id^="hour-"] li');
  scheduleItems.forEach(item => {
    const doctorName = item.querySelector('a').textContent.toLowerCase();
    const hourBlock = item.closest('[id^="hour-"]');
    item.style.display = doctorName.includes(searchTerm) ? '' : 'none';
    if (doctorName.includes(searchTerm)) {
      hourBlock.style.display = 'block';
    }
  });

  // Adjust hour block visibility
  document.querySelectorAll('[id^="hour-"]').forEach(hourBlock => {
    const visibleItems = hourBlock.querySelectorAll('li:not([style*="display: none"])').length;
    const hourIndex = parseInt(hourBlock.id.split('-')[1]);

    const isInRange = startHour <= endHour
      ? (hourIndex >= startHour && hourIndex <= endHour)
      : (hourIndex >= startHour || hourIndex <= endHour);

    if (!isInRange) {
      hourBlock.style.display = 'none';
      return;
    }

    if (isToday && hourIndex === currentHour) {
      hourBlock.style.display = 'block';
      hourBlock.classList.add("ring-2", "ring-blue-200", "ring-offset-2");

      const existingMsg = hourBlock.querySelector('.no-results-message');
      if (searchTerm && visibleItems === 0 && !existingMsg) {
        const noResultsMsg = document.createElement('p');
        noResultsMsg.className = 'text-sm italic text-gray-400 no-results-message';
        noResultsMsg.textContent = 'No matching doctors in this hour.';
        hourBlock.appendChild(noResultsMsg);
      } else if (visibleItems > 0 && existingMsg) {
        existingMsg.remove();
      }
    } else {
      hourBlock.classList.remove("ring-2", "ring-blue-200", "ring-offset-2");
      hourBlock.style.display = visibleItems > 0 ? 'block' : 'none';
    }
  });
}

function openTimezonePopup(zone) {
  const modal = document.getElementById("timezoneModal");
  const title = document.getElementById("modalTimezoneTitle");
  const content = document.getElementById("modalTimezoneContent");

  title.textContent = `Doctors in ${zone}`;
  content.innerHTML = "";

  // Parse the JSON data from the template variables
  const tzDocs = JSON.parse(document.getElementById('doctors-by-timezone').textContent);
  const docIdsNow = JSON.parse(document.getElementById('doctors-currently-on-shift').textContent);
  const docIdsToday = JSON.parse(document.getElementById('doctors-on-shift').textContent);

  const docs = tzDocs[zone] || [];
  if (docs.length === 0) {
    content.innerHTML = `<p class="italic text-gray-500">No doctors in this timezone.</p>`;
  } else {
    docs.forEach(doc => {
      const status = docIdsNow.includes(doc.id)
        ? `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full ml-2">On shift now</span>`
        : docIdsToday.includes(doc.id)
        ? `<span class="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full ml-2">Scheduled Today</span>`
        : '';

      const html = `
        <div class="text-sm mb-2">
          <a href="/radmapping/doctors/${doc.id}" target="_blank" class="text-blue-700 font-medium hover:underline">
            ${doc.name}
          </a>
          ${status}
        </div>`;
      content.innerHTML += html;
    });
  }

  modal.classList.remove("hidden");
}

function closeTimezonePopup() {
  document.getElementById("timezoneModal").classList.add("hidden");
}

// Close modal if clicking outside it
document.addEventListener("click", function (e) {
  const modal = document.getElementById("timezoneModal");
  const box = modal.querySelector("div.bg-white");
  if (!box.contains(e.target) && !e.target.closest(".timezone-tile")) {
    modal.classList.add("hidden");
  }
});
</script>
{% endblock %}