{% extends "layout.html" %}
{% block title %}Doctor Profile{% endblock %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
{% endblock %}

{% block content %}


<div x-data="{ editing: false }" class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm mb-6">
  
  <div class="flex justify-between items-center col-span-2">
    <h2 class="text-2xl font-semibold">{{ doctor.name }}</h2>
    {% if session.user.role == 'admin' %}
      <button @click="editing = !editing" class="text-blue-600 text-sm hover:underline">
        <span x-show="!editing">Edit Info</span>
        <span x-show="editing">Cancel Edit</span>
      </button>
    {% endif %}
  </div>

  <form method="POST" action="{{ url_for('dashboard.update_doctor', rad_id=doctor.id) }}" class="grid grid-cols-1 sm:grid-cols-2 gap-4 col-span-2" x-show="editing">
    <label class="block">
      <span class="font-semibold">Email</span>
      <input type="email" name="email" value="{{ doctor.email or '' }}" class="input w-full border rounded px-3 py-2 text-sm" />
    </label>

    <label class="block">
      <span class="font-semibold">Phone</span>
      <input type="text" name="phone" value="{{ doctor.phone or '' }}" class="input w-full border rounded px-3 py-2 text-sm" />
    </label>

    <label class="block">
      <span class="font-semibold">PACS</span>
      <input type="text" name="pacs" value="{{ doctor.pacs or '' }}" class="input w-full border rounded px-3 py-2 text-sm" />
    </label>

    <label class="block">
      <span class="font-semibold">Primary Contact Method</span>
      <input type="text" name="primary_contact_method" value="{{ doctor.primary_contact_method or '' }}" class="input w-full border rounded px-3 py-2 text-sm" />
    </label>

    <label class="block">
      <span class="font-semibold">Modalities</span>
      <input type="text" name="modalities" value="{{ doctor.modalities or '' }}" class="input w-full border rounded px-3 py-2 text-sm" />
    </label>

    <label class="block">
      <span class="font-semibold">Timezone</span>
      <input type="text" name="timezone" value="{{ doctor.timezone or '' }}" class="input w-full border rounded px-3 py-2 text-sm" />
    </label>
    
    <label class="flex items-center space-x-2 mt-4">
      <input type="checkbox" name="active_status" value="true" {% if doctor.active_status %}checked{% endif %} class="form-checkbox h-5 w-5 text-blue-600">
      <span class="text-sm font-medium">Active</span>
    </label>
    
    <div class="col-span-2">
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-semibold mt-2">
        Save Changes
      </button>
    </div>
  </form>

  <div x-show="!editing" class="grid grid-cols-1 sm:grid-cols-2 gap-4 col-span-2">
    <p><strong>Email:</strong> {{ doctor.email }}</p>
    <p><strong>Phone:</strong> {{ doctor.phone }}</p>
    <p><strong>PACS:</strong> {{ doctor.pacs }}</p>
    <p><strong>Primary Method:</strong> {{ doctor.primary_contact_method }}</p>
    <p><strong>Modalities:</strong> {{ doctor.modalities or "—" }}</p>
    <p><strong>Timezone (EST):</strong> {{ doctor.timezone or "—" }}</p>
  </div>

</div>


{% if doctor.additional_info %}
<div class="mt-6">
  <h3 class="font-semibold mb-2">Additional Info</h3>
  <p class="text-gray-700">{{ doctor.additional_info }}</p>
</div>
{% endif %}


<div class="mt-10">
  <h3 class="text-xl font-semibold mb-2">Licenses</h3>
  <button onclick="openCertModal()" class="text-blue-600 hover:underline">View Licenses</button>
</div>

<div class="mt-6">
  <h3 class="text-xl font-semibold mb-2">Assigned Facilities</h3>
  <button onclick="openFacilityModal()" class="text-blue-600 hover:underline">View Facilities</button>
</div>

{% if session.user.role == 'admin' %}
<div class="mt-10">
  <div class="flex justify-between items-center mb-4">
    <h3 class="text-xl font-semibold">Edit Schedule: {{ now.strftime('%B %Y') }}</h3>
    <div>
      <button onclick="toggleMultiSelect()" class="text-sm text-blue-600 hover:underline mr-4" id="multiToggle">Enable Multi-Select</button>
      <a href="{{ url_for('dashboard.doctor_profile', rad_id=doctor.id, year=prev_year, month=prev_month) }}" class="text-blue-600 hover:underline mr-4">← Prev</a>
      <a href="{{ url_for('dashboard.doctor_profile', rad_id=doctor.id, year=next_year, month=next_month) }}" class="text-blue-600 hover:underline">Next →</a>
    </div>
  </div>

  <form method="POST" action="{{ url_for('dashboard.bulk_update_schedule', rad_id=doctor.id) }}" class="bg-gray-100 p-4 rounded border mb-6 hidden" id="bulkForm">
    <h4 class="text-md font-medium mb-2">Bulk Edit Shift</h4>
    <input type="hidden" name="dates" id="bulkDates">
    <label class="block mb-2">Start Time
      <select name="start_time" class="input w-full text-base px-3 py-2 border">
        {% for hour in range(0, 24) %}
          {% set formatted = "%02d:00"|format(hour) %}
          {% set hour_val = formatted.split(':')[0]|int %}
          <option value="{{ formatted }}">{{ '%02d:00 %s' % ((hour_val - 1) % 12 + 1, 'AM' if hour_val < 12 else 'PM') }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="block mb-2">End Time
      <select name="end_time" class="input w-full text-base px-3 py-2 border">
        {% for hour in range(0, 24) %}
          {% set formatted = "%02d:00"|format(hour) %}
          {% set hour_val = formatted.split(':')[0]|int %}
          <option value="{{ formatted }}">{{ '%02d:00 %s' % ((hour_val - 1) % 12 + 1, 'AM' if hour_val < 12 else 'PM') }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="block mb-2">Notes
        <textarea name="schedule_details" rows="3" class="input w-full text-base px-3 py-2 border"></textarea>
    </label>
    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded text-base font-semibold">Apply to Selected Days</button>
  </form>
</div>

<script>
let multiSelectMode = false;
let selectedDates = new Set();
let isMouseDown = false;
let draggedThisCycle = new Set();

function toggleMultiSelect() {
  multiSelectMode = !multiSelectMode;
  document.getElementById("multiToggle").textContent = multiSelectMode ? "Disable Multi-Select" : "Enable Multi-Select";
  document.getElementById("bulkForm").classList.toggle("hidden", !multiSelectMode);
  selectedDates.clear();
  draggedThisCycle.clear();
  document.querySelectorAll(".day-tile").forEach(tile => {
  // Only remove highlight if it's not today's tile
  if (!tile.classList.contains("today-highlight")) {
    tile.classList.remove("bg-blue-100", "border-blue-500");
  } else {
    tile.classList.remove("border-blue-500"); // clean up just in case
  }

  const form = document.getElementById("form-" + tile.dataset.date);
  if (form) form.classList.add("hidden");
});

  attachDayListeners();
}

function attachDayListeners() {
  document.querySelectorAll(".day-tile").forEach(tile => {
    const date = tile.dataset.date;
    tile.onmousedown = (e) => {
      if (multiSelectMode) {
        isMouseDown = true;
        draggedThisCycle.clear();
        toggleDay(tile, date);
        e.preventDefault();
      }
    };
    tile.onmouseover = (e) => {
      if (multiSelectMode && isMouseDown && !draggedThisCycle.has(date)) {
        toggleDay(tile, date);
        draggedThisCycle.add(date);
      }
    };
    tile.onmouseup = () => {
      if (multiSelectMode) isMouseDown = false;
    };
    tile.onclick = () => {
      if (!multiSelectMode) {
        document.querySelectorAll('.edit-form').forEach(f => f.classList.add('hidden'));
        const form = document.getElementById('form-' + date);
        if (form) form.classList.remove('hidden');
      }
    }
  });
  document.onmouseup = () => isMouseDown = false;
}

function toggleDay(tile, date) {
  if (selectedDates.has(date)) {
    selectedDates.delete(date);
    tile.classList.remove("bg-blue-100", "border-blue-500");
  } else {
    selectedDates.add(date);
    tile.classList.add("bg-blue-100", "border-blue-500");
  }
  document.getElementById("bulkDates").value = Array.from(selectedDates).join(",");
}

function closeForm(date) {
  const form = document.getElementById("form-" + date);
  if (form) form.classList.add("hidden");
}

document.addEventListener("DOMContentLoaded", attachDayListeners);
</script>
{% endif %}

<div class="mt-10">
    <!-- Weekday initials -->
    <div class="grid grid-cols-7 gap-4 mb-2 text-sm font-semibold text-gray-600">
      {% for day in ["M", "T", "W", "Th", "F", "Sa", "Su"] %}
        <div class="text-center">{{ day }}</div>
      {% endfor %}
    </div>
  
    <!-- Calendar grid -->
    <div class="grid grid-cols-7 gap-4 text-base">
      {% set first_day = now.replace(day=1).weekday() %}
      {% for _ in range(first_day) %}
        <div></div>
      {% endfor %}
  

    {% for day in range(1, days_in_month + 1) %}
      {% set day_str = "%04d-%02d-%02d"|format(year, month, day) %}
      {% set entry = calendar.get(day_str) %}
      {% set is_today = (day_str == today_str) %}
      <div class="relative border p-4 rounded hover:bg-gray-100 min-h-[8rem] cursor-pointer day-tile {{ 'bg-blue-100 font-semibold border-blue-300 today-highlight' if is_today else '' }}" data-date="{{ day_str }}">
        <div class="font-bold text-lg">{{ day }}</div>
        {% if entry %}
          <div class="text-sm text-gray-700">
            {{ entry.start_time | ampm }} – {{ entry.end_time | ampm }}
          </div>
        {% else %}
          <div class="text-sm text-gray-400 italic">No shift</div>
        {% endif %}

        {% if session.user.role == 'admin' %}
        <form method="POST"
        action="{{ url_for('dashboard.update_schedule', rad_id=doctor.id) }}"
        class="absolute left-1/2 transform -translate-x-1/2 bg-white z-10 shadow p-3 rounded text-base mt-2 border border-gray-300 w-[30rem] hidden edit-form"
        id="form-{{ day_str }}">

          <div class="flex justify-between mb-2">
            <span class="text-base font-medium">Edit {{ day_str }}</span>
            <button type="button" onclick="closeForm('{{ day_str }}'); event.stopPropagation();"
                class="text-gray-500 hover:text-black text-3xl leading-none font-bold">×</button>
          </div>

          <input type="hidden" name="date" value="{{ day_str }}">

          <label class="block mb-1 text-base font-medium">Start Time
            <select name="start_time" class="input w-full text-base px-3 py-2 border">
              {% for hour in range(0, 24) %}
                {% set formatted = "%02d:00"|format(hour) %}
                <option value="{{ formatted }}" {% if entry.start_time and entry.start_time[:5] == formatted %}selected{% endif %}>{{ '%02d:00 %s' % ((hour - 1) % 12 + 1, 'AM' if hour < 12 else 'PM') }}</option>
              {% endfor %}
            </select>
          </label>

          <label class="block mb-1 text-base font-medium">End Time
            <select name="end_time" class="input w-full text-base px-3 py-2 border">
              {% for hour in range(0, 24) %}
                {% set formatted = "%02d:00"|format(hour) %}
                <option value="{{ formatted }}" {% if entry.end_time and entry.end_time[:5] == formatted %}selected{% endif %}>{{ '%02d:00 %s' % ((hour - 1) % 12 + 1, 'AM' if hour < 12 else 'PM') }}</option>
              {% endfor %}
            </select>
          </label>

          <label class="block mb-2 text-base font-medium">Notes
            <textarea name="schedule_details" rows="3" class="input w-full text-base px-3 py-2 border">{{ entry.schedule_details or '' }}</textarea>
          </label>

          <div class="flex justify-between items-center mt-2">
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded text-base font-semibold">Save</button>
            <a href="{{ url_for('dashboard.delete_schedule', rad_id=doctor.id, date=day_str) }}" class="text-red-500 text-xs">Delete</a>
          </div>
        </form>
        {% endif %}
      </div>
    {% endfor %}
  </div>
</div>

<div id="certModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg w-[90%] max-w-3xl max-h-[80vh] overflow-y-auto p-6 relative">
    <button onclick="closeCertModal()" class="absolute top-2 right-2 text-2xl font-bold text-gray-500 hover:text-black">×</button>
    <h3 class="text-xl font-semibold mb-4">Licenses for {{ doctor.name }}</h3>

    <div class="mb-4">
      <input type="text" placeholder="Search licenses..." oninput="filterCerts(this.value)"
             class="w-full mb-4 px-3 py-2 border rounded text-sm">
    </div>

    <ul id="certList" class="space-y-3 text-sm">
     {% for cert in certifications %}
     <li class="border rounded p-3 bg-gray-50 flex justify-between items-center cert-item">
       <div>
         <p><strong>{{ cert.state }}</strong> — expires <span class="text-gray-700">{{ cert.expiration_date }}</span></p>
         <p class="text-xs text-gray-500">{{ cert.status | capitalize }}</p>
       </div>
   
       <form method="POST" action="{{ url_for('dashboard.delete_certification', cert_id=cert.id, rad_id=doctor.id) }}" class="ml-4">
         <button type="submit" class="text-red-600 hover:text-red-800">Delete</button>
       </form>
     </li>
     {% endfor %}
   </ul>          
 

  <form method="POST" action="{{ url_for('dashboard.add_certification', rad_id=doctor.id) }}" class="mt-6 border-t pt-4">
    <h4 class="text-md font-semibold mb-2">Add New Certification</h4>
  
    <label class="block mb-2">
      <span class="font-semibold">State</span>
      <input type="text" name="state" required class="w-full border rounded px-3 py-2 text-sm">
    </label>
  
    <label class="block mb-2">
      <span class="font-semibold">Expiration Date</span>
      <input type="date" name="expiration_date" required class="w-full border rounded px-3 py-2 text-sm">
    </label>
  
    <label class="block mb-2">
      <span class="font-semibold">Status</span>
      <select name="status" class="w-full border rounded px-3 py-2 text-sm">
        <option value="Active">Active</option>
        <option value="Expired">Expired</option>
      </select>
    </label>
    <label class="block mb-2">
      <span class="font-semibold">Specialty</span>
      <input type="text" name="specialty" class="w-full border rounded px-3 py-2 text-sm">
    </label>
    
    <label class="block mb-2">
      <span class="font-semibold">Tags (comma separated)</span>
      <input type="text" name="tags" class="w-full border rounded px-3 py-2 text-sm">
    </label>
    
    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-semibold mt-2">
      Add Certification
    </button>
  </form>
  
</div>
</div>

<script>
  function openCertModal() {
    document.getElementById('certModal').classList.remove('hidden');
  }
  
  function closeCertModal() {
    document.getElementById('certModal').classList.add('hidden');
  }
  
  function filterCerts(query) {
    const items = document.querySelectorAll('.cert-item');
    const q = query.toLowerCase();
  
    items.forEach(item => {
      const text = item.innerText.toLowerCase();
      item.style.display = text.includes(q) ? '' : 'none';
    });
  }
  </script>
  
<div id="facilityModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg w-[90%] max-w-3xl max-h-[80vh] overflow-y-auto p-6 relative">
    <button onclick="closeFacilityModal()" class="absolute top-2 right-2 text-2xl font-bold text-gray-500 hover:text-black">×</button>
    <h3 class="text-xl font-semibold mb-4">Facilities for {{ doctor.name }}</h3>

    <div class="flex justify-between items-center mb-4">
      <input type="text" placeholder="Search facilities..." oninput="filterFacilities(this.value)"
             class="w-full mr-4 px-3 py-2 border rounded text-sm">
      <button onclick="openAddFacilityModal()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-medium">
        Add Facility
      </button>
    </div>
    
    <ul id="facilityList" class="space-y-3 text-sm">
      {% for assignment in assigned_facilities %}
      <form method="POST" action="{{ url_for('dashboard.update_assignment', assignment_id=assignment.id) }}">
        <li class="border rounded p-3 bg-gray-50 facility-item">
          <div class="flex items-center justify-between">
            <div class="text-gray-700 font-medium">{{ assignment.facilities.name }}</div>
            <div class="flex items-center gap-2">
              <label><input type="checkbox" name="can_read" {% if assignment.can_read %}checked{% endif %}> Read</label>
              <label><input type="checkbox" name="does_stats" {% if assignment.does_stats %}checked{% endif %}> Stats</label>
              <label><input type="checkbox" name="does_routines" {% if assignment.does_routines %}checked{% endif %}> Routine</label>
            </div>
          </div>
    
          <textarea name="stipulations" class="w-full border rounded mt-2" placeholder="Stipulations">{{ assignment.stipulations }}</textarea>
          <textarea name="notes" class="w-full border rounded mt-2" placeholder="Notes">{{ assignment.notes }}</textarea>
    
          <div class="flex justify-between items-center mt-2">
            <button type="submit" class="bg-blue-600 text-white text-sm px-3 py-1 rounded">Save Changes</button>
            <button type="button" onclick="deleteAssignment('{{ assignment.id }}')" class="text-red-600 text-sm hover:underline">Remove Assignment</button>
          </div>
        </li>
      </form>
      {% else %}
      <li class="text-gray-500 italic text-center py-4">No facilities assigned yet.</li>
      {% endfor %}
    </ul>
  </div>
</div>

<!-- Add Facility Modal -->
<div id="addFacilityModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg w-[90%] max-w-2xl p-6 relative">
    <button onclick="closeAddFacilityModal()" class="absolute top-2 right-2 text-2xl font-bold text-gray-500 hover:text-black">×</button>
    <h3 class="text-xl font-semibold mb-4">Add Facility Assignment</h3>

    <form method="POST" action="{{ url_for('dashboard.add_facility_assignment', rad_id=doctor.id) }}" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Select Facility</label>
        <select name="facility_id" required class="w-full border rounded px-3 py-2 text-sm select2-facility">
          <option value="">Choose a facility...</option>
          {% for facility in available_facilities %}
          <option value="{{ facility.id }}">{{ facility.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="flex items-center gap-4">
        <label class="flex items-center">
          <input type="checkbox" name="can_read" class="form-checkbox h-4 w-4 text-blue-600">
          <span class="ml-2 text-sm">Can Read</span>
        </label>
        <label class="flex items-center">
          <input type="checkbox" name="does_stats" class="form-checkbox h-4 w-4 text-blue-600">
          <span class="ml-2 text-sm">Does Stats</span>
        </label>
        <label class="flex items-center">
          <input type="checkbox" name="does_routines" class="form-checkbox h-4 w-4 text-blue-600">
          <span class="ml-2 text-sm">Does Routines</span>
        </label>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Stipulations</label>
        <textarea name="stipulations" class="w-full border rounded px-3 py-2 text-sm" rows="2"></textarea>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
        <textarea name="notes" class="w-full border rounded px-3 py-2 text-sm" rows="2"></textarea>
      </div>

      <div class="flex justify-end">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-medium">
          Add Assignment
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  function openFacilityModal() {
    document.getElementById('facilityModal').classList.remove('hidden');
  }
  
  function closeFacilityModal() {
    document.getElementById('facilityModal').classList.add('hidden');
  }
  
  function openAddFacilityModal() {
    document.getElementById('addFacilityModal').classList.remove('hidden');
    // Initialize Select2 when modal opens
    $('.select2-facility').select2({
      dropdownParent: $('#addFacilityModal'),
      width: '100%',
      placeholder: 'Search for a facility...',
      allowClear: true,
      minimumInputLength: 1,
      theme: 'classic'
    });
  }
  
  function closeAddFacilityModal() {
    document.getElementById('addFacilityModal').classList.add('hidden');
    // Destroy Select2 when modal closes to prevent conflicts
    $('.select2-facility').select2('destroy');
  }
  
  function filterFacilities(query) {
    const items = document.querySelectorAll('.facility-item');
    const q = query.toLowerCase();
  
    items.forEach(item => {
      const text = item.innerText.toLowerCase();
      item.style.display = text.includes(q) ? '' : 'none';
    });
  }

  function deleteAssignment(assignmentId) {
    if (confirm('Are you sure you want to remove this facility assignment?')) {
      fetch(`/dashboard/assignments/${assignmentId}/delete`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      }).then(() => {
        window.location.reload();
      });
    }
  }
</script>

<style>
/* Custom Select2 styles */
.select2-container--classic .select2-selection--single {
  height: 38px !important;
  border: 1px solid #d1d5db !important;
  border-radius: 0.375rem !important;
}
.select2-container--classic .select2-selection--single .select2-selection__rendered {
  line-height: 38px !important;
  padding-left: 12px !important;
}
.select2-container--classic .select2-selection--single .select2-selection__arrow {
  height: 36px !important;
}
.select2-container--classic .select2-results__option {
  padding: 8px 12px !important;
}
.select2-container--classic .select2-results__option--highlighted[aria-selected] {
  background-color: #2563eb !important;
}
.select2-dropdown {
  border: 1px solid #d1d5db !important;
  border-radius: 0.375rem !important;
}
</style>

{% endblock %}
