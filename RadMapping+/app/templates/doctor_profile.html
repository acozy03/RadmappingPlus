{% extends "layout.html" %}
{% block title %}Doctor Profile{% endblock %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
{% endblock %}

{% block content %}


<div x-data="{ editing: false }">
  <div class="mb-8">
    <div class="bg-white rounded-lg shadow p-6 border flex flex-col sm:flex-row items-center justify-between gap-4{% if doctor.active_status %} border-green-500{% else %} border-red-500{% endif %}">
      <h2 class="text-3xl font-bold text-blue-800 text-center sm:text-left mb-2 sm:mb-0 flex-1">
        {{ doctor.name }}
      </h2>
      {% if session.user.role == 'admin' %}
        <button @click="editing = !editing" class="inline-flex items-center gap-2 px-5 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition text-base font-semibold focus:outline-none focus:ring-2 focus:ring-blue-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5h2m-1 0v14m-7-7h14" /></svg>
          <span x-show="!editing">Edit Info</span>
          <span x-show="editing">Cancel Edit</span>
        </button>
      {% endif %}
    </div>
  </div>

  <div x-show="!editing" class="mb-8">
    <div class="bg-white rounded-lg shadow p-6 border grid grid-cols-1 sm:grid-cols-2 gap-6">
      <div class="flex items-center space-x-3">
        <span class="inline-flex items-center justify-center w-8 h-8 bg-blue-100 text-blue-600 rounded-full">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 01-8 0m8 0a4 4 0 00-8 0m8 0V8a4 4 0 00-8 0v4m8 0v4a4 4 0 01-8 0v-4" /></svg>
        </span>
        <div>
          <div class="text-xs text-gray-500 font-semibold uppercase">Email</div>
          <div class="text-base font-medium text-gray-900">{{ doctor.email }}</div>
        </div>
      </div>
      <div class="flex items-center space-x-3">
        <span class="inline-flex items-center justify-center w-8 h-8 bg-green-100 text-green-600 rounded-full">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h2l.4 2M7 13h10l4-8H5.4M7 13l-1.35 2.7A2 2 0 007.52 19h8.96a2 2 0 001.87-2.3L17 13M7 13V6a1 1 0 011-1h6a1 1 0 011 1v7" /></svg>
        </span>
        <div>
          <div class="text-xs text-gray-500 font-semibold uppercase">Phone</div>
          <div class="text-base font-medium text-gray-900">{{ doctor.phone }}</div>
        </div>
      </div>
      <div class="flex items-center space-x-3">
        <span class="inline-flex items-center justify-center w-8 h-8 bg-purple-100 text-purple-600 rounded-full">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2a2 2 0 012-2h2a2 2 0 012 2v2m-6 0a2 2 0 002 2h2a2 2 0 002-2m-6 0V7a2 2 0 012-2h2a2 2 0 012 2v10" /></svg>
        </span>
        <div>
          <div class="text-xs text-gray-500 font-semibold uppercase">PACS</div>
          <div class="text-base font-medium text-gray-900">{{ doctor.pacs }}</div>
        </div>
      </div>
      <div class="flex items-center space-x-3">
        <span class="inline-flex items-center justify-center w-8 h-8 bg-yellow-100 text-yellow-600 rounded-full">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
        </span>
        <div>
          <div class="text-xs text-gray-500 font-semibold uppercase">Primary Method</div>
          <div class="text-base font-medium text-gray-900">{{ doctor.primary_contact_method }}</div>
        </div>
      </div>
      <div class="flex items-center space-x-3">
        <span class="inline-flex items-center justify-center w-8 h-8 bg-pink-100 text-pink-600 rounded-full">
          <!-- Stethoscope icon for Modalities -->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 18a4 4 0 008 0m-8 0V7a4 4 0 018 0v11m-8 0a4 4 0 008 0" /></svg>
        </span>
        <div>
          <div class="text-xs text-gray-500 font-semibold uppercase">Modalities</div>
          <div class="text-base font-medium text-gray-900">{{ doctor.modalities or "—" }}</div>
        </div>
      </div>
      <div class="flex items-center space-x-3">
        <span class="inline-flex items-center justify-center w-8 h-8 bg-indigo-100 text-indigo-600 rounded-full">
          <!-- Clock icon for Timezone -->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        </span>
        <div>
          <div class="text-xs text-gray-500 font-semibold uppercase">Timezone</div>
          <div class="text-base font-medium text-gray-900">{{ doctor.timezone or "—" }}</div>
        </div>
      </div>
      <div class="flex items-center space-x-3">
        <span class="inline-flex items-center justify-center w-8 h-8 bg-cyan-100 text-cyan-600 rounded-full">
          <!-- Graduation cap icon for Fellowship -->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5zm0 0v6m0 0H6m6 0h6" /></svg>
        </span>
        <div>
          <div class="text-xs text-gray-500 font-semibold uppercase">Fellowship</div>
          {% if doctor_specialty %}
            <div class="text-base font-medium text-gray-900">{{ doctor_specialty }}</div>
          {% else %}
            <div class="text-gray-400 italic">No Fellowship</div>
          {% endif %}
        </div>
      </div>
      {% if doctor_specialties and doctor_specialties|length > 0 %}
      <div class="flex items-center space-x-3">
        <span class="inline-flex items-center justify-center w-8 h-8 bg-orange-100 text-orange-600 rounded-full">
          <!-- Star icon for Specialties -->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l2.036 6.29a1 1 0 00.95.69h6.631c.969 0 1.371 1.24.588 1.81l-5.37 3.905a1 1 0 00-.364 1.118l2.036 6.29c.3.921-.755 1.688-1.54 1.118l-5.37-3.905a1 1 0 00-1.176 0l-5.37 3.905c-.784.57-1.838-.197-1.54-1.118l2.036-6.29a1 1 0 00-.364-1.118L2.342 11.717c-.783-.57-.38-1.81.588-1.81h6.631a1 1 0 00.95-.69l2.036-6.29z" /></svg>
        </span>
        <div>
          <div class="text-xs text-gray-500 font-semibold uppercase">Specialties</div>
          <div class="flex flex-wrap gap-2 mt-1">
            {% for spec in doctor_specialties %}
              <span class="inline-block bg-orange-200 text-orange-800 px-2 py-1 rounded text-xs font-semibold">{{ spec.name }}</span>
            {% endfor %}
          </div>
        </div>
      </div>
      {% else %}
      <div class="flex items-center space-x-3">
        <span class="inline-flex items-center justify-center w-8 h-8 bg-orange-100 text-orange-600 rounded-full">
          <!-- Star icon for Specialties -->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l2.036 6.29a1 1 0 00.95.69h6.631c.969 0 1.371 1.24.588 1.81l-5.37 3.905a1 1 0 00-.364 1.118l2.036 6.29c.3.921-.755 1.688-1.54 1.118l-5.37-3.905a1 1 0 00-1.176 0l-5.37 3.905c-.784.57-1.838-.197-1.54-1.118l2.036-6.29a1 1 0 00-.364-1.118L2.342 11.717c-.783-.57-.38-1.81.588-1.81h6.631a1 1 0 00.95-.69l2.036-6.29z" /></svg>
        </span>
        <div>
          <div class="text-xs text-gray-500 font-semibold uppercase">Specialties</div>
          <div class="text-gray-400 italic">No Specialties</div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <div x-show="editing" class="mb-8">
    <form method="POST" action="{{ url_for('doctors.update_doctor', rad_id=doctor.id) }}" class="bg-white rounded-lg shadow p-6 border grid grid-cols-1 sm:grid-cols-2 gap-6">
      <label class="block">
        <span class="font-semibold">Email</span>
        <input type="email" name="email" value="{{ doctor.email or '' }}" class="input w-full border rounded px-3 py-2 text-sm" />
      </label>
      <label class="block">
        <span class="font-semibold">Phone</span>
        <input type="text" name="phone" value="{{ doctor.phone or '' }}" class="input w-full border rounded px-3 py-2 text-sm" />
      </label>
      <label class="block">
        <span class="font-semibold">PACS</span>
        <input type="text" name="pacs" value="{{ doctor.pacs or '' }}" class="input w-full border rounded px-3 py-2 text-sm" />
      </label>
      <label class="block">
        <span class="font-semibold">Primary Contact Method</span>
        <input type="text" name="primary_contact_method" value="{{ doctor.primary_contact_method or '' }}" class="input w-full border rounded px-3 py-2 text-sm" />
      </label>
      <label class="block">
        <span class="font-semibold">Modalities</span>
        <input type="text" name="modalities" value="{{ doctor.modalities or '' }}" class="input w-full border rounded px-3 py-2 text-sm" />
      </label>
      <label class="block">
        <span class="font-semibold">Timezone</span>
        <input type="text" name="timezone" value="{{ doctor.timezone or '' }}" class="input w-full border rounded px-3 py-2 text-sm" />
      </label>
      <label class="flex items-center space-x-2 mt-4">
        <input type="checkbox" name="active_status" value="true" {% if doctor.active_status %}checked{% endif %} class="form-checkbox h-5 w-5 text-blue-600">
        <span class="text-sm font-medium">Active</span>
      </label>
      <div class="col-span-2">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-semibold mt-2">
          Save Changes
        </button>
      </div>
    </form>
  </div>

  <div class="mt-8 flex flex-col md:flex-row gap-6">
    <div class="flex-1 min-w-0">
      <div class="bg-white rounded-lg shadow p-6 border flex flex-col items-center justify-center h-full text-center">
        <h3 class="font-semibold text-lg mb-2 text-blue-800">Additional Info</h3>
        {% if doctor.additional_info %}
          <p class="text-gray-700 break-words">{{ doctor.additional_info }}</p>
        {% else %}
          <p class="text-gray-400 italic">No additional info provided.</p>
        {% endif %}
      </div>
    </div>
    <div class="flex-1 min-w-0 flex flex-col">
      <div class="bg-white rounded-lg shadow p-6 border flex flex-col items-center justify-center h-full text-center">
        <h3 class="text-xl font-semibold mb-4">Licenses</h3>
        <div class="flex-1"></div>
        <button onclick="openCertModal()" class="text-blue-600 hover:underline w-full mt-auto">View Licenses</button>
      </div>
    </div>
    <div class="flex-1 min-w-0 flex flex-col">
      <div class="bg-white rounded-lg shadow p-6 border flex flex-col items-center justify-center h-full text-center">
        <h3 class="text-xl font-semibold mb-4">Assigned Facilities</h3>
        <div class="flex-1"></div>
        <button onclick="openFacilityModal()" class="text-blue-600 hover:underline w-full mt-auto">View Facilities</button>
      </div>
    </div>
  </div>
  <hr class="my-10 border-t-2 border-gray-200">

  {% if session.user.role == 'admin' %}
  <div class="mt-10">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-semibold">Edit Schedule: {{ now.strftime('%B %Y') }}</h3>
      <div>
        <button onclick="toggleMultiSelect()" class="text-sm text-blue-600 hover:underline mr-4" id="multiToggle">Enable Multi-Select</button>
        <a href="{{ url_for('doctors.doctor_profile', rad_id=doctor.id, year=prev_year, month=prev_month) }}" class="text-blue-600 hover:underline mr-4">← Prev</a>
        <a href="{{ url_for('doctors.doctor_profile', rad_id=doctor.id, year=next_year, month=next_month) }}" class="text-blue-600 hover:underline">Next →</a>
      </div>
    </div>

    <form method="POST" action="{{ url_for('doctors.bulk_update_schedule', rad_id=doctor.id) }}" class="bg-gray-100 p-4 rounded border mb-6 hidden" id="bulkForm">
      <h4 class="text-md font-medium mb-2">Bulk Edit Shift</h4>
      <input type="hidden" name="dates" id="bulkDates">
      <label class="block mb-2">Start Time
        <select name="start_time" class="input w-full text-base px-3 py-2 border">
          {% for hour in range(0, 24) %}
            {% set formatted = "%02d:00"|format(hour) %}
            {% set hour_val = formatted.split(':')[0]|int %}
            <option value="{{ formatted }}">{{ '%02d:00 %s' % ((hour_val - 1) % 12 + 1, 'AM' if hour_val < 12 else 'PM') }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="block mb-2">End Time
        <select name="end_time" class="input w-full text-base px-3 py-2 border">
          {% for hour in range(0, 24) %}
            {% set formatted = "%02d:00"|format(hour) %}
            {% set hour_val = formatted.split(':')[0]|int %}
            <option value="{{ formatted }}">{{ '%02d:00 %s' % ((hour_val - 1) % 12 + 1, 'AM' if hour_val < 12 else 'PM') }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="block mb-2">Notes
          <textarea name="schedule_details" rows="3" class="input w-full text-base px-3 py-2 border"></textarea>
      </label>
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded text-base font-semibold">Apply to Selected Days</button>
    </form>
  </div>

  <script>
  let multiSelectMode = false;
  let selectedDates = new Set();
  let isMouseDown = false;
  let draggedThisCycle = new Set();

  function toggleMultiSelect() {
    multiSelectMode = !multiSelectMode;
    document.getElementById("multiToggle").textContent = multiSelectMode ? "Disable Multi-Select" : "Enable Multi-Select";
    document.getElementById("bulkForm").classList.toggle("hidden", !multiSelectMode);
    selectedDates.clear();
    draggedThisCycle.clear();
    document.querySelectorAll(".day-tile").forEach(tile => {
    // Only remove highlight if it's not today's tile
    if (!tile.classList.contains("today-highlight")) {
      tile.classList.remove("bg-blue-100", "border-blue-500");
    } else {
      tile.classList.remove("border-blue-500"); // clean up just in case
    }

    const form = document.getElementById("form-" + tile.dataset.date);
    if (form) form.classList.add("hidden");
  });

    attachDayListeners();
  }

  function attachDayListeners() {
    document.querySelectorAll(".day-tile").forEach(tile => {
      const date = tile.dataset.date;
      tile.onmousedown = (e) => {
        if (multiSelectMode) {
          isMouseDown = true;
          draggedThisCycle.clear();
          toggleDay(tile, date);
          e.preventDefault();
        }
      };
      tile.onmouseover = (e) => {
        if (multiSelectMode && isMouseDown && !draggedThisCycle.has(date)) {
          toggleDay(tile, date);
          draggedThisCycle.add(date);
        }
      };
      tile.onmouseup = () => {
        if (multiSelectMode) isMouseDown = false;
      };
      tile.onclick = () => {
        if (!multiSelectMode) {
          document.querySelectorAll('.edit-form').forEach(f => f.classList.add('hidden'));
          const form = document.getElementById('form-' + date);
          if (form) form.classList.remove('hidden');
        }
      }
    });
    document.onmouseup = () => isMouseDown = false;
  }

  function toggleDay(tile, date) {
    if (selectedDates.has(date)) {
      selectedDates.delete(date);
      tile.classList.remove("bg-blue-100", "border-blue-500");
    } else {
      selectedDates.add(date);
      tile.classList.add("bg-blue-100", "border-blue-500");
    }
    document.getElementById("bulkDates").value = Array.from(selectedDates).join(",");
  }

  function closeForm(date) {
    const form = document.getElementById("form-" + date);
    if (form) form.classList.add("hidden");
  }

  document.addEventListener("DOMContentLoaded", attachDayListeners);
  </script>
  {% endif %}

  <div class="mt-10">
      <!-- Weekday initials -->
      <div class="grid grid-cols-7 gap-4 mb-2 text-sm font-semibold text-gray-600">
        {% for day in ["M", "T", "W", "Th", "F", "Sa", "Su"] %}
          <div class="text-center">{{ day }}</div>
        {% endfor %}
      </div>
    
      <!-- Calendar grid -->
      <div class="grid grid-cols-7 gap-4 text-base">
        {% set first_day = now.replace(day=1).weekday() %}
        {% for _ in range(first_day) %}
          <div></div>
        {% endfor %}
    

      {% for day in range(1, days_in_month + 1) %}
        {% set day_str = "%04d-%02d-%02d"|format(year, month, day) %}
        {% set entry = calendar.get(day_str) %}
        {% set is_today = (day_str == today_str) %}
        <div class="relative border p-4 rounded hover:bg-gray-100 min-h-[8rem] cursor-pointer day-tile {{ 'bg-blue-100 font-semibold border-blue-300 today-highlight' if is_today else '' }}" data-date="{{ day_str }}">
          <div class="font-bold text-lg">{{ day }}</div>
          {% if entry %}
            <div class="text-sm text-gray-700">
              {{ entry.start_time | ampm }} – {{ entry.end_time | ampm }}
            </div>
          {% else %}
            <div class="text-sm text-gray-400 italic">No shift</div>
          {% endif %}

          {% if session.user.role == 'admin' %}
          <form method="POST"
          action="{{ url_for('doctors.update_schedule', rad_id=doctor.id) }}"
          class="absolute left-1/2 transform -translate-x-1/2 bg-white z-10 shadow p-3 rounded text-base mt-2 border border-gray-300 w-[30rem] hidden edit-form"
          id="form-{{ day_str }}">

            <div class="flex justify-between mb-2">
              <span class="text-base font-medium">Edit {{ day_str }}</span>
              <button type="button" onclick="closeForm('{{ day_str }}'); event.stopPropagation();"
                  class="text-gray-500 hover:text-black text-3xl leading-none font-bold">×</button>
            </div>

            <input type="hidden" name="date" value="{{ day_str }}">

            <label class="block mb-1 text-base font-medium">Start Time
              <select name="start_time" class="input w-full text-base px-3 py-2 border">
                {% for hour in range(0, 24) %}
                  {% set formatted = "%02d:00"|format(hour) %}
                  <option value="{{ formatted }}" {% if entry.start_time and entry.start_time[:5] == formatted %}selected{% endif %}>{{ '%02d:00 %s' % ((hour - 1) % 12 + 1, 'AM' if hour < 12 else 'PM') }}</option>
                {% endfor %}
              </select>
            </label>

            <label class="block mb-1 text-base font-medium">End Time
              <select name="end_time" class="input w-full text-base px-3 py-2 border">
                {% for hour in range(0, 24) %}
                  {% set formatted = "%02d:00"|format(hour) %}
                  <option value="{{ formatted }}" {% if entry.end_time and entry.end_time[:5] == formatted %}selected{% endif %}>{{ '%02d:00 %s' % ((hour - 1) % 12 + 1, 'AM' if hour < 12 else 'PM') }}</option>
                {% endfor %}
              </select>
            </label>

            <label class="block mb-2 text-base font-medium">Notes
              <textarea name="schedule_details" rows="3" class="input w-full text-base px-3 py-2 border">{{ entry.schedule_details or '' }}</textarea>
            </label>

            <div class="flex justify-between items-center mt-2">
              <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded text-base font-semibold">Save</button>
              <a href="{{ url_for('doctors.delete_schedule', rad_id=doctor.id, date=day_str) }}" class="text-red-500 text-xs">Delete</a>
            </div>
          </form>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>

  <div id="certModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center" onclick="if(event.target === this) closeCertModal();">
    <div class="bg-white rounded-lg shadow-lg w-[90%] max-w-3xl max-h-[80vh] overflow-y-auto p-6 relative" onclick="event.stopPropagation();">
      <button onclick="closeCertModal()" class="absolute top-2 right-2 text-2xl font-bold text-gray-500 hover:text-black">×</button>
      <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
        <span class="inline-flex items-center justify-center w-8 h-8 bg-green-100 text-green-600 rounded-full">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        </span>
        Licenses for {{ doctor.name }}
      </h3>
      <div class="mb-4">
        <input type="text" placeholder="Search by state..." oninput="filterCerts(this.value)"
               class="w-full mb-4 px-3 py-2 border rounded text-sm">
      </div>
      <ul id="certList" class="space-y-3 text-sm">
       {% for cert in certifications %}
       <li class="border rounded p-4 bg-gray-50 flex justify-between items-center cert-item shadow-sm">
         <div class="flex items-center gap-3">
           <span class="inline-flex items-center justify-center w-8 h-8 rounded-full
             {% if cert.status|lower == 'active' %}bg-blue-100 text-blue-600{% else %}bg-red-100 text-red-600{% endif %}">
             {% if cert.status|lower == 'active' %}
             <!-- Checkmark icon -->
             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
             {% else %}
             <!-- X icon -->
             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
             {% endif %}
           </span>
           <div>
             <p class="font-semibold text-gray-800">{{ cert.state }}</p>
             <p class="text-xs text-gray-500">Expires <span class="text-gray-700">{{ cert.expiration_date }}</span></p>
             <p class="text-xs text-gray-500">{{ cert.status | capitalize }}</p>
           </div>
         </div>
         {% if session.user.role == 'admin' %}
         <form method="POST" action="{{ url_for('doctors.delete_certification', cert_id=cert.id, rad_id=doctor.id) }}" class="ml-4">
           <button type="submit" class="text-red-600 hover:text-red-800">Delete</button>
         </form>
         {% endif %}
       </li>
       {% endfor %}
     </ul>          
     <form method="POST" action="{{ url_for('doctors.add_certification', rad_id=doctor.id) }}" class="mt-6 border-t pt-4">
      <h4 class="text-md font-semibold mb-2">Add New Certification</h4>
      <label class="block mb-2">
        <span class="font-semibold">State</span>
        <input type="text" name="state" required class="w-full border rounded px-3 py-2 text-sm">
      </label>
      <label class="block mb-2">
        <span class="font-semibold">Expiration Date</span>
        <input type="date" name="expiration_date" required class="w-full border rounded px-3 py-2 text-sm">
      </label>
      <label class="block mb-2">
        <span class="font-semibold">Status</span>
        <select name="status" class="w-full border rounded px-3 py-2 text-sm">
          <option value="Active">Active</option>
          <option value="Expired">Expired</option>
        </select>
      </label>
      <label class="block mb-2">
        <span class="font-semibold">Specialty</span>
        <input type="text" name="specialty" class="w-full border rounded px-3 py-2 text-sm">
      </label>
      <label class="block mb-2">
        <span class="font-semibold">Tags (comma separated)</span>
        <input type="text" name="tags" class="w-full border rounded px-3 py-2 text-sm">
      </label>
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-semibold mt-2">
        Add Certification
      </button>
    </form>
    </div>
  </div>

  <script>
    function openCertModal() {
      document.getElementById('certModal').classList.remove('hidden');
    }
    
    function closeCertModal() {
      document.getElementById('certModal').classList.add('hidden');
    }
    
    function filterCerts(query) {
      const items = document.querySelectorAll('.cert-item');
      const q = query.toLowerCase();
    
      items.forEach(item => {
        const text = item.innerText.toLowerCase();
        item.style.display = text.includes(q) ? '' : 'none';
      });
    }
    </script>
    
  <div id="facilityModal" x-data="{ editMode: false, expanded: {} }" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center" onclick="if(event.target === this) closeFacilityModal();">
    <div class="bg-white rounded-lg shadow-lg w-[98%] max-w-5xl max-h-[90vh] overflow-y-auto p-8 relative" onclick="event.stopPropagation();">
      <button onclick="closeFacilityModal()" class="absolute top-2 right-2 text-2xl font-bold text-gray-500 hover:text-black">×</button>
      <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
        <span class="inline-flex items-center justify-center w-8 h-8 bg-purple-100 text-purple-600 rounded-full">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2a2 2 0 012-2h2a2 2 0 012 2v2m-6 0a2 2 0 002 2h2a2 2 0 002-2m-6 0V7a2 2 0 012-2h2a2 2 0 012 2v10"/></svg>
        </span>
        Facilities for {{ doctor.name }}
      </h3>
      <div class="flex justify-between items-center mb-4">
        <input type="text" placeholder="Search facilities..." oninput="filterFacilities(this.value)"
               class="w-full mr-4 px-3 py-2 border rounded text-sm">
        <div class="flex gap-2">
          <button x-show="!editMode" @click="editMode = true" class="bg-yellow-500 text-white px-4 py-2 rounded text-sm font-medium">Edit Assignments</button>
          <button x-show="editMode" @click="editMode = false" class="bg-gray-300 text-gray-800 px-4 py-2 rounded text-sm font-medium">Cancel Edit</button>
          <button onclick="openAddFacilityModal()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-medium">Add Facility</button>
        </div>
      </div>
      <ul id="facilityList" class="space-y-4 text-sm">
        {% for assignment in assigned_facilities %}
        <li class="facility-item">
          <form method="POST" action="{{ url_for('doctors.update_assignment', assignment_id=assignment.id) }}">
            <div :class="editMode ? '{% if assignment.facilities.active_status %}border-green-500{% else %}border-red-500{% endif %}' : 'border-gray-200'" class="border rounded-lg bg-gray-50 shadow-sm p-4 flex flex-col gap-2">
              <!-- Card summary row -->
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <span class="inline-flex items-center justify-center w-8 h-8 bg-indigo-100 text-indigo-600 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                  </span>
                  <div>
                    <div class="font-semibold text-gray-800">{{ assignment.facilities.name }}</div>
                    <div class="text-xs text-gray-500">Status: <span class="font-medium {% if assignment.facilities.active_status == 'true' %}text-green-700{% else %}text-red-700{% endif %}">{% if assignment.facilities.active_status == 'true' %}Active{% else %}Inactive{% endif %}</span></div>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <span class="inline-flex items-center gap-1 text-xs {% if assignment.can_read %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %} px-2 py-1 rounded" title="Can Read">Read: <span class="font-bold">{{ 'Yes' if assignment.can_read else 'No' }}</span></span>
                  <span class="inline-flex items-center gap-1 text-xs {% if assignment.does_stats %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %} px-2 py-1 rounded" title="Does Stats">Stats: <span class="font-bold">{{ 'Yes' if assignment.does_stats else 'No' }}</span></span>
                  <span class="inline-flex items-center gap-1 text-xs {% if assignment.does_routines %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %} px-2 py-1 rounded" title="Does Routines">Routine: <span class="font-bold">{{ 'Yes' if assignment.does_routines else 'No' }}</span></span>
                </div>
              </div>
              <!-- Details always shown -->
              <div class="mt-2 border-t pt-2">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                  <div>
                    <div class="text-xs text-gray-500 font-semibold mb-1">Stipulations</div>
                    <div class="text-gray-700 whitespace-pre-line">{{ assignment.stipulations or '—' }}</div>
                  </div>
                  <div>
                    <div class="text-xs text-gray-500 font-semibold mb-1">Notes</div>
                    <div class="text-gray-700 whitespace-pre-line">{{ assignment.notes or '—' }}</div>
                  </div>
                </div>
              </div>
              <!-- Edit mode: show form fields and Save button -->
              <template x-if="editMode">
                <div class="mt-4 border-t pt-4 flex flex-col gap-2">
                  <div class="flex items-center gap-4 flex-wrap">
                    <label class="flex items-center gap-1"><input type="checkbox" name="can_read" {% if assignment.can_read %}checked{% endif %}> <span>Read</span></label>
                    <label class="flex items-center gap-1"><input type="checkbox" name="does_stats" {% if assignment.does_stats %}checked{% endif %}> <span>Stats</span></label>
                    <label class="flex items-center gap-1"><input type="checkbox" name="does_routines" {% if assignment.does_routines %}checked{% endif %}> <span>Routine</span></label>
                  </div>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                    <textarea name="stipulations" class="w-full border rounded mt-2" placeholder="Stipulations">{{ assignment.stipulations }}</textarea>
                    <textarea name="notes" class="w-full border rounded mt-2" placeholder="Notes">{{ assignment.notes }}</textarea>
                  </div>
                  <div class="flex gap-2 mt-2">
                    <button type="submit" class="bg-blue-600 text-white text-sm px-3 py-1 rounded">Save Changes</button>
                  </div>
                </div>
              </template>
              <!-- Edit mode: Remove Assignment button at the bottom -->
              <template x-if="editMode">
                <form method="POST" action="{{ url_for('doctors.delete_assignment', assignment_id=assignment.id) }}" class="mt-4 flex justify-end">
                  <button type="submit" class="text-red-600 text-sm hover:underline">Remove Assignment</button>
                </form>
              </template>
            </div>
          </form>
        </li>
        {% else %}
        <li class="text-gray-500 italic text-center py-4">No facilities assigned yet.</li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <!-- Add Facility Modal -->
  <div id="addFacilityModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-lg w-[90%] max-w-2xl p-6 relative">
      <button onclick="closeAddFacilityModal()" class="absolute top-2 right-2 text-2xl font-bold text-gray-500 hover:text-black">×</button>
      <h3 class="text-xl font-semibold mb-4">Add Facility Assignment</h3>

      <form method="POST" action="{{ url_for('doctors.add_facility_assignment', rad_id=doctor.id) }}" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Select Facility</label>
          <select name="facility_id" required class="w-full border rounded px-3 py-2 text-sm select2-facility">
            <option value="">Choose a facility...</option>
            {% for facility in available_facilities %}
            <option value="{{ facility.id }}">{{ facility.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="flex items-center gap-4">
          <label class="flex items-center">
            <input type="checkbox" name="can_read" class="form-checkbox h-4 w-4 text-blue-600">
            <span class="ml-2 text-sm">Can Read</span>
          </label>
          <label class="flex items-center">
            <input type="checkbox" name="does_stats" class="form-checkbox h-4 w-4 text-blue-600">
            <span class="ml-2 text-sm">Does Stats</span>
          </label>
          <label class="flex items-center">
            <input type="checkbox" name="does_routines" class="form-checkbox h-4 w-4 text-blue-600">
            <span class="ml-2 text-sm">Does Routines</span>
          </label>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Stipulations</label>
          <textarea name="stipulations" class="w-full border rounded px-3 py-2 text-sm" rows="2"></textarea>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
          <textarea name="notes" class="w-full border rounded px-3 py-2 text-sm" rows="2"></textarea>
        </div>

        <div class="flex justify-end">
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-medium">
            Add Assignment
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    function openFacilityModal() {
      document.getElementById('facilityModal').classList.remove('hidden');
    }
    
    function closeFacilityModal() {
      document.getElementById('facilityModal').classList.add('hidden');
    }
    
    function openAddFacilityModal() {
      document.getElementById('addFacilityModal').classList.remove('hidden');
      // Initialize Select2 when modal opens
      $('.select2-facility').select2({
        dropdownParent: $('#addFacilityModal'),
        width: '100%',
        placeholder: 'Search for a facility...',
        allowClear: true,
        minimumInputLength: 1,
        theme: 'classic'
      });
    }
    
    function closeAddFacilityModal() {
      document.getElementById('addFacilityModal').classList.add('hidden');
      // Destroy Select2 when modal closes to prevent conflicts
      $('.select2-facility').select2('destroy');
    }
    
    function filterFacilities(query) {
      const items = document.querySelectorAll('.facility-item');
      const q = query.toLowerCase();
    
      items.forEach(item => {
        const text = item.innerText.toLowerCase();
        item.style.display = text.includes(q) ? '' : 'none';
      });
    }
  </script>

  <style>
  /* Custom Select2 styles */
  .select2-container--classic .select2-selection--single {
    height: 38px !important;
    border: 1px solid #d1d5db !important;
    border-radius: 0.375rem !important;
  }
  .select2-container--classic .select2-selection--single .select2-selection__rendered {
    line-height: 38px !important;
    padding-left: 12px !important;
  }
  .select2-container--classic .select2-selection--single .select2-selection__arrow {
    height: 36px !important;
  }
  .select2-container--classic .select2-results__option {
    padding: 8px 12px !important;
  }
  .select2-container--classic .select2-results__option--highlighted[aria-selected] {
    background-color: #2563eb !important;
  }
  .select2-dropdown {
    border: 1px solid #d1d5db !important;
    border-radius: 0.375rem !important;
  }
  </style>

  {% if session.user.role == 'admin' %}
  <form method="POST" action="{{ url_for('doctors.remove_doctor', rad_id=doctor.id) }}" onsubmit="return confirm('Are you sure you want to remove this doctor? This action cannot be undone.');" class="mt-4">
    <button type="submit" class="inline-flex items-center gap-2 px-5 py-2 bg-red-600 text-white rounded-lg shadow hover:bg-red-700 transition text-base font-semibold focus:outline-none focus:ring-2 focus:ring-red-400">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      Remove Doctor
    </button>
  </form>
  {% endif %}

</div>

{% endblock %}