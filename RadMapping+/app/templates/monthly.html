{% extends "layout.html" %}
{% block title %}{{ month_name }} Schedule{% endblock %}

{% block content %}
<div class="monthly-page flex flex-col h-[45rem] overflow-hidden">

    <div class="monthly-toolbar flex justify-between items-center mb-6 px-4 py-2">
        <h2 class="text-2xl font-semibold">{{ month_name }} Schedule</h2>
        <div class="flex items-center gap-4">
            <a href="{{ url_for('monthly.monthly', year=year if month > 1 else year-1, month=month-1 if month > 1 else 12, start_day=1) }}" class="text-blue-600 hover:underline">← Previous Month</a>
            <a href="{{ url_for('monthly.monthly', year=year if month < 12 else year+1, month=month+1 if month < 12 else 1, start_day=1) }}" class="text-blue-600 hover:underline">Next Month →</a>

            <div class="flex items-center gap-2">
                <input type="text"
                       class="monthly-input border rounded px-3 py-1 text-base"
                       id="searchInput"
                       placeholder="Search doctors..."
                       onkeyup="handleSearch()">
            </div>
            <select id="scheduleFilter" class="monthly-select border rounded px-2 py-1 text-base">
              <option value="desc" selected>Description Only</option>
                <option value="time" >Time Only</option>

            </select>

            <button onclick="openPinModal()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
                Pin Doctors
            </button>
        </div>
    </div>

    <div id="schedule-container" class="flex-1 min-h-0 overflow-auto max-w-full">
        <div id="schedule-scroll-wrapper" class="w-full border-b border-gray-200 mb-2">
            <table class="monthly-table w-full min-w-[1200px] table-fixed text-base">
                <thead class="monthly-table-header top-0 z-30">
                    <tr class="h-16">
                        <th class="sticky-left-header z-40 w-48 px-4 py-3 font-medium text-left">Doctor</th>
                        {% set today_str = datetime.utcnow().strftime('%Y-%m-%d') %}
                        {% for day in range(1, days_in_month + 1) %}
                            {% set date = datetime(year, month, day) %}
                            {% set date_str = date.strftime('%Y-%m-%d') %}
                            <th data-date="{{ date_str }}" class="w-48 px-4 py-3 text-center{% if date_str == today_str %} today-header bg-blue-50{% endif %}">
                                <div class="font-medium">{{ date.strftime('%a') }}</div>
                                <div class="text-gray-600 text-sm">{{ day }}</div>
                            </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody id="virtual-tbody">
                </tbody>
            </table>
        </div>
    </div>
    <div class="mt-4 px-4 flex-shrink-0">
        <div class="flex gap-2">
            {% if start_doctor > 0 %}
                <a href="{{ url_for('monthly.monthly', year=year, month=month, start_day=1, start_doctor=start_doctor - 15) }}" 
                   class="px-4 py-2 border rounded hover:bg-gray-100 text-blue-600">
                    ← Previous Page
                </a>
            {% endif %}
            {% if (start_doctor // 15) + 1 < total_pages %}
                <a href="{{ url_for('monthly.monthly', year=year, month=month, start_day=1, start_doctor=start_doctor + 15) }}" 
                   class="px-4 py-2 border rounded hover:bg-gray-100 text-blue-600">
                    Next Page →
                </a>
            {% endif %}
        </div>
    </div>
</div>

<div id="toolsModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="monthly-modal bg-white rounded-lg shadow-lg w-[90%] max-w-4xl p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">Scheduling Tools</h3>
      <button onclick="closeToolsModal()" class="text-gray-500 hover:text-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="monthly-tool-card bg-gray-50 p-4 rounded-lg">
        <h4 class="font-medium mb-3">Bulk Schedule</h4>
        <form method="POST" action="{{ url_for('monthly.bulk_schedule') }}" class="space-y-3">
          <select name="doctor" required class="w-full p-2 border rounded">
            <option value="">Select Doctor</option>
            {% for doc in doctors %}
              <option value="{{ doc.id }}">{{ doc.name }}</option>
            {% endfor %}
          </select>
          <div class="flex gap-2">
            <input type="date" name="start_date" required class="flex-1 p-2 border rounded" />
            <input type="date" name="end_date" required class="flex-1 p-2 border rounded" />
          </div>
          <select id="bulkNoTime" class="w-full p-2 border rounded" onchange="handleBulkNoTimeChange()">
            <option value="">-- Time Required --</option>
            <option value="OFF">OFF</option>
            <option value="VACATION">VACATION</option>
            <option value="REACH AS NEEDED">REACH AS NEEDED</option>
          </select>
          <div class="flex gap-2" id="bulkTimeInputs">
            <input type="time" name="start_time" id="bulkStartTime" required class="flex-1 p-2 border rounded" />
            <input type="time" name="end_time" id="bulkEndTime" required class="flex-1 p-2 border rounded" />
          </div>
          <textarea name="schedule_details" id="bulkDetails" placeholder="Schedule details..." class="w-full p-2 border rounded"></textarea>
          <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded">Apply Schedule</button>
        </form>
      </div>

      <div class="monthly-tool-card bg-gray-50 p-4 rounded-lg">
        <h4 class="font-medium mb-3">Pattern Schedule</h4>
        <form method="POST" action="{{ url_for('monthly.pattern_schedule') }}" class="space-y-3">
          <select name="doctor" required class="w-full p-2 border rounded">
            <option value="">Select Doctor</option>
            {% for doc in doctors %}
              <option value="{{ doc.id }}">{{ doc.name }}</option>
            {% endfor %}
          </select>
          <div class="flex gap-2">
            <input type="date" name="start_date" required class="flex-1 p-2 border rounded" />
            <input type="date" name="end_date" required class="flex-1 p-2 border rounded" />
          </div>
          <select id="patternNoTime" class="w-full p-2 border rounded" onchange="handlePatternNoTimeChange()">
            <option value="">-- Time Required --</option>
            <option value="OFF">OFF</option>
            <option value="VACATION">VACATION</option>
            <option value="REACH AS NEEDED">REACH AS NEEDED</option>
          </select>
          <div class="flex gap-2" id="patternTimeInputs">
            <input type="time" name="start_time" id="patternStartTime" required class="flex-1 p-2 border rounded" />
            <input type="time" name="end_time" id="patternEndTime" required class="flex-1 p-2 border rounded" />
          </div>
          <div class="flex flex-wrap gap-2">
            <label class="flex items-center gap-1">
              <input type="checkbox" name="days" value="1" class="form-checkbox" />
              <span>Mon</span>
            </label>
            <label class="flex items-center gap-1">
              <input type="checkbox" name="days" value="2" class="form-checkbox" />
              <span>Tue</span>
            </label>
            <label class="flex items-center gap-1">
              <input type="checkbox" name="days" value="3" class="form-checkbox" />
              <span>Wed</span>
            </label>
            <label class="flex items-center gap-1">
              <input type="checkbox" name="days" value="4" class="form-checkbox" />
              <span>Thu</span>
            </label>
            <label class="flex items-center gap-1">
              <input type="checkbox" name="days" value="5" class="form-checkbox" />
              <span>Fri</span>
            </label>
            <label class="flex items-center gap-1">
              <input type="checkbox" name="days" value="6" class="form-checkbox" />
              <span>Sat</span>
            </label>
            <label class="flex items-center gap-1">
              <input type="checkbox" name="days" value="0" class="form-checkbox" />
              <span>Sun</span>
            </label>
          </div>
          <textarea name="schedule_details" id="patternDetails" placeholder="Schedule details..." class="w-full p-2 border rounded"></textarea>
          <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded">Apply Pattern</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div id="pinModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="monthly-modal bg-white rounded-lg shadow-lg w-[90%] max-w-4xl p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">Pin Doctors</h3>
      <button onclick="closePinModal()" class="text-gray-500 hover:text-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    
    <div class="mb-4">
      <p class="text-gray-600">Select up to 15 doctors to pin to the first page of the schedule.</p>
      <p class="text-sm text-gray-500">Pinned doctors will always appear first on the schedule.</p>
    </div>

    <div class="flex justify-between items-center mb-4">
      <div class="flex-1 mr-4">
        <input type="text" 
               id="pinModalSearch" 
               class="w-full border rounded px-3 py-2" 
               placeholder="Search doctors..."
               oninput="filterPinModalDoctors()">
      </div>
      <div class="flex items-center gap-4">
        <span id="pinCounter" class="text-sm font-medium">0/15 selected</span>
        <button onclick="resetPins()" class="px-3 py-1 text-sm border border-red-500 text-red-500 rounded hover:bg-red-50">
          Reset All
        </button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto" id="pinDoctorsList">
      {% for doctor in all_doctors %}
        <div class="monthly-doctor-item flex items-center gap-2 p-2 border rounded hover:bg-gray-50 doctor-item">
          <input type="checkbox" 
                 id="pin-{{ doctor.id }}" 
                 class="pin-checkbox form-checkbox h-5 w-5 text-purple-600"
                 data-doctor-id="{{ doctor.id }}"
                 data-doctor-name="{{ doctor.name|lower }}"
                 onchange="updatePinCounter()"
                 {% if doctor.id in pinned_doctors %}checked{% endif %}>
          <label for="pin-{{ doctor.id }}" class="flex-1 cursor-pointer">
            {{ doctor.name }}
            {% if doctor.id in pinned_doctors %}
              <span title="Currently Pinned" class="text-yellow-500 text-sm ml-1">⭐</span>
            {% endif %}
          </label>
        </div>
      {% endfor %}
    </div>

    <div class="mt-4 flex justify-end gap-2">
      <button onclick="closePinModal()" class="px-4 py-2 border rounded hover:bg-gray-100">
        Cancel
      </button>
      <button onclick="savePinnedDoctors()" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
        Save Pins
      </button>
    </div>
  </div>
</div>

<style>
table {
  border-collapse: collapse;
}

table, th, td {
  border: none;
}

.table-fixed {
  table-layout: fixed;
}

.monthly-page {
  --monthly-page-text: #111827;
  --monthly-header-bg: #f9fafb;
  --monthly-header-text: #1f2937;
  --monthly-header-muted: #4b5563;
  --monthly-sticky-bg: #ffffff;
  --monthly-sticky-shadow: rgba(15, 23, 42, 0.12);
  --monthly-row-hover: rgba(59, 130, 246, 0.12);
  --monthly-cell-desc: #374151;
  --monthly-cell-time: #111827;
  --monthly-today-bg: #dbeafe;
  --monthly-today-text: #1d4ed8;
  --monthly-today-accent: #2563eb;
  --monthly-border: rgba(209, 213, 219, 0.8);
  --monthly-modal-bg: #ffffff;
  --monthly-modal-border: rgba(209, 213, 219, 0.9);
  --monthly-modal-section-bg: #f3f4f6;
  --monthly-modal-section-border: rgba(209, 213, 219, 0.9);
  --monthly-link: #2563eb;
  --monthly-muted: #6b7280;
  --monthly-badge-bg: #f3e8ff;
  --monthly-badge-text: #6d28d9;
}

[data-theme="dark"] .monthly-page {
  --monthly-page-text: #e2e8f0;
  --monthly-header-bg: rgba(30, 41, 59, 0.85);
  --monthly-header-text: #e2e8f0;
  --monthly-header-muted: #94a3b8;
  --monthly-sticky-bg: rgba(15, 23, 42, 0.95);
  --monthly-sticky-shadow: rgba(2, 6, 23, 0.7);
  --monthly-row-hover: rgba(59, 130, 246, 0.25);
  --monthly-cell-desc: #cbd5f5;
  --monthly-cell-time: #e2e8f0;
  --monthly-today-bg: rgba(37, 99, 235, 0.25);
  --monthly-today-text: #bfdbfe;
  --monthly-today-accent: #60a5fa;
  --monthly-border: rgba(59, 130, 246, 0.35);
  --monthly-modal-bg: rgba(15, 23, 42, 0.95);
  --monthly-modal-border: rgba(96, 165, 250, 0.35);
  --monthly-modal-section-bg: rgba(30, 41, 59, 0.75);
  --monthly-modal-section-border: rgba(59, 130, 246, 0.3);
  --monthly-link: #93c5fd;
  --monthly-muted: #a5b4fc;
  --monthly-badge-bg: rgba(124, 58, 237, 0.25);
  --monthly-badge-text: #e9d5ff;
}

.monthly-page {
  color: var(--monthly-page-text);
}

.monthly-toolbar {
  background: var(--monthly-header-bg);
  border: 1px solid var(--monthly-border);
  border-radius: 0.75rem;
  box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
  backdrop-filter: blur(8px);
}

[data-theme="dark"] .monthly-toolbar {
  box-shadow: 0 26px 55px rgba(2, 6, 23, 0.7);
}

#schedule-container {
  scroll-behavior: auto !important;
  overscroll-behavior: contain;
}

#schedule-scroll-wrapper {
  border-color: var(--monthly-border) !important;
  background: var(--monthly-sticky-bg);
  border-radius: 0.75rem;
}

.monthly-table {
  color: var(--monthly-page-text);
}

.monthly-table thead {
  position: sticky;
  top: 0;
  z-index: 10;
  background: var(--monthly-header-bg);
}

.monthly-table-header {
  background: var(--monthly-header-bg);
  color: var(--monthly-header-text);
}

.monthly-table-header th {
  color: var(--monthly-header-text);
  border-bottom: 1px solid var(--monthly-border);
}

.monthly-table-header .text-gray-600 {
  color: var(--monthly-header-muted) !important;
}

.sticky-left-header,
.sticky-left-cell {
  position: sticky;
  left: 0;
  z-index: 5;
  background: var(--monthly-sticky-bg) !important;
  box-shadow: 2px 0 6px -2px var(--monthly-sticky-shadow);
  color: var(--monthly-page-text);
}


.monthly-table td,
.monthly-table th {
  border-bottom: 1px solid var(--monthly-border);
}

.monthly-row:hover {
  background-color: var(--monthly-row-hover);
}

.cell-content {
  min-height: 64px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: normal;
  word-break: break-word;
  font-size: 1rem;
  position: relative;
  cursor: pointer;
  padding: 4px;
}

.cell-time,
.cell-desc {
  padding: 2px 0;
  line-height: 1.4;
}

.cell-time {
  color: var(--monthly-cell-time);
  font-weight: 600;
}

.cell-desc {
  font-size: 0.9rem;
  color: var(--monthly-cell-desc);
}

.today-header {
  color: var(--monthly-today-text) !important;
  border-bottom: 3px solid var(--monthly-today-accent) !important;
  background: var(--monthly-today-bg) !important;
}

.today-col {
  background: var(--monthly-today-bg) !important;
}

.monthly-doctor-link {
  color: var(--monthly-link);
}

.monthly-routine-badge {
  background: var(--monthly-badge-bg) !important;
  color: var(--monthly-badge-text) !important;
  border: 1px solid var(--monthly-border);
}

.monthly-modal {
  background: var(--monthly-modal-bg) !important;
  border: 1px solid var(--monthly-modal-border);
  color: var(--monthly-page-text);
}

.monthly-modal h3,
.monthly-modal h4 {
  color: var(--monthly-page-text);
}

.monthly-modal p,
.monthly-modal span,
.monthly-modal label,
.monthly-modal .text-gray-600,
.monthly-modal .text-gray-500 {
  color: var(--monthly-muted) !important;
}

.monthly-tool-card {
  background: var(--monthly-modal-section-bg) !important;
  border: 1px solid var(--monthly-modal-section-border) !important;
}

.monthly-modal input,
.monthly-modal select,
.monthly-modal textarea {
  background: var(--monthly-sticky-bg);
  color: var(--monthly-page-text);
  border: 1px solid var(--monthly-modal-border);
}

.monthly-modal input::placeholder,
.monthly-modal textarea::placeholder {
  color: var(--monthly-muted);
}

.monthly-doctor-item {
  transition: background-color 0.2s ease;
}

.monthly-doctor-item:hover {
  background-color: var(--monthly-row-hover) !important;
}

.monthly-modal .pin-checkbox {
  accent-color: var(--monthly-link);
}

.monthly-page .monthly-input,
.monthly-page .monthly-select {
  background: var(--monthly-sticky-bg);
  border: 1px solid var(--monthly-border);
  color: var(--monthly-page-text);
}

.monthly-page .monthly-input::placeholder {
  color: var(--monthly-muted);
}

[data-theme="dark"] .monthly-page a.text-blue-600,
[data-theme="dark"] .monthly-page .monthly-doctor-link {
  color: var(--monthly-link) !important;
}

[data-theme="dark"] .monthly-page .text-gray-600,
[data-theme="dark"] .monthly-page .text-gray-500 {
  color: var(--monthly-muted) !important;
}

[data-theme="dark"] .monthly-page .text-red-700 {
  color: #fecaca !important;
}

[data-theme="dark"] .monthly-page .text-gray-900 {
  color: var(--monthly-page-text) !important;
}

[data-theme="dark"] .monthly-page .text-purple-700 {
  color: #d8b4fe !important;
}

[data-theme="dark"] .monthly-page .bg-red-100 {
  background: rgba(248, 113, 113, 0.22) !important;
}

[data-theme="dark"] .monthly-page .bg-gray-100 {
  background: rgba(148, 163, 184, 0.2) !important;
}

[data-theme="dark"] .monthly-page .bg-orange-50 {
  background: rgba(251, 146, 60, 0.22) !important;
}

[data-theme="dark"] .monthly-page .bg-green-50 {
  background: rgba(34, 197, 94, 0.22) !important;
}

[data-theme="dark"] .monthly-page .bg-blue-50 {
  background: rgba(59, 130, 246, 0.22) !important;
}

[data-theme="dark"] .monthly-page .hover\:bg-gray-50:hover,
[data-theme="dark"] .monthly-page .hover\:bg-gray-100:hover {
  background-color: rgba(59, 130, 246, 0.18) !important;
}

[data-theme="dark"] .monthly-page .hover\:bg-red-50:hover {
  background-color: rgba(248, 113, 113, 0.25) !important;
}

#pinCounter {
  color: var(--monthly-muted);
}

.monthly-page .border-gray-200 {
  border-color: var(--monthly-border) !important;
}

</style>

<script>
const calendar = {{ calendar|tojson }};
const daysInMonth = {{ days_in_month }};
const year = {{ year }};
const month = {{ month }};
const isAdmin = {{ 'true' if session.user.role == 'admin' else 'false' }};
const serverToday = "{{ today_str }}";
const doctorsData = {{ doctors|tojson }};
const pinnedDoctors = {{ pinned_doctors|tojson }};

class VirtualScheduleTable {
    constructor() {
        this.container = document.getElementById('schedule-container');
        this.tbody = document.getElementById('virtual-tbody');
        this.rowHeight = 64; 
        this.bufferRows = 5; 
        this.visibleRows = Math.ceil(this.container.clientHeight / this.rowHeight) + (this.bufferRows * 2); 
        this.allDoctors = doctorsData;
        this.filteredDoctors = [...this.allDoctors]; 
        this.startIndex = 0;
        this.endIndex = Math.min(this.visibleRows, this.filteredDoctors.length);
        this.init();
    }
    
    init() {
        this.container.addEventListener('scroll', this.throttledScroll.bind(this), { passive: true });
        window.addEventListener('resize', this.handleResize.bind(this));
        this.render();
    }
    
    throttledScroll() {
        if (!this.isScrolling) {
            this.isScrolling = true;
            window.requestAnimationFrame(() => {
                this.handleScroll();
                this.isScrolling = false;
            });
        }
    }
    
    handleScroll() {
        const scrollTop = this.container.scrollTop;
        const newStartIndex = Math.max(0, Math.floor(scrollTop / this.rowHeight));
        const newEndIndex = Math.min(newStartIndex + this.visibleRows, this.filteredDoctors.length);
        if (newStartIndex !== this.startIndex || newEndIndex !== this.endIndex) {
            this.startIndex = newStartIndex;
            this.endIndex = newEndIndex;
            this.render();
        }
    }
    
    handleResize() {
        this.visibleRows = Math.ceil(this.container.clientHeight / this.rowHeight);
        this.startIndex = Math.max(0, Math.floor(this.container.scrollTop / this.rowHeight));
        this.endIndex = Math.min(this.startIndex + this.visibleRows, this.filteredDoctors.length);
        this.render();
    }
    
    render() {
  // compute spacers
  const topPadding = this.startIndex * this.rowHeight;
  const bottomPadding = (this.filteredDoctors.length - this.endIndex) * this.rowHeight;

  // rebuild tbody
  this.tbody.innerHTML = '';

  // TOP spacer row
  const topSpacer = document.createElement('tr');
  topSpacer.className = 'spacer-top';
  topSpacer.innerHTML =
    `<td colspan="${daysInMonth + 1}" style="padding:0;border:0;height:${topPadding}px;"></td>`;
  this.tbody.appendChild(topSpacer);

  // visible rows
  for (let i = this.startIndex; i < this.endIndex; i++) {
    const doctor = this.filteredDoctors[i];
    if (!doctor) continue;
    const row = this.createDoctorRow(doctor);
    row.style.height = `${this.rowHeight}px`; // keep consistent height
    this.tbody.appendChild(row);
  }

  // BOTTOM spacer row
  const bottomSpacer = document.createElement('tr');
  bottomSpacer.className = 'spacer-bottom';
  bottomSpacer.innerHTML =
    `<td colspan="${daysInMonth + 1}" style="padding:0;border:0;height:${bottomPadding}px;"></td>`;
  this.tbody.appendChild(bottomSpacer);
}


    createDoctorRow(doctor) {
        const row = document.createElement('tr');
        row.className = 'monthly-row h-16';
        const nameCell = document.createElement('td');
        nameCell.className = 'sticky-left-cell monthly-sticky-cell z-20 w-48 px-4 py-2 font-medium text-left';
        const isPinned = pinnedDoctors.includes(doctor.id);
        nameCell.innerHTML = `
            <div class="flex items-center gap-2">
                ${isPinned ? '<span title="Pinned Doctor" class="text-yellow-500 text-sm">⭐</span>' : ''}
                <a href="/radmapping/doctors/${doctor.id}" target="_blank" class="monthly-doctor-link text-blue-600 hover:underline">
                    ${doctor.name}
                </a>
                ${doctor.reads_routines ? '<span class="monthly-routine-badge inline-flex items-center justify-center text-xs font-bold text-purple-700 bg-purple-100 h-5 px-2 rounded" title="Routines">R</span>' : ''}
            </div>
        `;
        row.appendChild(nameCell);
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month - 1, day);
            const dateStr = date.toISOString().split('T')[0];
            const schedule = calendar[dateStr] ? calendar[dateStr][doctor.id] : null;

            const cell = document.createElement('td');
            cell.className = `w-48 px-4 py-3 text-center ${this.getCellClass(schedule, dateStr)}`;
            if (schedule) {
                cell.innerHTML = this.createScheduleCell(schedule, doctor.id, dateStr);
            }
            row.appendChild(cell);
        }
        return row;
    }

    getCellClass(schedule, dateStr) {
        let cellClass = '';
        if (schedule) {
            const details = schedule.schedule_details || '';
            const detailsUpper = details.toUpperCase();
            if (detailsUpper.includes('OFF') || detailsUpper.includes('VACATION')) {
                cellClass = 'bg-red-100';
            } else if (detailsUpper.includes('REACH AS NEEDED')) {
                cellClass = 'bg-gray-100';
            } else if (details.toLowerCase().includes('onsite')) {
                cellClass = 'bg-orange-50';
            } else if (detailsUpper.includes('ROUTINE')) {
                cellClass = 'bg-green-50';
            } else if (schedule.start_time) {
                const hour = parseInt(schedule.start_time.split(':')[0]);
                cellClass = (hour >= 13 || hour < 6) ? 'bg-orange-50' : 'bg-green-50';
            }
        }
        if (dateStr === serverToday) {
            cellClass += ' today-col bg-blue-50';
        }
        return cellClass;
    }

    createScheduleCell(schedule, doctorId, dateStr) {
        const details = schedule.schedule_details || '';
        const isOff = details.trim().toUpperCase() === 'OFF';
        const isVac = details.trim().toUpperCase() === 'VACATION';
        const isReach = details.trim().toUpperCase() === 'REACH AS NEEDED';
        let timeDisplay = '';
        if (isOff) {
            timeDisplay = '<span class="text-red-700 font-bold">OFF</span>';
        } else if (isVac) {
            timeDisplay = '<span class="text-red-700 font-bold">VACATION</span>';
        } else if (isReach) {
            timeDisplay = '<span class="text-gray-900">REACH AS NEEDED</span>';
        } else if (schedule.start_time && schedule.end_time) {
            timeDisplay = `${this.formatTime(schedule.start_time)} - ${this.formatTime(schedule.end_time)}`;
        }
        const clickHandler = isAdmin ? `onclick="openScheduleModal('${doctorId}', '${dateStr}', '${schedule.start_time || ''}', '${schedule.end_time || ''}', \`${details.replace(/`/g, '\\`')}\`)"` : '';
        const cursorClass = isAdmin ? 'cursor-pointer' : '';
        const filterValue = document.getElementById('scheduleFilter').value;
        const showTime = filterValue === 'time';
        const timeDisplayStyle = showTime ? 'block' : 'none';
        const descDisplayStyle = showTime ? 'none' : 'block';
        let html = `
            <div class="cell-content ${cursorClass}" ${clickHandler}>
                <span class="cell-time text-sm" style="display: ${timeDisplayStyle};">${timeDisplay}</span>
                <span class="cell-desc text-sm" style="display: ${descDisplayStyle};">${details}</span>
            </div>
        `;
        return html;
    }

    formatTime(timeStr) {
        if (!timeStr) return '';
        const [hours, minutes] = timeStr.split(':');
        const hour = parseInt(hours);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
        return `${displayHour}:${minutes} ${ampm}`;
    }

    filter(searchTerm) {
        const filtered = this.allDoctors.filter(doctor =>
            doctor.name.toLowerCase().includes(searchTerm.toLowerCase())
        );
        const pinnedFiltered = filtered.filter(doc => pinnedDoctors.includes(doc.id));
        const unpinnedFiltered = filtered.filter(doc => !pinnedDoctors.includes(doc.id));
        unpinnedFiltered.sort((a, b) => a.name.localeCompare(b.name));
        this.filteredDoctors = [...pinnedFiltered, ...unpinnedFiltered];
        this.startIndex = 0; 
        this.endIndex = Math.min(this.visibleRows, this.filteredDoctors.length);
        this.container.scrollTop = 0; 
        this.render();
    }
}

let virtualTable;
let searchTimeout;

function handleSearch() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    if (virtualTable) {
        virtualTable.filter(searchTerm);
    }
}
function openScheduleModal(doctorId, date, startTime, endTime, details) {
    document.getElementById('modalDate').value = date;
    document.getElementById('modalYear').value = year;
    document.getElementById('modalMonth').value = month;
    document.getElementById('modalStartDay').value = "1";
    document.getElementById('scheduleForm').action = `/radmapping/monthly/update_schedule/${doctorId}`;
    document.getElementById('scheduleModal').classList.remove('hidden');
    document.getElementById('modalStartTime').value = startTime || '';
    document.getElementById('modalEndTime').value = endTime || '';
    document.getElementById('modalDetails').value = details || '';
    if (startTime || endTime || details) {
        document.getElementById('modalTitle').textContent = 'Edit Shift';
        document.getElementById('modalSaveBtn').textContent = 'Update';
    } else {
        document.getElementById('modalTitle').textContent = 'Add Shift';
        document.getElementById('modalSaveBtn').textContent = 'Save';
    }
    const noTime = (details && (details.trim().toUpperCase() === 'OFF' || details.trim().toUpperCase() === 'VACATION' || details.trim().toUpperCase() === 'REACH AS NEEDED')) ? details.trim() : '';
    document.getElementById('modalNoTime').value = noTime;
    handleNoTimeChange();
}

function closeScheduleModal() {
    document.getElementById('scheduleModal').classList.add('hidden');
}

function openToolsModal() {
    document.getElementById('toolsModal').classList.remove('hidden');
}

function closeToolsModal() {
    document.getElementById('toolsModal').classList.add('hidden');
}

function scrollToTodayColumn() {
    const th = document.querySelector(`th[data-date="${serverToday}"]`);
    const wrapper = document.getElementById('schedule-container');
    if (th && wrapper) {
        const thOffset = th.offsetLeft;
        const stickyOffset = 192; 
        const scrollAmount = thOffset - stickyOffset;
        wrapper.scrollLeft = scrollAmount;
    }
}

window.addEventListener('DOMContentLoaded', function() {
    virtualTable = new VirtualScheduleTable();
    setTimeout(scrollToTodayColumn, 500);
    const filter = document.getElementById('scheduleFilter');
    function applyFilter() {
        const showTime = filter.value === 'time';
        document.querySelectorAll('.cell-time').forEach(el => {
            el.style.display = showTime ? 'block' : 'none';
        });
        document.querySelectorAll('.cell-desc').forEach(el => {
            el.style.display = showTime ? 'none' : 'block';
        });
    }
    filter.addEventListener('change', applyFilter);
    applyFilter();
});

window.addEventListener('resize', function() {
    setTimeout(scrollToTodayColumn, 500);
});

function handleNoTimeChange() {
    const noTime = document.getElementById('modalNoTime').value;
    const start = document.getElementById('modalStartTime');
    const end = document.getElementById('modalEndTime');
    if (noTime === 'OFF' || noTime === 'VACATION' || noTime === 'REACH AS NEEDED') {
        start.value = '';
        end.value = '';
        start.disabled = true;
        end.disabled = true;
        start.removeAttribute('required');
        end.removeAttribute('required');
        document.getElementById('modalDetails').value = noTime;
    } else {
        start.disabled = false;
        end.disabled = false;
        start.setAttribute('required', 'required');
        end.setAttribute('required', 'required');
        if (document.getElementById('modalDetails').value === 'OFF' || 
            document.getElementById('modalDetails').value === 'VACATION' || 
            document.getElementById('modalDetails').value === 'REACH AS NEEDED') {
            document.getElementById('modalDetails').value = '';
        }
    }
}
document.getElementById('modalNoTime').addEventListener('change', handleNoTimeChange);

function handleBulkNoTimeChange() {
    const noTime = document.getElementById('bulkNoTime').value;
    const start = document.getElementById('bulkStartTime');
    const end = document.getElementById('bulkEndTime');
    const details = document.getElementById('bulkDetails');
    if (noTime === 'OFF' || noTime === 'VACATION' || noTime === 'REACH AS NEEDED') {
        start.value = '';
        end.value = '';
        start.disabled = true;
        end.disabled = true;
        start.removeAttribute('required');
        end.removeAttribute('required');
        details.value = noTime;
    } else {
        start.disabled = false;
        end.disabled = false;
        start.setAttribute('required', 'required');
        end.setAttribute('required', 'required');
        if (details.value === 'OFF' || details.value === 'VACATION' || details.value === 'REACH AS NEEDED') {
            details.value = '';
        }
    }
}

function handlePatternNoTimeChange() {
    const noTime = document.getElementById('patternNoTime').value;
    const start = document.getElementById('patternStartTime');
    const end = document.getElementById('patternEndTime');
    const details = document.getElementById('patternDetails');
    if (noTime === 'OFF' || noTime === 'VACATION' || noTime === 'REACH AS NEEDED') {
        start.value = '';
        end.value = '';
        start.disabled = true;
        end.disabled = true;
        start.removeAttribute('required');
        end.removeAttribute('required');
        details.value = noTime;
    } else {
        start.disabled = false;
        end.disabled = false;
        start.setAttribute('required', 'required');
        end.setAttribute('required', 'required');
        if (details.value === 'OFF' || details.value === 'VACATION' || details.value === 'REACH AS NEEDED') {
            details.value = '';
        }
    }
}

function openPinModal() {
    document.getElementById('pinModal').classList.remove('hidden');
}

function closePinModal() {
    document.getElementById('pinModal').classList.add('hidden');
}

function savePinnedDoctors() {
    const checkboxes = document.querySelectorAll('.pin-checkbox:checked');
    const doctorIds = Array.from(checkboxes).map(cb => cb.dataset.doctorId);
    if (doctorIds.length > 15) {
        alert('You can only pin up to 15 doctors.');
        return;
    }
    fetch('/radmapping/monthly/pin', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ doctor_ids: doctorIds })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Error saving pinned doctors: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving pinned doctors');
    });
}

function updatePinCounter() {
    const checkedBoxes = document.querySelectorAll('.pin-checkbox:checked');
    const counter = document.getElementById('pinCounter');
    counter.textContent = `${checkedBoxes.length}/15 selected`;
    const uncheckedBoxes = document.querySelectorAll('.pin-checkbox:not(:checked)');
    if (checkedBoxes.length >= 15) {
        uncheckedBoxes.forEach(box => box.disabled = true);
    } else {
        uncheckedBoxes.forEach(box => box.disabled = false);
    }
}

function resetPins() {
    if (confirm('Are you sure you want to unpin all doctors?')) {
        document.querySelectorAll('.pin-checkbox').forEach(box => {
            box.checked = false;
            box.disabled = false;
        });
        updatePinCounter();
    }
}

function filterPinModalDoctors() {
    const searchTerm = document.getElementById('pinModalSearch').value.toLowerCase();
    const doctorItems = document.querySelectorAll('.doctor-item');
    doctorItems.forEach(item => {
        const checkbox = item.querySelector('.pin-checkbox');
        const doctorName = checkbox.dataset.doctorName;
        if (doctorName.includes(searchTerm)) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
}
</script>
{% endblock %}