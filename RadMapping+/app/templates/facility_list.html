{% extends "layout.html" %}

{% block title %}Facilities{% endblock %}

{% block content %}
<style>
    .directory-search-input {
    padding: 0.75rem 1rem;
    border-radius: 0.75rem;
    background-color: #202938;
    border : 1px solid #202938;
    color: #f8fafc;
    transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .directory-search-input::placeholder {
    color: #f1f5f9;
    opacity: 1;
  }

  .directory-search-input:focus {
    outline: none;
    border-color: #93c5fd;
    background-color: rgba(42, 116, 150, 0.35);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.35);
  }

 html[data-theme="light"] .directory-search-input {
    background-color: #ffffff;
    color: #1e293b;
    border-color: rgba(214, 214, 214, 0.5);
  }

  
  html[data-theme="light"] .directory-search-input::placeholder {
    color: #464646;
  }

  html[data-theme="dark"] .status-filter-button {
    background-color: rgba(30, 41, 59, 0.7);
    border: 1px solid rgba(148, 163, 184, 0.55);
    color: #e2e8f0;
  }

  html[data-theme="dark"] .status-filter-button:hover {
    background-color: rgba(51, 65, 85, 0.85);
  }

  html[data-theme="dark"] .status-filter-button.active-filter {
    background-color: #2563eb;
    border-color: rgba(147, 197, 253, 0.75);
    color: #ffffff;
  }

  .helix-badge {
    background-color: #dcfce7;
    color: #166534;
    border: 1px solid #34d399;
  }

  [data-theme="dark"] .helix-badge {
    background-color: rgba(52, 211, 153, 0.2);
    color: #bbf7d0;
    border-color: #34d399;
  }
      html[data-theme="dark"] .directory-search-input {
        background-color: #202938; /* Existing background, but you can change it */
        border: 1px solid #202938;
        color: #f8fafc; /* Existing text color, but you can change it */
        transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
    }


    /* Target the dropdown options for their background/text colors when the dropdown is open */
    html[data-theme="dark"] #stateFilter option {
        /* This changes the color of the options when the dropdown list is open */
        background-color: #1a202c; 
        color: #e2e8f0;
    }

    /* To address potential issues with the hover/selected state of the dropdown list */
    html[data-theme="dark"] #stateFilter option:hover,
    html[data-theme="dark"] #stateFilter option:checked {
        /* Example: A slightly different background for a selected/hovered item in the list */
        background-color: #2d3748; 
        color: #93c5fd; /* Light blue text for contrast */
    }
</style>
<div class="flex justify-between items-center mb-6 border-b pb-2">
  <h2 class="text-2xl font-semibold">Facilities</h2>
  <div class="flex gap-2">
  {% if session.user.role == 'admin' %}
    <button onclick="openHelixModal()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
      HELIX Facilities
    </button>
    <button onclick="openPrioritizeModal()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
      Prioritize Facilities
    </button>
  {% endif %}
  <button onclick="openPinModal()" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
    Pin Facilities
  </button>
  {% if session.user.role == 'admin' %}
    <button onclick="openAddFacilityModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
      Add Facility
    </button>
  {% endif %}
  </div>
</div>

<div class="mb-4 flex flex-col md:flex-row gap-4">
  <div class="flex-1">
    <input type="text"
           id="searchBox"
           placeholder="Search by name..."
           class="directory-search-input w-full"
           onkeyup="debounceSearch()" />
  </div>
  <div class="flex-1">
    <select id="stateFilter"
            class="directory-search-input w-full p-2 border rounded"
            onchange="debounceSearch()">
      <option value="">Filter by State (All)</option>
      <option value="AL">Alabama</option>
      <option value="AK">Alaska</option>
      <option value="AZ">Arizona</option>
      <option value="AR">Arkansas</option>
      <option value="CA">California</option>
      <option value="CO">Colorado</option>
      <option value="CT">Connecticut</option>
      <option value="DE">Delaware</option>
      <option value="FL">Florida</option>
      <option value="GA">Georgia</option>
      <option value="HI">Hawaii</option>
      <option value="ID">Idaho</option>
      <option value="IL">Illinois</option>
      <option value="IN">Indiana</option>
      <option value="IA">Iowa</option>
      <option value="KS">Kansas</option>
      <option value="KY">Kentucky</option>
      <option value="LA">Louisiana</option>
      <option value="ME">Maine</option>
      <option value="MD">Maryland</option>
      <option value="MA">Massachusetts</option>
      <option value="MI">Michigan</option>
      <option value="MN">Minnesota</option>
      <option value="MS">Mississippi</option>
      <option value="MO">Missouri</option>
      <option value="MT">Montana</option>
      <option value="NE">Nebraska</option>
      <option value="NV">Nevada</option>
      <option value="NH">New Hampshire</option>
      <option value="NJ">New Jersey</option>
      <option value="NM">New Mexico</option>
      <option value="NY">New York</option>
      <option value="NC">North Carolina</option>
      <option value="ND">North Dakota</option>
      <option value="OH">Ohio</option>
      <option value="OK">Oklahoma</option>
      <option value="OR">Oregon</option>
      <option value="PA">Pennsylvania</option>
      <option value="RI">Rhode Island</option>
      <option value="SC">South Carolina</option>
      <option value="SD">South Dakota</option>
      <option value="TN">Tennessee</option>
      <option value="TX">Texas</option>
      <option value="UT">Utah</option>
      <option value="VT">Vermont</option>
      <option value="VA">Virginia</option>
      <option value="WA">Washington</option>
      <option value="WV">West Virginia</option>
      <option value="WI">Wisconsin</option>
      <option value="WY">Wyoming</option>
      <option value="DC">District of Columbia</option>
      <option value="PR">Puerto Rico</option>
    </select>
  </div>
  <div class="flex gap-2">
    <button onclick="filterByStatus('all')"
            class="status-filter-button px-4 py-2 rounded text-sm font-medium bg-gray-100 hover:bg-gray-200"
            data-status="all">
      All
    </button>
    <button onclick="filterByStatus('active')"
            class="status-filter-button px-4 py-2 rounded text-sm font-medium bg-blue-600 text-white active-filter"
            data-status="active">
      Active
    </button>
    <button onclick="filterByStatus('inactive')"
            class="status-filter-button px-4 py-2 rounded text-sm font-medium bg-gray-100 hover:bg-gray-200"
            data-status="inactive">
      Inactive
    </button>
    <button onclick="filterByStatus('hold')"
            class="status-filter-button px-4 py-2 rounded text-sm font-medium bg-gray-100 hover:bg-gray-200"
            data-status="hold">
      Hold
    </button>
    <button onclick="filterByStatus('pending')"
            class="status-filter-button px-4 py-2 rounded text-sm font-medium bg-gray-100 hover:bg-gray-200"
            data-status="pending">
      Pending
    </button>
  </div>
</div>

<ul id="facilityList" class="space-y-4">
  {% for facility in facilities %}
  <li class="relative flex items-center justify-between p-4 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer facility-item"
      onclick="window.location.href='/radmapping/facilities/{{ facility.id }}'"
      onmouseenter="showPopup(this)"
      onmouseleave="hidePopup(this)">
    <div class="flex items-center gap-3">
      <div class="w-2 h-2 rounded-full {% if facility.active_status == 'true' %}bg-green-500{% elif facility.active_status == 'false' %}bg-red-500{% elif facility.active_status == 'hold' %}bg-blue-500{% elif facility.active_status == 'pending' %}bg-yellow-500{% endif %}"></div>
      <div>
        <div class="flex items-center gap-1">
            {% if facility.id in pinned_facility_ids %}
              <span title="Pinned Facility" class="text-yellow-500 text-base">⭐</span>
            {% endif %}
            {% if facility.id in helix_facility_ids %}
              <span title="HELIX Facility" class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium mr-2 helix-badge">HELIX</span>
            {% endif %}
            {% if facility.id in prioritized_facility_ids %}
              <span title="Prioritized Facility" class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 mr-2">PRIO</span>
            {% endif %}
            <p class="text-lg font-medium name">{{ facility.name }}</p>
          </div>
        <p class="text-sm text-gray-500 location">{{ facility.location or 'No location specified' }}</p>
      </div>
    </div>
    <span class="text-blue-600 font-semibold">Details →</span>

    <div class="facility-popup absolute left-0 top-full mt-2 w-[20rem] bg-white border p-3 rounded shadow-md text-left pointer-events-none opacity-0 transition-opacity duration-150 z-50">
      <p class="popup-line text-sm"><span class="popup-label">Location:</span> <span class="popup-value">{{ facility.location or 'N/A' }}</span></p>
      <p class="popup-line text-sm"><span class="popup-label">PACS:</span> <span class="popup-value">{{ facility.pacs or 'N/A' }}</span></p>
      {% set _s = facility.active_status %}
      <p class="popup-line text-sm">
        <span class="popup-label">Status:</span>
        <span class="popup-value">
          {% if _s == 'true' %}Active
          {% elif _s == 'false' %}Inactive
          {% elif _s == 'hold' %}On Hold
          {% elif _s == 'pending' %}Pending
          {% else %}Unknown{% endif %}
        </span>
      </p>

      <p class="popup-line text-sm"><span class="popup-label">TAT Definition:</span> <span class="popup-value">{{ facility.tat_definition or 'N/A' }}</span></p>
      <p class="popup-line text-sm"><span class="popup-label">Modalities Period:</span> <span class="popup-value">{{ facility.modalities_assignment_period or 'N/A' }}</span></p>
    </div>
  </li>
  {% endfor %}
</ul>

<div class="mt-4 flex justify-between items-center">
  <div class="text-sm text-gray-700">
    Showing <span id="startItem">1</span> to <span id="endItem">{{ per_page }}</span> of <span id="totalItems">{{ total_count }}</span> entries
  </div>
  <div class="flex gap-2">
    <button onclick="changePage('prev')" id="prevPage" class="px-10 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
      Previous
    </button>
    <button onclick="changePage('next')" id="nextPage" class="px-10 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
      Next
    </button>
  </div>
</div>
<div id="addFacilityModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg shadow-lg w-[90%] max-w-2xl max-h-[90vh] overflow-y-auto" id="addFacilityModalContent"> {# Changed max-w-xl to max-w-2xl #}
    <div class="flex justify-between items-center mb-4 p-5 border-b border-gray-200"> {# Reduced header padding slightly #}
      <h3 class="text-lg font-semibold">Add New Facility</h3>
      <button onclick="closeAddFacilityModal()" class="text-gray-500 hover:text-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
        <form method="POST" action="{{ url_for('facilities.add_facility') }}" class="space-y-4 p-5"> {# Reduced form padding slightly #}
      <div>
        <label class="block text-sm font-medium text-gray-700">Name</label>
        <input type="text" name="name" required class="w-full border rounded px-3 py-2 text-sm">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">PACS</label>
        <input type="text" name="pacs" required class="w-full border rounded px-3 py-2 text-sm">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Location</label>
        <input type="text" name="location" class="w-full border rounded px-3 py-2 text-sm">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Modalities Assignment Period</label>
        <input type="text" name="modalities_assignment_period" class="w-full border rounded px-3 py-2 text-sm">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">TAT Definition</label>
        <input type="text" name="tat_definition" class="w-full border rounded px-3 py-2 text-sm">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Modalities</label>
        <input type="text" name="modalities" class="w-full border rounded px-3 py-2 text-sm">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">QA Criteria</label>
        <input type="text" name="qa_criteria" class="w-full border rounded px-3 py-2 text-sm">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Monitoring</label>
        <input type="text" name="monitoring" class="w-full border rounded px-3 py-2 text-sm">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Account POC</label>
        <input type="text" name="account_poc" class="w-full border rounded px-3 py-2 text-sm">
      </div>
            <div>
        <label class="block text-sm font-medium text-gray-700">Status</label>
        <select name="active_status" class="w-full border rounded px-3 py-2 text-sm">
          <option value="true" selected>Active</option>
          <option value="false">Inactive</option>
          <option value="hold">On Hold</option>
          <option value="pending">Pending</option>
        </select>
      </div>
      <div class="flex justify-end">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
          Add Facility
        </button>
      </div>
    </form>
  </div>
</div>

<div id="prioritizeModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg w-[90%] max-w-4xl p-6 relative max-h-[90vh] overflow-y-auto" id="prioritizeModalContent">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">Prioritize Facilities</h3>
      <button onclick="closePrioritizeModal()" class="text-gray-500 hover:text-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="mb-4">
      <p class="text-gray-600">Select facilities to appear at the top of the directory.</p>
      <p class="text-sm text-gray-500">Prioritized facilities will always appear first for all users.</p>
    </div>
    <div class="flex justify-between items-center mb-4">
      <div class="flex-1 mr-4">
        <input type="text"
               id="prioritizeModalSearch"
               class="w-full border rounded px-3 py-2"
               placeholder="Search facilities..."
               oninput="filterPrioritizeModalFacilities()">
      </div>
      <div class="flex items-center gap-4">
        <span id="priorityCounter" class="text-sm font-medium">0 selected</span>
        <button onclick="resetPriorities()" class="px-3 py-1 text-sm border border-red-500 text-red-500 rounded hover:bg-red-50">
          Clear All
        </button>
      </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto" id="prioritizeFacilitiesList">
      </div>
    <div class="mt-4 flex justify-end gap-2">
      <button onclick="closePrioritizeModal()" class="px-4 py-2 border rounded hover:bg-gray-100">
        Cancel
      </button>
      <button onclick="savePrioritizedFacilities()" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
        Save Priorities
      </button>
    </div>
  </div>
</div>

<div id="helixModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg w-[90%] max-w-4xl p-6 relative max-h-[90vh] overflow-y-auto" id="helixModalContent">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">HELIX Facilities</h3>
      <button onclick="closeHelixModal()" class="text-gray-500 hover:text-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="mb-4">
      <p class="text-gray-600">Select facilities to designate as HELIX.</p>
      <p class="text-sm text-gray-500">HELIX facilities will be highlighted and appear above prioritized facilities for all users.</p>
    </div>
    <div class="flex justify-between items-center mb-4">
      <div class="flex-1 mr-4">
        <input type="text"
               id="helixModalSearch"
               class="w-full border rounded px-3 py-2"
               placeholder="Search facilities..."
               oninput="filterHelixModalFacilities()">
      </div>
      <div class="flex items-center gap-4">
        <span id="helixCounter" class="text-sm font-medium">0 selected</span>
        <button onclick="resetHelixSelections()" class="px-3 py-1 text-sm border border-red-500 text-red-500 rounded hover:bg-red-50">
          Clear All
        </button>
      </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto" id="helixFacilitiesList">
    </div>
    <div class="mt-4 flex justify-end gap-2">
      <button onclick="closeHelixModal()" class="px-4 py-2 border rounded hover:bg-gray-100">
        Cancel
      </button>
      <button onclick="saveHelixFacilities()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
        Save HELIX
      </button>
    </div>
  </div>
</div>

<div id="pinFacilitiesModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg w-[90%] max-w-4xl p-6 relative max-h-[90vh] overflow-y-auto" id="pinFacilitiesModalContent">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">Pin Facilities</h3>
      <button onclick="closePinModal()" class="text-gray-500 hover:text-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <div class="mb-4">
      <p class="text-gray-600">Select up to 15 facilities to pin to the top of the directory.</p>
      <p class="text-sm text-gray-500">Pinned facilities will always appear first for you (above prioritized/global).</p>
    </div>

    <div class="flex justify-between items-center mb-4">
      <div class="flex-1 mr-4">
        <input type="text" 
               id="pinFacilitiesSearch" 
               class="w-full border rounded px-3 py-2" 
               placeholder="Search facilities..."
               oninput="filterPinModalFacilities()">
      </div>
      <div class="flex items-center gap-4">
        <span id="pinFacilitiesCounter" class="text-sm font-medium">0/15 selected</span>
        <button onclick="resetPinnedFacilities()" class="px-3 py-1 text-sm border border-red-500 text-red-500 rounded hover:bg-red-50">
          Reset All
        </button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto" id="pinFacilitiesList"></div>

    <div class="mt-4 flex justify-end gap-2">
      <button onclick="closePinModal()" class="px-4 py-2 border rounded hover:bg-gray-100">
        Cancel
      </button>
      <button onclick="savePinnedFacilities()" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
        Save Pins
      </button>
    </div>
  </div>
</div>

<script>
let currentPage = parseInt("{{ current_page }}", 10);
const itemsPerPage = parseInt("{{ per_page }}", 10);
let totalCount = parseInt("{{ total_count }}", 10);
let searchTimeout;
let currentStatusFilter = 'active';
const PRIORITIZED_FACILITIES = {{ prioritized_facility_ids|tojson }};
const HELIX_FACILITIES = {{ helix_facility_ids|tojson }};
const PINNED_FACILITIES = {{ pinned_facility_ids|tojson }};
let allFacilitiesData = [];

function savePinnedFacilities() {
  const selected = document.querySelectorAll('.pin-fac-checkbox:checked');
  const facilityIds = Array.from(selected).map(cb => cb.dataset.facilityId);

  if (facilityIds.length > 15) {
    alert('You can only pin up to 15 facilities.');
    return;
  }

  fetch('/radmapping/facilities/pin', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ facility_ids: facilityIds })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      // Refresh the page so top-of-list + ⭐ reflect new pins
      window.location.reload();
    } else {
      alert('Error saving pinned facilities: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(err => {
    console.error('Error saving pinned facilities:', err);
    alert('Error saving pinned facilities');
  });
}

function openPinModal() {
  document.getElementById('pinFacilitiesModal').classList.remove('hidden');
  fetchAllFacilitiesForPinning();
}

function closePinModal() {
  document.getElementById('pinFacilitiesModal').classList.add('hidden');
}

function fetchAllFacilitiesForPinning() {
  // Pull all (unfiltered) facilities metadata for the checklist
  fetch(`/radmapping/facilities/search?search_name=&state=&status=all&fetch_all=true`)
    .then(r => r.json())
    .then(({ facilities }) => {
      renderPinFacilitiesList(facilities || []);
      updatePinnedFacilitiesCounter(); // initialize
    })
    .catch(err => console.error('Error fetching facilities for pin modal:', err));
}

function renderPinFacilitiesList(facilities) {
  const wrap = document.getElementById('pinFacilitiesList');
  wrap.innerHTML = '';

  facilities.forEach(fac => {
    const isAlreadyPinned = PINNED_FACILITIES.includes(fac.id); // from server context
    const div = document.createElement('div');
    div.className = 'flex items-center gap-2 p-2 border rounded hover:bg-gray-50 facility-item';
    div.innerHTML = `
      <input type="checkbox"
             id="pin-fac-${fac.id}"
             class="pin-fac-checkbox form-checkbox h-5 w-5 text-purple-600"
             data-facility-id="${fac.id}"
             data-facility-name="${(fac.name || '').toLowerCase()}"
             onchange="updatePinnedFacilitiesCounter()"
             ${isAlreadyPinned ? 'checked' : ''}>
      <label for="pin-fac-${fac.id}" class="flex-1 cursor-pointer">
        ${fac.name}
        ${isAlreadyPinned ? '<span title="Currently Pinned" class="text-yellow-500 text-sm ml-1">⭐</span>' : ''}
      </label>
    `;
    wrap.appendChild(div);
  });
}

function filterPinModalFacilities() {
  const q = (document.getElementById('pinFacilitiesSearch').value || '').toLowerCase();
  const items = document.querySelectorAll('#pinFacilitiesList .facility-item');
  items.forEach(item => {
    const label = item.querySelector('label');
    const name = label ? label.textContent.toLowerCase() : '';
    item.style.display = name.includes(q) ? '' : 'none';
  });
}

function updatePinnedFacilitiesCounter() {
  const checked = document.querySelectorAll('.pin-fac-checkbox:checked');
  const counter = document.getElementById('pinFacilitiesCounter');
  counter.textContent = `${checked.length}/15 selected`;

  const unchecked = document.querySelectorAll('.pin-fac-checkbox:not(:checked)');
  if (checked.length >= 15) {
    unchecked.forEach(box => (box.disabled = true));
  } else {
    unchecked.forEach(box => (box.disabled = false));
  }
}

function resetPinnedFacilities() {
  if (confirm('Are you sure you want to unpin all facilities?')) {
    document.querySelectorAll('.pin-fac-checkbox').forEach(box => {
      box.checked = false;
      box.disabled = false;
    });
    updatePinnedFacilitiesCounter();
  }
}

function openAddFacilityModal() {
  document.getElementById('addFacilityModal').classList.remove('hidden');
}

function closeAddFacilityModal() {
  document.getElementById('addFacilityModal').classList.add('hidden');
  document.querySelector('#addFacilityModal form').reset();
}

function submitAddFacility(event) {
  event.preventDefault(); 

  const formData = new FormData(event.target);
  const status = (formData.get('active_status') || 'pending').toLowerCase();
  const data = {
    name: formData.get('name'),
    location: formData.get('location'),
    pacs: formData.get('pacs'),
    tat_definition: formData.get('tat_definition'),
    modalities_assignment_period: formData.get('modalities_assignment_period'),
    modalities: formData.get('modalities'),
    qa_criteria: formData.get('qa_criteria'),
    monitoring: formData.get('monitoring'),
    account_poc: formData.get('account_poc'),
    active_status: status, 
  };

  fetch('/radmapping/facilities/add', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(data)
  })
  .then(response => {
    if (response.ok) {
      closeAddFacilityModal();
      window.location.reload(); 
    } else {
      throw new Error('Failed to add facility');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to add facility. Please try again.');
  });
}
document.addEventListener('DOMContentLoaded', () => {
    const addFacilityForm = document.querySelector('#addFacilityModal form');
    if (addFacilityForm) {
        addFacilityForm.addEventListener('submit', submitAddFacility);
    }

    document.querySelectorAll('[data-status]').forEach(button => {
        button.classList.remove('active-filter', 'bg-blue-600', 'text-white');
        if (button.dataset.status === 'active') {
            button.classList.add('active-filter', 'bg-blue-600', 'text-white');
        }
    });
    loadFacilities();

    const addFacilityModal = document.getElementById('addFacilityModal');
    const addFacilityModalContent = document.getElementById('addFacilityModalContent');

    const prioritizeModal = document.getElementById('prioritizeModal');
    const prioritizeModalContent = document.getElementById('prioritizeModalContent');

  
});


function debounceSearch() {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    currentPage = 1;
    loadFacilities();
  }, 300);
}

function loadFacilities() {
  const searchTermName = document.getElementById('searchBox').value; 
  const stateFilter = document.getElementById('stateFilter').value; 

  const statusParam =
    currentStatusFilter === 'active'   ? 'true'  :
    currentStatusFilter === 'inactive' ? 'false' :
    currentStatusFilter;

  fetch(`/radmapping/facilities/search?page=${currentPage}&search_name=${encodeURIComponent(searchTermName)}&state=${encodeURIComponent(stateFilter)}&status=${statusParam}`)
    .then(response => response.json())
    .then(data => {
      updateTable(data.facilities);
      updatePagination(data.total_count);
    });
}

function getStatusLabel(v) {
  switch (v) {
    case 'true': return 'Active';
    case 'false': return 'Inactive';
    case 'hold': return 'On Hold';
    case 'pending': return 'Pending';
    default: return 'Unknown';
  }
}
function getStatusDotClass(v) {
  switch (v) {
    case 'true': return 'bg-green-500';
    case 'false': return 'bg-red-500';
    case 'hold': return 'bg-blue-500';
    case 'pending': return 'bg-yellow-500';
    default: return '';
  }
}

function filterByStatus(status) {
  currentStatusFilter = status;
  document.querySelectorAll('[data-status]').forEach(button => {
    button.classList.remove('active-filter', 'bg-blue-600', 'text-white');
    button.classList.add('bg-gray-100', 'text-black');
    if (button.dataset.status === status) {
      button.classList.remove('bg-gray-100', 'text-black');
      button.classList.add('active-filter', 'bg-blue-600', 'text-white');
    }
  });
  currentPage = 1;
  loadFacilities();
}

function updateTable(facilities) {
  const list = document.getElementById('facilityList');
  list.innerHTML = '';

  facilities.forEach(fac => {
    const isPinned = PINNED_FACILITIES.includes(fac.id);
    const isPrioritized = PRIORITIZED_FACILITIES.includes(fac.id);
    const isHelix = HELIX_FACILITIES.includes(fac.id);
    const statusDot = getStatusDotClass(fac.active_status);

    const li = document.createElement('li');
    li.className = 'relative flex items-center justify-between p-4 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer facility-item';
    li.onclick = () => (window.location.href = `/radmapping/facilities/${fac.id}`);
    li.onmouseenter = () => showPopup(li);
    li.onmouseleave = () => hidePopup(li);

    li.innerHTML = `
      <div class="flex items-center gap-3">
        <div class="w-2 h-2 rounded-full ${statusDot}"></div>
        <div>
          <div class="flex items-center gap-1">
            ${isPinned ? '<span title="Pinned Facility" class="text-yellow-500 text-base">⭐</span>' : ''}
            ${isHelix ? '<span title="HELIX Facility" class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 mr-2">HELIX</span>' : ''}
            ${isPrioritized ? '<span title="Prioritized Facility" class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 mr-2">PRIO</span>' : ''}
            <p class="text-lg font-medium name">${fac.name}</p>
          </div>
          <p class="text-sm text-gray-500 location">${fac.location || 'No location specified'}</p>
        </div>
      </div>
      <span class="text-blue-600 font-semibold">Details →</span>

      <div class="facility-popup absolute left-0 top-full mt-2 w-[20rem] bg-white border p-3 rounded shadow-md text-left pointer-events-none opacity-0 transition-opacity duration-150 z-50">
        <p class="popup-line text-sm"><span class="popup-label">Location:</span> <span class="popup-value">${fac.location || 'N/A'}</span></p>
        <p class="popup-line text-sm"><span class="popup-label">PACS:</span> <span class="popup-value">${fac.pacs || 'N/A'}</span></p>
        <p class="popup-line text-sm"><span class="popup-label">Status:</span> <span class="popup-value">${getStatusLabel(fac.active_status)}</span></p>
        <p class="popup-line text-sm"><span class="popup-label">TAT Definition:</span> <span class="popup-value">${fac.tat_definition || 'N/A'}</span></p>
        <p class="popup-line text-sm"><span class="popup-label">Modalities Period:</span> <span class="popup-value">${fac.modalities_assignment_period || 'N/A'}</span></p>
      </div>
    `;

    list.appendChild(li);
  });
}

function updatePagination(total) {
  totalCount = total;
  const totalPages = Math.ceil(totalCount / itemsPerPage);
  const startItem = ((currentPage - 1) * itemsPerPage) + 1;
  const endItem = Math.min(currentPage * itemsPerPage, totalCount);

  document.getElementById('startItem').textContent = startItem;
  document.getElementById('endItem').textContent = endItem;
  document.getElementById('totalItems').textContent = totalCount;

  document.getElementById('prevPage').disabled = currentPage === 1;
  document.getElementById('nextPage').disabled = currentPage === totalPages;
}

function changePage(direction) {
  const totalPages = Math.ceil(totalCount / itemsPerPage);

  if (direction === 'next' && currentPage < totalPages) {
    currentPage++;
  } else if (direction === 'prev' && currentPage > 1) {
    currentPage--;
  }

  loadFacilities();
}

function showPopup(element) {
  const popup = element.querySelector('.facility-popup');
  if (popup) {
    popup.classList.remove('opacity-0');
    popup.classList.add('opacity-100');
  }
}

function hidePopup(element) {
  const popup = element.querySelector('.facility-popup');
  if (popup) {
    popup.classList.remove('opacity-100');
    popup.classList.add('opacity-0');
  }
}

function openPrioritizeModal() {
  document.getElementById('prioritizeModal').classList.remove('hidden');
  fetchAllFacilitiesForPrioritization();
}

function closePrioritizeModal() {
  document.getElementById('prioritizeModal').classList.add('hidden');
}

function openHelixModal() {
  document.getElementById('helixModal').classList.remove('hidden');
  fetchAllFacilitiesForHelix();
}

function closeHelixModal() {
  document.getElementById('helixModal').classList.add('hidden');
}

function fetchAllFacilitiesForPrioritization() {
    fetch(`/radmapping/facilities/search?search_name=&state=&status=all&fetch_all=true`)
        .then(response => response.json())
        .then(data => {
            allFacilitiesData = data.facilities;
            populatePrioritizeChecklist();
        })
        .catch(error => console.error('Error fetching all facilities for prioritization:', error));
}

function fetchAllFacilitiesForHelix() {
    fetch(`/radmapping/facilities/search?search_name=&state=&status=all&fetch_all=true`)
        .then(response => response.json())
        .then(data => {
            allFacilitiesData = data.facilities;
            populateHelixChecklist();
        })
        .catch(error => console.error('Error fetching all facilities for HELIX selection:', error));
}


function populatePrioritizeChecklist() {
  const checklist = document.getElementById('prioritizeFacilitiesList');
  checklist.innerHTML = '';

  allFacilitiesData.forEach(facility => {
    const isPrioritized = PRIORITIZED_FACILITIES.includes(facility.id);
    const checkboxDiv = document.createElement('div');
    checkboxDiv.className = 'flex items-center gap-2 p-2 border rounded hover:bg-gray-50 facility-item';
    checkboxDiv.innerHTML = `
      <input type="checkbox"
             id="prioritize-${facility.id}"
             class="prioritize-checkbox form-checkbox h-5 w-5 text-purple-600"
             data-facility-id="${facility.id}"
             data-facility-name="${facility.name.toLowerCase()}"
             onchange="updatePriorityCounter()"
             ${isPrioritized ? 'checked' : ''}>
      <label for="prioritize-${facility.id}" class="flex-1 cursor-pointer">
        ${facility.name}
        ${isPrioritized ? '<span title="Currently Prioritized" class="inline-flex items-center px-4 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 mr-2">Prioritized</span>' : ''}
      </label>
    `;
    checklist.appendChild(checkboxDiv);
  });
  updatePriorityCounter(); 
}

function updatePriorityCounter() {
  const checkedBoxes = document.querySelectorAll('.prioritize-checkbox:checked');
  const counter = document.getElementById('priorityCounter');
  counter.textContent = `${checkedBoxes.length} selected`;
}

function resetPriorities() {
  if (confirm('Are you sure you want to remove all facilities from prioritization?')) {
    document.querySelectorAll('.prioritize-checkbox').forEach(box => {
      box.checked = false;
    });
    updatePriorityCounter();
  }
}

function filterPrioritizeModalFacilities() {
  const searchTerm = document.getElementById('prioritizeModalSearch').value.toLowerCase();
  const facilityItems = document.querySelectorAll('#prioritizeFacilitiesList .facility-item');

  facilityItems.forEach(item => {
    const label = item.querySelector('label');
    const name = label ? label.textContent.toLowerCase() : '';
    item.style.display = name.includes(searchTerm) ? '' : 'none';
  });
}

function savePrioritizedFacilities() {
  const checkboxes = document.querySelectorAll('.prioritize-checkbox:checked');
  const facilityIds = Array.from(checkboxes).map(cb => cb.dataset.facilityId);

  fetch('/radmapping/facilities/prioritize', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ facility_ids: facilityIds })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      window.location.reload(); 
    } else {
      alert('Error saving prioritized facilities: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error saving prioritized facilities');
  });
}

function populateHelixChecklist() {
  const checklist = document.getElementById('helixFacilitiesList');
  checklist.innerHTML = '';

  allFacilitiesData.forEach(facility => {
    const isHelix = HELIX_FACILITIES.includes(facility.id);
    const checkboxDiv = document.createElement('div');
    checkboxDiv.className = 'flex items-center gap-2 p-2 border rounded hover:bg-gray-50 facility-item';
    checkboxDiv.innerHTML = `
      <input type="checkbox"
             id="helix-${facility.id}"
             class="helix-checkbox form-checkbox h-5 w-5 text-green-600"
             data-facility-id="${facility.id}"
             data-facility-name="${facility.name.toLowerCase()}"
             onchange="updateHelixCounter()"
             ${isHelix ? 'checked' : ''}>
      <label for="helix-${facility.id}" class="flex-1 cursor-pointer">
        ${facility.name}
        ${isHelix ? '<span title="Currently HELIX" class="inline-flex items-center px-4 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 mr-2">HELIX</span>' : ''}
      </label>
    `;
    checklist.appendChild(checkboxDiv);
  });
  updateHelixCounter();
}

function updateHelixCounter() {
  const checkedBoxes = document.querySelectorAll('.helix-checkbox:checked');
  const counter = document.getElementById('helixCounter');
  counter.textContent = `${checkedBoxes.length} selected`;
}

function resetHelixSelections() {
  if (confirm('Are you sure you want to remove all facilities from HELIX?')) {
    document.querySelectorAll('.helix-checkbox').forEach(box => {
      box.checked = false;
    });
    updateHelixCounter();
  }
}

function filterHelixModalFacilities() {
  const searchTerm = document.getElementById('helixModalSearch').value.toLowerCase();
  const facilityItems = document.querySelectorAll('#helixFacilitiesList .facility-item');

  facilityItems.forEach(item => {
    const label = item.querySelector('label');
    const name = label ? label.textContent.toLowerCase() : '';
    item.style.display = name.includes(searchTerm) ? '' : 'none';
  });
}

function saveHelixFacilities() {
  const checkboxes = document.querySelectorAll('.helix-checkbox:checked');
  const facilityIds = Array.from(checkboxes).map(cb => cb.dataset.facilityId);

  fetch('/radmapping/facilities/helix', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ facility_ids: facilityIds })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      window.location.reload();
    } else {
      alert('Error saving HELIX facilities: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error saving HELIX facilities');
  });
}

</script>

<style>
.form-checkbox {
  border-radius: 0.25rem;
  border-color: #d1d5db;
}

.form-checkbox:checked {
  background-color: #2563eb;
  border-color: #2563eb;
}

#addFacilityModal, #prioritizeModal, #helixModal {
  backdrop-filter: blur(4px);
}
#prioritizeFacilitiesList .facility-item label,
#pinFacilitiesList .facility-item label {
    overflow-wrap: break-word;
    min-width: 0;
}
</style>
{% endblock %}