{% extends "layout.html" %}

{% block title %}Facilities{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6 border-b pb-2">
  <h2 class="text-2xl font-semibold">Facilities</h2>
</div>

<div class="mb-4 flex flex-col md:flex-row gap-4">
  <div class="flex-1">
    <input type="text"
           id="searchBox"
           placeholder="Search by name..."
           class="w-full p-2 border rounded"
           onkeyup="debounceSearch()" />
  </div>
  <!-- Add Status Filter Buttons -->
  <div class="flex gap-2">
    <button onclick="filterByStatus('all')" 
            class="px-4 py-2 rounded text-sm font-medium bg-gray-100 hover:bg-gray-200" 
            data-status="all">
      All
    </button>
    <button onclick="filterByStatus('active')" 
            class="px-4 py-2 rounded text-sm font-medium bg-blue-600 text-white active-filter" 
            data-status="active">
      Active
    </button>
    <button onclick="filterByStatus('inactive')" 
            class="px-4 py-2 rounded text-sm font-medium bg-gray-100 hover:bg-gray-200" 
            data-status="inactive">
      Inactive
    </button>
  </div>
</div>

<!-- Facilities List -->
<ul id="facilityList" class="space-y-4">
  {% for facility in facilities %}
  <li class="relative flex items-center justify-between p-4 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer facility-item"
      onclick="window.location.href='/radmapping/facilities/{{ facility.id }}'"
      onmouseenter="showPopup(this)"
      onmouseleave="hidePopup(this)">
    <div class="flex items-center gap-3">
      <div class="w-2 h-2 rounded-full {% if facility.active_status == 'true' %}bg-green-500{% else %}bg-red-500{% endif %}"></div>
      <div>
        <p class="text-lg font-medium name">{{ facility.name }}</p>
        <p class="text-sm text-gray-500 location">{{ facility.location or 'No location specified' }}</p>
      </div>
    </div>
    <span class="text-blue-600 font-semibold">Details →</span>

    <!-- Hover Popup -->
    <div class="facility-popup absolute left-0 top-full mt-2 w-[20rem] bg-white border p-3 rounded shadow-md text-left pointer-events-none opacity-0 transition-opacity duration-150 z-50">
      <p class="text-sm font-medium">Location: <span class="text-gray-700">{{ facility.location or 'N/A' }}</span></p>
      <p class="text-sm font-medium">PACS: <span class="text-gray-700">{{ facility.pacs or 'N/A' }}</span></p>
      <p class="text-sm font-medium">Status: <span class="text-gray-700">{{ 'Active' if facility.active_status == 'true' else 'Inactive' }}</span></p>
      <p class="text-sm font-medium">TAT Definition: <span class="text-gray-700">{{ facility.tat_definition or 'N/A' }}</span></p>
      <p class="text-sm font-medium">Modalities Period: <span class="text-gray-700">{{ facility.modalities_assignment_period or 'N/A' }}</span></p>
    </div>
  </li>
  {% endfor %}
</ul>

<!-- Pagination Controls -->
<div class="mt-4 flex justify-between items-center">
  <div class="text-sm text-gray-700">
    Showing <span id="startItem">1</span> to <span id="endItem">{{ per_page }}</span> of <span id="totalItems">{{ total_count }}</span> entries
  </div>
  <div class="flex gap-2">
    <button onclick="changePage('prev')" id="prevPage" class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
      Previous
    </button>
    <button onclick="changePage('next')" id="nextPage" class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
      Next
    </button>
  </div>
</div>

<script>
let currentPage = parseInt("{{ current_page }}", 10);
const itemsPerPage = parseInt("{{ per_page }}", 10);
let totalCount = parseInt("{{ total_count }}", 10);
let searchTimeout;
let currentStatusFilter = 'active';

function openAddFacilityModal() {
  document.getElementById('addFacilityModal').classList.remove('hidden');
}

function closeAddFacilityModal() {
  document.getElementById('addFacilityModal').classList.add('hidden');
  document.getElementById('addFacilityForm').reset();
}

function submitAddFacility(event) {
  event.preventDefault();
  
  const formData = new FormData(event.target);
  const data = {
    name: formData.get('name'),
    location: formData.get('location'),
    pacs: formData.get('pacs'),
    tat_definition: formData.get('tat_definition'),
    modalities_assignment_period: formData.get('modalities_assignment_period'),
    active_status: formData.get('active_status') ? 'true' : 'false'
  };

  fetch('/radmapping/facilities/add', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(data)
  })
  .then(response => {
    if (response.ok) {
      closeAddFacilityModal();
      loadFacilities(); // Refresh the list
    } else {
      throw new Error('Failed to add facility');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to add facility. Please try again.');
  });
}

function debounceSearch() {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    currentPage = 1;
    loadFacilities();
  }, 300);
}

function loadFacilities() {
  const searchTerm = document.getElementById('searchBox').value;
  
  fetch(`/radmapping/facilities/search?page=${currentPage}&search=${encodeURIComponent(searchTerm)}&status=${currentStatusFilter}`)
    .then(response => response.json())
    .then(data => {
      updateTable(data.facilities);
      updatePagination(data.total_count);
    });
}

function filterByStatus(status) {
  currentStatusFilter = status;
  // Update button styles
  document.querySelectorAll('[data-status]').forEach(button => {
    button.classList.remove('active-filter', 'bg-blue-600', 'text-white');
    button.classList.add('bg-gray-100', 'text-black');
    if (button.dataset.status === status) {
      button.classList.remove('bg-gray-100', 'text-black');
      button.classList.add('active-filter', 'bg-blue-600', 'text-white');
    }
  });
  currentPage = 1;
  loadFacilities();
}

function updateTable(facilities) {
  const tbody = document.getElementById('facilityList');
  tbody.innerHTML = '';
  
  facilities.forEach(facility => {
    const li = document.createElement('li');
    li.className = 'relative flex items-center justify-between p-4 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer facility-item';
    li.onclick = () => window.location.href = `/radmapping/facilities/${facility.id}`;
    li.onmouseenter = () => showPopup(li);
    li.onmouseleave = () => hidePopup(li);
    
    li.innerHTML = `
      <div class="flex items-center gap-3">
        <div class="w-2 h-2 rounded-full ${facility.active_status === 'true' ? 'bg-green-500' : 'bg-red-500'}"></div>
        <div>
          <p class="text-lg font-medium name">${facility.name}</p>
          <p class="text-sm text-gray-500 location">${facility.location || 'No location specified'}</p>
        </div>
      </div>
      <span class="text-blue-600 font-semibold">Details →</span>

      <div class="facility-popup absolute left-0 top-full mt-2 w-[20rem] bg-white border p-3 rounded shadow-md text-left pointer-events-none opacity-0 transition-opacity duration-150 z-50">
        <p class="text-sm font-medium">Location: <span class="text-gray-700">${facility.location || 'N/A'}</span></p>
        <p class="text-sm font-medium">PACS: <span class="text-gray-700">${facility.pacs || 'N/A'}</span></p>
        <p class="text-sm font-medium">Status: <span class="text-gray-700">${facility.active_status === 'true' ? 'Active' : 'Inactive'}</span></p>
        <p class="text-sm font-medium">TAT Definition: <span class="text-gray-700">${facility.tat_definition || 'N/A'}</span></p>
        <p class="text-sm font-medium">Modalities Period: <span class="text-gray-700">${facility.modalities_assignment_period || 'N/A'}</span></p>
      </div>
    `;
    
    tbody.appendChild(li);
  });
}

function updatePagination(total) {
  totalCount = total;
  const totalPages = Math.ceil(totalCount / itemsPerPage);
  const startItem = ((currentPage - 1) * itemsPerPage) + 1;
  const endItem = Math.min(currentPage * itemsPerPage, totalCount);

  document.getElementById('startItem').textContent = startItem;
  document.getElementById('endItem').textContent = endItem;
  document.getElementById('totalItems').textContent = totalCount;

  document.getElementById('prevPage').disabled = currentPage === 1;
  document.getElementById('nextPage').disabled = currentPage === totalPages;
}

function changePage(direction) {
  const totalPages = Math.ceil(totalCount / itemsPerPage);
  
  if (direction === 'next' && currentPage < totalPages) {
    currentPage++;
  } else if (direction === 'prev' && currentPage > 1) {
    currentPage--;
  }
  
  loadFacilities();
}

function showPopup(element) {
  const popup = element.querySelector('.facility-popup');
  if (popup) {
    popup.classList.remove('opacity-0');
    popup.classList.add('opacity-100');
  }
}

function hidePopup(element) {
  const popup = element.querySelector('.facility-popup');
  if (popup) {
    popup.classList.remove('opacity-100');
    popup.classList.add('opacity-0');
  }
}

window.addEventListener('DOMContentLoaded', () => {
  // Set the active filter button style on page load
  document.querySelectorAll('[data-status]').forEach(button => {
    button.classList.remove('active-filter', 'bg-blue-600', 'text-white');
    if (button.dataset.status === 'active') {
      button.classList.add('active-filter', 'bg-blue-600', 'text-white');
    }
  });
  loadFacilities();
});
</script>
{% endblock %}
