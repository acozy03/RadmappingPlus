{% extends "layout.html" %}
{% block title %}{{ facility.name }}{% endblock %}

{% block content %}
<div x-data="{ editing: false }" class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm mb-6">
  <div class="flex justify-between items-center col-span-2">
    <h2 class="text-2xl font-semibold">{{ facility.name }}</h2>
    {% if session.user.role == 'admin' %}
      <button @click="editing = !editing" class="text-blue-600 text-sm hover:underline">
        <span x-show="!editing">Edit Info</span>
        <span x-show="editing">Cancel Edit</span>
      </button>
    {% endif %}
  </div>

  <form method="POST" action="{{ url_for('dashboard.update_facility', facility_id=facility.id) }}" class="grid grid-cols-1 sm:grid-cols-2 gap-4 col-span-2" x-show="editing">
    <label class="block">
      <span class="font-semibold">Location</span>
      <input type="text" name="location" value="{{ facility.location or '' }}" class="input w-full border rounded px-3 py-2 text-sm" />
    </label>

    <label class="block">
      <span class="font-semibold">PACS</span>
      <input type="text" name="pacs" value="{{ facility.pacs or '' }}" class="input w-full border rounded px-3 py-2 text-sm" />
    </label>

    <label class="block">
      <span class="font-semibold">TAT Definition</span>
      <input type="text" name="tat_definition" value="{{ facility.tat_definition or '' }}" class="input w-full border rounded px-3 py-2 text-sm" />
    </label>

    <label class="block">
      <span class="font-semibold">Modalities Assignment Period</span>
      <input type="text" name="modalities_assignment_period" value="{{ facility.modalities_assignment_period or '' }}" class="input w-full border rounded px-3 py-2 text-sm" />
    </label>
    
    <label class="flex items-center space-x-2 mt-4">
      <input type="checkbox" name="active_status" value="true" {% if facility.active_status == 'true' %}checked{% endif %} class="form-checkbox h-5 w-5 text-blue-600">
      <span class="text-sm font-medium">Active</span>
    </label>
    
    <div class="col-span-2">
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-semibold mt-2">
        Save Changes
      </button>
    </div>
  </form>

  <div x-show="!editing" class="grid grid-cols-1 sm:grid-cols-2 gap-4 col-span-2">
    <p><strong>Location:</strong> {{ facility.location }}</p>
    <p><strong>PACS:</strong> {{ facility.pacs }}</p>
    <p><strong>TAT Definition:</strong> {{ facility.tat_definition }}</p>
    <p><strong>Modalities:</strong> {{ facility.modalities_assignment_period }}</p>
    <p><strong>Status:</strong>
      {% if facility.active_status == 'true' %}
        <span class="text-green-600 font-medium">Active</span>
      {% else %}
        <span class="text-red-600 font-medium">Inactive</span>
      {% endif %}
    </p>
  </div>
</div>

<!-- Facility Contacts Section -->
<div class="mt-8">
  <div class="flex justify-between items-center mb-4">
    <h3 class="text-lg font-semibold">Facility Contacts</h3>
    <div class="flex gap-4">
      {% if session.user.role == 'admin' %}
        <button onclick="openAddContactModal()" class="text-blue-600 text-sm hover:underline">Add Contact</button>
      {% endif %}
      <button onclick="openContactModal()" class="text-blue-600 text-sm hover:underline">View Contacts</button>
    </div>
  </div>
</div>

<!-- Facility Contacts Modal -->
<div id="contactModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg w-[90%] max-w-3xl max-h-[80vh] overflow-y-auto p-6 relative">
    <button onclick="closeContactModal()" class="absolute top-2 right-2 text-2xl font-bold text-gray-500 hover:text-black">×</button>
    <h3 class="text-xl font-semibold mb-4">Contacts for {{ facility.name }}</h3>

    <!-- Search Input -->
    <div class="mb-4">
      <input type="text" 
             id="contactSearch" 
             placeholder="Search contacts..." 
             oninput="filterContacts(this.value)"
             class="w-full px-3 py-2 border rounded text-sm">
    </div>

    {% if facility_contacts %}
      <ul id="contactsList" class="space-y-4 text-sm">
        {% for contact in facility_contacts %}
        <li class="border rounded p-4 bg-gray-50 contact-item">
          <div class="flex justify-between">
            <div>
              <p><strong>Name:</strong> <span class="searchable">{{ contact.contact_name }}</span></p>
              <p><strong>Email:</strong> <a href="mailto:{{ contact.email }}" class="text-blue-600 hover:underline searchable">{{ contact.email }}</a></p>
              <p><strong>Phone:</strong> <span class="searchable">{{ contact.phone }}</span></p>
              <p><strong>Role:</strong> <span class="searchable">{{ contact.role }}</span></p>
              <p><strong>Comments:</strong> <span class="searchable">{{ contact.comments or "—" }}</span></p>
            </div>
            {% if session.user.role == 'admin' %}
            <div class="flex gap-2">
              <button onclick='editContact({{ contact|tojson|safe }})'class="text-blue-600 hover:text-red-800">Edit</button>
              <button onclick="deleteContact('{{ contact.id }}')" class="text-red-600 hover:text-red-800">Delete</button>
            </div>
            {% endif %}
          </div>
        </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-gray-500 italic">No contacts available for this facility.</p>
    {% endif %}
  </div>
</div>

<!-- Add Contact Modal -->
<div id="addContactModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg w-[90%] max-w-xl max-h-[80vh] overflow-y-auto p-6 relative">
    <button onclick="closeAddContactModal()" class="absolute top-2 right-2 text-2xl font-bold text-gray-500 hover:text-black">×</button>
    <h3 class="text-xl font-semibold mb-4">Add New Contact</h3>
    
    <form method="POST" action="{{ url_for('dashboard.add_facility_contact', facility_id=facility.id) }}" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Name</label>
        <input type="text" name="contact_name" required class="mt-1 block w-full border rounded-md shadow-sm py-2 px-3 text-sm">
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-700">Role</label>
        <input type="text" name="role" required class="mt-1 block w-full border rounded-md shadow-sm py-2 px-3 text-sm">
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-700">Email</label>
        <input type="email" name="email" class="mt-1 block w-full border rounded-md shadow-sm py-2 px-3 text-sm">
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-700">Phone</label>
        <input type="tel" name="phone" class="mt-1 block w-full border rounded-md shadow-sm py-2 px-3 text-sm">
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-700">Comments</label>
        <textarea name="comments" rows="3" class="mt-1 block w-full border rounded-md shadow-sm py-2 px-3 text-sm"></textarea>
      </div>
      
      <div class="flex justify-end gap-3">
        <button type="button" onclick="closeAddContactModal()" class="px-4 py-2 text-sm border rounded text-gray-700 hover:bg-gray-50">Cancel</button>
        <button type="submit" class="px-4 py-2 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">Add Contact</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Contact Modal -->
<div id="editContactModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg w-[90%] max-w-xl max-h-[80vh] overflow-y-auto p-6 relative">
    <button onclick="closeEditContactModal()" class="absolute top-2 right-2 text-2xl font-bold text-gray-500 hover:text-black">×</button>
    <h3 class="text-xl font-semibold mb-4">Edit Contact</h3>
    
    <form id="editContactForm" method="POST" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Name</label>
        <input type="text" name="contact_name" required class="mt-1 block w-full border rounded-md shadow-sm py-2 px-3 text-sm">
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-700">Role</label>
        <input type="text" name="role" required class="mt-1 block w-full border rounded-md shadow-sm py-2 px-3 text-sm">
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-700">Email</label>
        <input type="email" name="email" class="mt-1 block w-full border rounded-md shadow-sm py-2 px-3 text-sm">
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-700">Phone</label>
        <input type="tel" name="phone" class="mt-1 block w-full border rounded-md shadow-sm py-2 px-3 text-sm">
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-700">Comments</label>
        <textarea name="comments" rows="3" class="mt-1 block w-full border rounded-md shadow-sm py-2 px-3 text-sm"></textarea>
      </div>
      
      <div class="flex justify-end gap-3">
        <button type="button" onclick="closeEditContactModal()" class="px-4 py-2 text-sm border rounded text-gray-700 hover:bg-gray-50">Cancel</button>
        <button type="submit" class="px-4 py-2 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Contact Form (Hidden) -->
<form id="deleteContactForm" method="POST" style="display: none;"></form>

<script>
  function openContactModal() {
    document.getElementById('contactModal').classList.remove('hidden');
  }

  function closeContactModal() {
    document.getElementById('contactModal').classList.add('hidden');
  }

  function openAddContactModal() {
    document.getElementById('addContactModal').classList.remove('hidden');
  }

  function closeAddContactModal() {
    document.getElementById('addContactModal').classList.add('hidden');
  }

  function filterContacts(query) {
    const items = document.querySelectorAll('.contact-item');
    const q = query.toLowerCase();

    items.forEach(item => {
      const searchableContent = Array.from(item.querySelectorAll('.searchable'))
        .map(el => el.textContent.toLowerCase())
        .join(' ');
      
      item.style.display = searchableContent.includes(q) ? '' : 'none';
    });
  }

  function openEditContactModal() {
  document.getElementById('editContactModal').classList.remove('hidden');
}
  function editContact(contact) {
  const form = document.getElementById('editContactForm');

  form.action = "{{ url_for('dashboard.edit_facility_contact', facility_id=facility.id, contact_id='CONTACT_ID') }}".replace('CONTACT_ID', contact.id);

  form.querySelector('[name="contact_name"]').value = contact.contact_name || '';
  form.querySelector('[name="role"]').value = contact.role || '';
  form.querySelector('[name="email"]').value = contact.email || '';
  form.querySelector('[name="phone"]').value = contact.phone || '';
  form.querySelector('[name="comments"]').value = contact.comments || '';

  openEditContactModal();
}


  function closeEditContactModal() {
    document.getElementById('editContactModal').classList.add('hidden');
  }

  function deleteContact(contactId) {
    if (confirm('Are you sure you want to delete this contact?')) {
        fetch(`/facility/{{ facility.id }}/contact/${contactId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert('Error deleting contact');
            }
        });
    }
  }
</script>

<div class="mt-8">
  <div class="flex justify-between items-center mb-4">
    <h3 class="text-lg font-semibold">Assigned Radiologists</h3>
    {% if session.user.role == 'admin' %}
      <button onclick="openRadiologistModal()" class="text-blue-600 text-sm hover:underline">Edit Assignments</button>
    {% endif %}
  </div>
  {% if doctor_assignments %}
  <div class="overflow-x-auto">
    <table class="min-w-full bg-white border border-gray-200 text-sm">
      <thead class="bg-gray-100">
        <tr class="text-left">
          <th class="px-4 py-2 border-b">Name</th>
          <th class="px-4 py-2 border-b">Can Read</th>
          <th class="px-4 py-2 border-b">Does Stats</th>
          <th class="px-4 py-2 border-b">Does Routines</th>
          <th class="px-4 py-2 border-b">Stipulations</th>
          <th class="px-4 py-2 border-b">Notes</th>
        </tr>
      </thead>
      <tbody>
        {% for assignment in doctor_assignments %}
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-2 border-b">
            <a href="{{ url_for('dashboard.doctor_profile', rad_id=assignment.radiologists.id) }}"
               class="text-blue-700 hover:underline">
              {{ assignment.radiologists.name }}
            </a>
          </td>
          <td class="px-4 py-2 border-b">{{ "✅" if assignment.can_read else "❌" }}</td>
          <td class="px-4 py-2 border-b">{{ "✅" if assignment.does_stats else "❌" }}</td>
          <td class="px-4 py-2 border-b">{{ "✅" if assignment.does_routines else "❌" }}</td>
          <td class="px-4 py-2 border-b">{{ assignment.stipulations or "—" }}</td>
          <td class="px-4 py-2 border-b">{{ assignment.notes or "—" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <p class="text-gray-500 italic">No doctors assigned.</p>
  {% endif %}
</div>

<!-- Radiologist Assignment Modal -->
<div id="radiologistModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg w-[90%] max-w-3xl max-h-[80vh] overflow-y-auto p-6 relative">
    <button onclick="closeRadiologistModal()" class="absolute top-2 right-2 text-2xl font-bold text-gray-500 hover:text-black">×</button>
    <h3 class="text-xl font-semibold mb-4">Radiologist Assignments for {{ facility.name }}</h3>

    <input type="text" placeholder="Search radiologists..." oninput="filterRadiologists(this.value)"
           class="w-full mb-4 px-3 py-2 border rounded text-sm">
    
    <ul id="radiologistList" class="space-y-3 text-sm">
      {% for assignment in doctor_assignments %}
      <form method="POST" action="{{ url_for('dashboard.update_assignment', assignment_id=assignment.id) }}">
        <li class="border rounded p-3 bg-gray-50 radiologist-item">
          <div class="flex items-center justify-between">
            <div class="text-gray-700 font-medium">{{ assignment.radiologists.name }}</div>
            <div class="flex items-center gap-2">
              <label><input type="checkbox" name="can_read" {% if assignment.can_read %}checked{% endif %}> Read</label>
              <label><input type="checkbox" name="does_stats" {% if assignment.does_stats %}checked{% endif %}> Stats</label>
              <label><input type="checkbox" name="does_routines" {% if assignment.does_routines %}checked{% endif %}> Routine</label>
            </div>
          </div>
    
          <textarea name="stipulations" class="w-full border rounded mt-2" placeholder="Stipulations">{{ assignment.stipulations }}</textarea>
          <textarea name="notes" class="w-full border rounded mt-2" placeholder="Notes">{{ assignment.notes }}</textarea>
    
          <button type="submit" class="bg-blue-600 text-white text-sm px-3 py-1 rounded mt-2">Save Changes</button>
        </li>
      </form>
      {% endfor %}
    </ul>
  </div>
</div>

<script>
  function openRadiologistModal() {
    document.getElementById('radiologistModal').classList.remove('hidden');
  }
  
  function closeRadiologistModal() {
    document.getElementById('radiologistModal').classList.add('hidden');
  }
  
  function filterRadiologists(query) {
    const items = document.querySelectorAll('.radiologist-item');
    const q = query.toLowerCase();
  
    items.forEach(item => {
      const text = item.innerText.toLowerCase();
      item.style.display = text.includes(q) ? '' : 'none';
    });
  }
</script>
{% endblock %}