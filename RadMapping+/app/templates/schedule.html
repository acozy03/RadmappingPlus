{% extends "layout.html" %}
{% block title %}{{ month_name }} Schedule{% endblock %}

{% block content %}
<div class="flex flex-col h-[calc(100vh-150px)]">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-semibold">{{ month_name }} Schedule</h2>
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
                <input type="text" 
                       class="border rounded px-3 py-1 text-base" 
                       id="searchInput" 
                       placeholder="Search doctors..." 
                       onkeyup="handleSearch()">
            </div>
            <select id="scheduleFilter" class="border rounded px-2 py-1 text-base">
                <option value="time">Time Only</option>
                <option value="desc">Description Only</option>
            </select>
            <a href="{{ url_for('dashboard.schedule', year=year if month > 1 else year-1, month=month-1 if month > 1 else 12, start_day=1) }}" class="text-blue-600 hover:underline">← Previous Month</a>
            <a href="{{ url_for('dashboard.schedule', year=year if month < 12 else year+1, month=month+1 if month < 12 else 1, start_day=1) }}" class="text-blue-600 hover:underline">Next Month →</a>
            {% if session.user.role == 'admin' %}
                <button onclick="openToolsModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    Scheduling Tools
                </button>
                <button onclick="openPinModal()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
                    Pin Doctors
                </button>
            {% endif %}
        </div>
    </div>

    <!-- Height and Scroll Wrapper -->
    <div id="schedule-container" class="flex-1 overflow-y-auto max-w-full overflow-x-auto">
        <div id="schedule-scroll-wrapper" class="w-full border-b border-gray-200 mb-2">
            <table class="w-full min-w-[1200px] table-fixed text-base">
                <thead class="bg-gray-50 sticky top-0 z-30">
                    <tr class="h-16">
                        <th class="sticky left-0 bg-gray-50 z-40 w-48 px-4 py-3 font-medium text-left">Doctor</th>
                        {% set today_str = datetime.utcnow().strftime('%Y-%m-%d') %}
                        {% for day in range(1, days_in_month + 1) %}
                            {% set date = datetime(year, month, day) %}
                            {% set date_str = date.strftime('%Y-%m-%d') %}
                            <th data-date="{{ date_str }}" class="w-48 px-4 py-3 text-center{% if date_str == today_str %} today-header bg-blue-50{% endif %}">
                                <div class="font-medium">{{ date.strftime('%a') }}</div>
                                <div class="text-gray-600 text-sm">{{ day }}</div>
                            </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for doctor in doctors %}
                        <tr class="hover:bg-gray-50 h-16">
                            <td class="sticky left-0 bg-white z-20 w-48 px-4 py-2 font-medium text-left">
                                <div class="flex items-center gap-2">
                                    {% if doctor.id in pinned_doctors %}
                                  
                                        <span title="Pinned Doctor" class="text-yellow-500 text-sm">⭐</span>
                                    {% endif %}
                                    <a href="{{ url_for('dashboard.doctor_profile', rad_id=doctor.id) }}" class="text-blue-600 hover:underline">
                                        {{ doctor.name }}
                                    </a>
                                    {% if doctor.reads_routines %}
                                        <span class="inline-flex items-center justify-center text-xs font-bold text-purple-700 bg-purple-100 h-5 px-2 rounded" title="Routines">R</span>
                                    {% endif %}
                                </div>
                            </td>
                            {% for day in range(1, days_in_month + 1) %}
                                {% set date = datetime(year, month, day) %}
                                {% set date_str = date.strftime('%Y-%m-%d') %}
                                {% set schedule = calendar.get(date_str, {}).get(doctor.id) %}
                                {% set cell_class = '' %}
                                {% set details = schedule.schedule_details if schedule else '' %}
                                
                                {% if details %}
                                    {% set details_upper = details.upper() %}
                                    {% if 'OFF' in details_upper %}
                                        {% set cell_class = 'bg-red-100' %}
                                    {% elif 'VACATION' in details_upper %}
                                        {% set cell_class = 'bg-red-100' %}
                                    {% elif 'REACH AS NEEDED' in details_upper %}
                                        {% set cell_class = 'bg-gray-100' %}
                                    {% elif 'ONSITE' in details.lower() %}
                                        {% set cell_class = 'bg-orange-50' %}
                                    {% elif 'ROUTINE' in details_upper %}
                                        {% set cell_class = 'bg-green-50' %}
                                    {% endif %}
                                {% endif %}
                                {% if schedule and schedule.start_time and not cell_class %}
                                    {% set raw_hour = schedule.start_time.split(':')[0]|int %}
                                    {% if raw_hour >= 13 or raw_hour < 6 %}
                                        {% set cell_class = 'bg-orange-50' %}
                                    {% else %}
                                        {% set cell_class = 'bg-green-50' %}
                                    {% endif %}
                                {% endif %}
                                
                                <td class="w-48 px-4 py-3 text-center {{ cell_class }}{% if date_str == today_str %} today-col bg-blue-50{% endif %}">
                                    {% if schedule %}
                                        <div class="cell-content cursor-pointer" onclick="openScheduleModal('{{ doctor.id }}', '{{ date_str }}', '{{ schedule.start_time }}', '{{ schedule.end_time }}', `{{ schedule.schedule_details|e }}`)">
                                            {% set is_off = schedule.schedule_details and schedule.schedule_details.strip().upper() == 'OFF' %}
                                            {% set is_vac = schedule.schedule_details and schedule.schedule_details.strip().upper() == 'VACATION' %}
                                            <span class="cell-time text-sm">
                                                {% if is_off %}
                                                    <span class="text-gray-900">OFF</span>
                                                {% elif is_vac %}
                                                    <span class="text-gray-900">VACATION</span>
                                                {% elif schedule.schedule_details and schedule.schedule_details.strip().upper() == 'REACH AS NEEDED' %}
                                                    <span class="text-gray-900">REACH AS NEEDED</span>
                                                {% else %}
                                                    {{ schedule.start_time|ampm }} - {{ schedule.end_time|ampm }}
                                                {% endif %}
                                            </span>
                                            <span class="cell-desc text-sm">{{ schedule.schedule_details }}</span>
                                        </div>
                                        {% if session.user.role == 'admin' %}
                                            <form method="POST" action="{{ url_for('dashboard.delete_schedule', rad_id=doctor.id) }}" class="mt-1">
                                                <input type="hidden" name="date" value="{{ date_str }}" />
                                                <input type="hidden" name="year" value="{{ year }}" />
                                                <input type="hidden" name="month" value="{{ month }}" />
                                                <input type="hidden" name="start_day" value="{{ start_day }}" />
                                                <button type="submit" class="text-red-600 hover:text-red-800 text-xs font-medium">Delete</button>
                                            </form>
                                        {% endif %}
                                    {% else %}
                                        {% if session.user.role == 'admin' %}
                                            <div onclick="openScheduleModal('{{ doctor.id }}', '{{ date_str }}', '', '', '')" class="w-full h-full cursor-pointer text-center text-blue-600 hover:text-blue-800 text-xs font-medium">
                                                Add
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination Controls -->
    <div class="flex justify-between items-center mt-4 px-4">
        <div class="text-gray-600">
            Page {{ (start_doctor // 15) + 1 }} of {{ total_pages }}
            ({{ total_doctors }} total doctors)
        </div>
        <div class="flex gap-2">
            {% if start_doctor > 0 %}
                <a href="{{ url_for('dashboard.schedule', year=year, month=month, start_day=1, start_doctor=start_doctor - 15) }}" 
                   class="px-4 py-2 border rounded hover:bg-gray-100 text-blue-600">
                    ← Previous Page
                </a>
            {% endif %}
            {% if (start_doctor // 15) + 1 < total_pages %}
                <a href="{{ url_for('dashboard.schedule', year=year, month=month, start_day=1, start_doctor=start_doctor + 15) }}" 
                   class="px-4 py-2 border rounded hover:bg-gray-100 text-blue-600">
                    Next Page →
                </a>
            {% endif %}
        </div>
    </div>
</div>
<!-- Schedule Modal -->
<div id="scheduleModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg w-[90%] max-w-md p-6">
    <h3 class="text-lg font-semibold mb-4" id="modalTitle">Add Shift</h3>
    <form method="POST" action="{{ url_for('dashboard.update_schedule', rad_id='DOCTOR_ID_PLACEHOLDER') }}" class="space-y-3" id="scheduleForm">
      <input type="hidden" name="date" id="modalDate" />
      <input type="hidden" name="year" id="modalYear" value="{{ year }}" />
      <input type="hidden" name="month" id="modalMonth" value="{{ month }}" />
      <input type="hidden" name="start_day" id="modalStartDay" value="{{ start_day }}" />
      <div class="flex flex-col gap-2">
        <select id="modalNoTime" class="p-2 border rounded w-full">
          <option value="">-- Time Required --</option>
          <option value="OFF">OFF</option>
          <option value="VACATION">VACATION</option>
          <option value="REACH AS NEEDED">REACH AS NEEDED</option>
        </select>
        <div class="flex gap-2">
          <input type="time" name="start_time" id="modalStartTime" required class="flex-1 p-2 border rounded" />
          <input type="time" name="end_time" id="modalEndTime" required class="flex-1 p-2 border rounded" />
        </div>
      </div>
      <textarea name="schedule_details" id="modalDetails" placeholder="Schedule details..." class="w-full p-2 border rounded"></textarea>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeScheduleModal()" class="px-4 py-2 border rounded hover:bg-gray-100">
          Cancel
        </button>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" id="modalSaveBtn">
          Save
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Scheduling Tools Modal -->
<div id="toolsModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg w-[90%] max-w-4xl p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">Scheduling Tools</h3>
      <button onclick="closeToolsModal()" class="text-gray-500 hover:text-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Bulk Schedule -->
      <div class="bg-gray-50 p-4 rounded-lg">
        <h4 class="font-medium mb-3">Bulk Schedule</h4>
        <form method="POST" action="{{ url_for('dashboard.bulk_schedule') }}" class="space-y-3">
          <select name="doctor" required class="w-full p-2 border rounded">
            <option value="">Select Doctor</option>
            {% for doc in doctors %}
              <option value="{{ doc.id }}">{{ doc.name }}</option>
            {% endfor %}
          </select>
          <div class="flex gap-2">
            <input type="date" name="start_date" required class="flex-1 p-2 border rounded" />
            <input type="date" name="end_date" required class="flex-1 p-2 border rounded" />
          </div>
          <select id="bulkNoTime" class="w-full p-2 border rounded" onchange="handleBulkNoTimeChange()">
            <option value="">-- Time Required --</option>
            <option value="OFF">OFF</option>
            <option value="VACATION">VACATION</option>
            <option value="REACH AS NEEDED">REACH AS NEEDED</option>
          </select>
          <div class="flex gap-2" id="bulkTimeInputs">
            <input type="time" name="start_time" id="bulkStartTime" required class="flex-1 p-2 border rounded" />
            <input type="time" name="end_time" id="bulkEndTime" required class="flex-1 p-2 border rounded" />
          </div>
          <textarea name="schedule_details" id="bulkDetails" placeholder="Schedule details..." class="w-full p-2 border rounded"></textarea>
          <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded">Apply Schedule</button>
        </form>
      </div>

      <!-- Pattern Schedule -->
      <div class="bg-gray-50 p-4 rounded-lg">
        <h4 class="font-medium mb-3">Pattern Schedule</h4>
        <form method="POST" action="{{ url_for('dashboard.pattern_schedule') }}" class="space-y-3">
          <select name="doctor" required class="w-full p-2 border rounded">
            <option value="">Select Doctor</option>
            {% for doc in doctors %}
              <option value="{{ doc.id }}">{{ doc.name }}</option>
            {% endfor %}
          </select>
          <div class="flex gap-2">
            <input type="date" name="start_date" required class="flex-1 p-2 border rounded" />
            <input type="date" name="end_date" required class="flex-1 p-2 border rounded" />
          </div>
          <select id="patternNoTime" class="w-full p-2 border rounded" onchange="handlePatternNoTimeChange()">
            <option value="">-- Time Required --</option>
            <option value="OFF">OFF</option>
            <option value="VACATION">VACATION</option>
            <option value="REACH AS NEEDED">REACH AS NEEDED</option>
          </select>
          <div class="flex gap-2" id="patternTimeInputs">
            <input type="time" name="start_time" id="patternStartTime" required class="flex-1 p-2 border rounded" />
            <input type="time" name="end_time" id="patternEndTime" required class="flex-1 p-2 border rounded" />
          </div>
          <div class="flex flex-wrap gap-2">
            <label class="flex items-center gap-1">
              <input type="checkbox" name="days" value="1" class="form-checkbox" />
              <span>Mon</span>
            </label>
            <label class="flex items-center gap-1">
              <input type="checkbox" name="days" value="2" class="form-checkbox" />
              <span>Tue</span>
            </label>
            <label class="flex items-center gap-1">
              <input type="checkbox" name="days" value="3" class="form-checkbox" />
              <span>Wed</span>
            </label>
            <label class="flex items-center gap-1">
              <input type="checkbox" name="days" value="4" class="form-checkbox" />
              <span>Thu</span>
            </label>
            <label class="flex items-center gap-1">
              <input type="checkbox" name="days" value="5" class="form-checkbox" />
              <span>Fri</span>
            </label>
            <label class="flex items-center gap-1">
              <input type="checkbox" name="days" value="6" class="form-checkbox" />
              <span>Sat</span>
            </label>
            <label class="flex items-center gap-1">
              <input type="checkbox" name="days" value="0" class="form-checkbox" />
              <span>Sun</span>
            </label>
          </div>
          <textarea name="schedule_details" id="patternDetails" placeholder="Schedule details..." class="w-full p-2 border rounded"></textarea>
          <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded">Apply Pattern</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Pin Doctors Modal -->
<div id="pinModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg w-[90%] max-w-4xl p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">Pin Doctors</h3>
      <button onclick="closePinModal()" class="text-gray-500 hover:text-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    
    <div class="mb-4">
      <p class="text-gray-600">Select up to 15 doctors to pin to the first page of the schedule.</p>
      <p class="text-sm text-gray-500">Pinned doctors will always appear first on the schedule.</p>
    </div>

    <div class="flex justify-between items-center mb-4">
      <div class="flex-1 mr-4">
        <input type="text" 
               id="pinModalSearch" 
               class="w-full border rounded px-3 py-2" 
               placeholder="Search doctors..."
               oninput="filterPinModalDoctors()">
      </div>
      <div class="flex items-center gap-4">
        <span id="pinCounter" class="text-sm font-medium">0/15 selected</span>
        <button onclick="resetPins()" class="px-3 py-1 text-sm border border-red-500 text-red-500 rounded hover:bg-red-50">
          Reset All
        </button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto" id="pinDoctorsList">
      {% for doctor in all_doctors %}
        <div class="flex items-center gap-2 p-2 border rounded hover:bg-gray-50 doctor-item">
          <input type="checkbox" 
                 id="pin-{{ doctor.id }}" 
                 class="pin-checkbox form-checkbox h-5 w-5 text-purple-600"
                 data-doctor-id="{{ doctor.id }}"
                 data-doctor-name="{{ doctor.name|lower }}"
                 onchange="updatePinCounter()"
                 {% if doctor.id in pinned_doctors %}checked{% endif %}>
          <label for="pin-{{ doctor.id }}" class="flex-1 cursor-pointer">
            {{ doctor.name }}
            {% if doctor.id in pinned_doctors %}
              <span title="Currently Pinned" class="text-yellow-500 text-sm ml-1">⭐</span>
            {% endif %}
          </label>
        </div>
      {% endfor %}
    </div>

    <div class="mt-4 flex justify-end gap-2">
      <button onclick="closePinModal()" class="px-4 py-2 border rounded hover:bg-gray-100">
        Cancel
      </button>
      <button onclick="savePinnedDoctors()" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
        Save Pins
      </button>
    </div>
  </div>
</div>

<style>
table, th, td {
  border: none !important;
}
td[style*="position: sticky"], th[style*="position: sticky"] {
  background: white !important;
  z-index: 3;
  height: 100%;
  min-height: 64px;
}
tr:hover td[style*="position: sticky"] {
  background: #f9fafb !important;
}

.today-col {
  background: #e0f2fe !important;
}

.cell-content {
  min-height: 64px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  overflow: visible;
  text-overflow: ellipsis;
  white-space: normal;
  word-break: break-word;
  font-size: 1rem;
  position: relative;
  cursor: pointer;
  padding: 4px;
}

.cell-time, .cell-desc {
  padding: 2px 0;
  line-height: 1.4;
}

.cell-desc {
  font-size: 0.9rem;
  color: #374151;
}

.today-header {
  color: #2563eb !important;
  border-bottom: 3px solid #2563eb !important;
  background: #e0f2fe !important;
}

</style>
<script>
const serverToday = "{{ today_str }}";  // from Jinja
let searchTimeout;

function handleSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        const searchTerm = document.getElementById('searchInput').value;
        if (searchTerm.length === 0) {
            // If search is empty, reload the page to show all doctors
            window.location.href = `{{ url_for('dashboard.schedule') }}?year={{ year }}&month={{ month }}&start_doctor=0`;
            return;
        }
        
        // Make a request to the server to search all doctors
        fetch(`/dashboard/schedule/search?search=${encodeURIComponent(searchTerm)}`)
            .then(response => response.json())
            .then(data => {
                const tbody = document.querySelector('tbody');
                tbody.innerHTML = '';
                
                data.doctors.forEach(doctor => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50';
                    tr.style.height = '32px';
                    
                    // Add doctor name cell
                    const nameCell = document.createElement('td');
                    nameCell.className = 'px-6 py-5 font-medium';
                    nameCell.style.cssText = 'min-width: 180px; position: sticky; left: 0; background: white; z-index: 1; height: 32px;';
                    
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'flex items-center gap-2';
                    
                    const nameLink = document.createElement('a');
                    nameLink.href = `/dashboard/doctors/${doctor.id}`;
                    nameLink.className = 'text-blue-600 hover:underline text-base';
                    nameLink.textContent = doctor.name;
                    
                    nameDiv.appendChild(nameLink);
                    if (doctor.reads_routines) {
                        const routineSpan = document.createElement('span');
                        routineSpan.className = 'inline-flex items-center justify-center text-xs font-bold text-purple-700 bg-purple-100 h-5 px-2 rounded';
                        routineSpan.title = 'Routines';
                        routineSpan.textContent = 'R';
                        nameDiv.appendChild(routineSpan);
                    }
                    
                    nameCell.appendChild(nameDiv);
                    tr.appendChild(nameCell);
                    
                    // Add schedule cells for each day
                    const calendar = {{ calendar|tojson }};
                    const daysInMonth = {{ days_in_month }};
                    const year = {{ year }};
                    const month = {{ month }};
                    const isAdmin = {{ 'true' if session.user.role == 'admin' else 'false' }};
                    
                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = new Date(year, month - 1, day);
                        const dateStr = date.toISOString().split('T')[0];
                        const dateCell = document.createElement('td');
                        dateCell.className = 'px-6 py-1 align-top';
                        dateCell.style.cssText = 'min-width: 220px; height: 32px;';
                        
                        if (dateStr === serverToday) {
                            dateCell.classList.add('today-col');
                        }
                        
                        const schedule = calendar[dateStr]?.[doctor.id];
                        if (schedule) {
                            const cellContent = document.createElement('div');
                            cellContent.className = 'cell-content';
                            cellContent.style.cursor = 'pointer';
                            cellContent.onclick = () => openScheduleModal(
                                doctor.id,
                                dateStr,
                                schedule.start_time || '',
                                schedule.end_time || '',
                                schedule.schedule_details || ''
                            );
                            
                            const timeSpan = document.createElement('span');
                            timeSpan.className = 'cell-time';
                            
                            const details = schedule.schedule_details || '';
                            const detailsUpper = details.toUpperCase();
                            
                            if (detailsUpper === 'OFF') {
                                timeSpan.innerHTML = '<span class="text-black">OFF</span>';
                            } else if (detailsUpper === 'VACATION') {
                                timeSpan.innerHTML = '<span class="text-black">VACATION</span>';
                            } else if (detailsUpper === 'REACH AS NEEDED') {
                                timeSpan.innerHTML = '<span class="text-black">REACH AS NEEDED</span>';
                            } else {
                                timeSpan.textContent = `${schedule.start_time || ''} - ${schedule.end_time || ''}`;
                            }
                            
                            const descSpan = document.createElement('span');
                            descSpan.className = 'cell-desc';
                            descSpan.style.display = 'none';
                            descSpan.textContent = details;
                            
                            cellContent.appendChild(timeSpan);
                            cellContent.appendChild(descSpan);
                            dateCell.appendChild(cellContent);
                            
                            if (isAdmin) {
                                const deleteForm = document.createElement('form');
                                deleteForm.method = 'POST';
                                deleteForm.action = `/dashboard/doctors/${doctor.id}/delete_schedule`;
                                deleteForm.className = 'mt-1';
                                
                                const inputs = [
                                    { name: 'date', value: dateStr },
                                    { name: 'year', value: year },
                                    { name: 'month', value: month },
                                    { name: 'start_day', value: 1 }
                                ];
                                
                                inputs.forEach(input => {
                                    const inputEl = document.createElement('input');
                                    inputEl.type = 'hidden';
                                    inputEl.name = input.name;
                                    inputEl.value = input.value;
                                    deleteForm.appendChild(inputEl);
                                });
                                
                                const deleteButton = document.createElement('button');
                                deleteButton.type = 'submit';
                                deleteButton.className = 'text-red-600 hover:text-red-800 text-base font-semibold';
                                deleteButton.textContent = 'Delete';
                                
                                deleteForm.appendChild(deleteButton);
                                dateCell.appendChild(deleteForm);
                            }
                        } else if (isAdmin) {
                            const addDiv = document.createElement('div');
                            addDiv.onclick = () => openScheduleModal(doctor.id, dateStr, '', '', '');
                            addDiv.className = 'w-full h-full cursor-pointer text-center text-blue-600 hover:text-blue-800 text-base font-semibold';
                            addDiv.innerHTML = '&nbsp;';
                            dateCell.appendChild(addDiv);
                        }
                        
                        tr.appendChild(dateCell);
                    }
                    
                    tbody.appendChild(tr);
                });
            });
    }, 300);
}

function openScheduleModal(doctorId, date, startTime, endTime, details) {
  document.getElementById('modalDate').value = date;
  document.getElementById('modalYear').value = "{{ year }}";
  document.getElementById('modalMonth').value = "{{ month }}";
  document.getElementById('modalStartDay').value = "{{ start_day }}";
  document.getElementById('scheduleForm').action = "{{ url_for('dashboard.update_schedule', rad_id='DOCTOR_ID_PLACEHOLDER') }}".replace('DOCTOR_ID_PLACEHOLDER', doctorId);
  document.getElementById('scheduleModal').classList.remove('hidden');
  document.getElementById('modalStartTime').value = startTime || '';
  document.getElementById('modalEndTime').value = endTime || '';
  document.getElementById('modalDetails').value = details || '';
  // Set modal title and button text
  if (startTime || endTime || details) {
    document.getElementById('modalTitle').textContent = 'Edit Shift';
    document.getElementById('modalSaveBtn').textContent = 'Update';
  } else {
    document.getElementById('modalTitle').textContent = 'Add Shift';
    document.getElementById('modalSaveBtn').textContent = 'Save';
  }
  // Pre-fill No Time dropdown
  const noTime = (details && (details.trim().toUpperCase() === 'OFF' || details.trim().toUpperCase() === 'VACATION' || details.trim().toUpperCase() === 'REACH AS NEEDED')) ? details.trim() : '';
  document.getElementById('modalNoTime').value = noTime;
  handleNoTimeChange();
}

function closeScheduleModal() {
  document.getElementById('scheduleModal').classList.add('hidden');
}

function openToolsModal() {
  document.getElementById('toolsModal').classList.remove('hidden');
}

function closeToolsModal() {
  document.getElementById('toolsModal').classList.add('hidden');
}

function scrollToTodayColumn() {
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  const todayStr = `${yyyy}-${mm}-${dd}`;

  const th = document.querySelector(`th[data-date="${todayStr}"]`);
  const wrapper = document.getElementById('schedule-container');

  if (th && wrapper) {
    // Get position of the target column relative to the scroll container
    const thLeft = th.offsetLeft;
    const stickyTh = document.querySelector('th[style*="position: sticky"]');
    const stickyWidth = stickyTh ? stickyTh.offsetWidth : 0;
    console.log('thLeft:', thLeft);
    console.log('stickyWidth:', stickyWidth);
    wrapper.scrollLeft = thLeft - stickyWidth;

  } else {
    console.log('Today column or scroll wrapper not found.', th, wrapper);
  }
}

window.addEventListener('DOMContentLoaded', function() {
  setTimeout(scrollToTodayColumn, 500);
  // Filter logic
  const filter = document.getElementById('scheduleFilter');
  function applyFilter() {
    const showTime = filter.value === 'time';
    document.querySelectorAll('.cell-time').forEach(el => {
      el.style.display = showTime ? 'block' : 'none';
    });
    document.querySelectorAll('.cell-desc').forEach(el => {
      el.style.display = showTime ? 'none' : 'block';
    });
  }
  filter.addEventListener('change', applyFilter);
  applyFilter();
});
window.addEventListener('resize', function() {
  setTimeout(scrollToTodayColumn, 500);
});

// Handle No Time dropdown change
function handleNoTimeChange() {
  const noTime = document.getElementById('modalNoTime').value;
  const start = document.getElementById('modalStartTime');
  const end = document.getElementById('modalEndTime');
  if (noTime === 'OFF' || noTime === 'VACATION' || noTime === 'REACH AS NEEDED') {
    start.value = '';
    end.value = '';
    start.disabled = true;
    end.disabled = true;
    start.removeAttribute('required');
    end.removeAttribute('required');
    document.getElementById('modalDetails').value = noTime;
  } else {
    start.disabled = false;
    end.disabled = false;
    start.setAttribute('required', 'required');
    end.setAttribute('required', 'required');
    if (document.getElementById('modalDetails').value === 'OFF' || 
        document.getElementById('modalDetails').value === 'VACATION' || 
        document.getElementById('modalDetails').value === 'REACH AS NEEDED') {
      document.getElementById('modalDetails').value = '';
    }
  }
}
document.getElementById('modalNoTime').addEventListener('change', handleNoTimeChange);

function handleBulkNoTimeChange() {
  const noTime = document.getElementById('bulkNoTime').value;
  const start = document.getElementById('bulkStartTime');
  const end = document.getElementById('bulkEndTime');
  const details = document.getElementById('bulkDetails');
  
  if (noTime === 'OFF' || noTime === 'VACATION' || noTime === 'REACH AS NEEDED') {
    start.value = '';
    end.value = '';
    start.disabled = true;
    end.disabled = true;
    start.removeAttribute('required');
    end.removeAttribute('required');
    details.value = noTime;
  } else {
    start.disabled = false;
    end.disabled = false;
    start.setAttribute('required', 'required');
    end.setAttribute('required', 'required');
    if (details.value === 'OFF' || details.value === 'VACATION' || details.value === 'REACH AS NEEDED') {
      details.value = '';
    }
  }
}

function handlePatternNoTimeChange() {
  const noTime = document.getElementById('patternNoTime').value;
  const start = document.getElementById('patternStartTime');
  const end = document.getElementById('patternEndTime');
  const details = document.getElementById('patternDetails');
  
  if (noTime === 'OFF' || noTime === 'VACATION' || noTime === 'REACH AS NEEDED') {
    start.value = '';
    end.value = '';
    start.disabled = true;
    end.disabled = true;
    start.removeAttribute('required');
    end.removeAttribute('required');
    details.value = noTime;
  } else {
    start.disabled = false;
    end.disabled = false;
    start.setAttribute('required', 'required');
    end.setAttribute('required', 'required');
    if (details.value === 'OFF' || details.value === 'VACATION' || details.value === 'REACH AS NEEDED') {
      details.value = '';
    }
  }
}

function openPinModal() {
  document.getElementById('pinModal').classList.remove('hidden');
}

function closePinModal() {
  document.getElementById('pinModal').classList.add('hidden');
}

function savePinnedDoctors() {
  const checkboxes = document.querySelectorAll('.pin-checkbox:checked');
  const doctorIds = Array.from(checkboxes).map(cb => cb.dataset.doctorId);
  
  if (doctorIds.length > 15) {
    alert('You can only pin up to 15 doctors.');
    return;
  }

  fetch('/dashboard/schedule/pin', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ doctor_ids: doctorIds })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      window.location.reload();
    } else {
      alert('Error saving pinned doctors: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error saving pinned doctors');
  });
}

function updatePinCounter() {
  const checkedBoxes = document.querySelectorAll('.pin-checkbox:checked');
  const counter = document.getElementById('pinCounter');
  counter.textContent = `${checkedBoxes.length}/15 selected`;
  
  // Disable checkboxes if limit reached
  const uncheckedBoxes = document.querySelectorAll('.pin-checkbox:not(:checked)');
  if (checkedBoxes.length >= 15) {
    uncheckedBoxes.forEach(box => box.disabled = true);
  } else {
    uncheckedBoxes.forEach(box => box.disabled = false);
  }
}

function resetPins() {
  if (confirm('Are you sure you want to unpin all doctors?')) {
    document.querySelectorAll('.pin-checkbox').forEach(box => {
      box.checked = false;
      box.disabled = false;
    });
    updatePinCounter();
  }
}

function filterPinModalDoctors() {
  const searchTerm = document.getElementById('pinModalSearch').value.toLowerCase();
  const doctorItems = document.querySelectorAll('.doctor-item');
  
  doctorItems.forEach(item => {
    const checkbox = item.querySelector('.pin-checkbox');
    const doctorName = checkbox.dataset.doctorName;
    if (doctorName.includes(searchTerm)) {
      item.style.display = '';
    } else {
      item.style.display = 'none';
    }
  });
}
</script>
{% endblock %} 