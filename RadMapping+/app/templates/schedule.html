{% extends "layout.html" %}
{% block title %}{{ month_name }} Schedule{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
  <h2 class="text-2xl font-semibold">{{ month_name }} Schedule</h2>
  <div class="flex items-center gap-4">
    <select id="scheduleFilter" class="border rounded px-2 py-1 text-base">
      <option value="time">Time Only</option>
      <option value="desc">Description Only</option>
    </select>
    <a href="{{ url_for('dashboard.schedule', year=year if month > 1 else year-1, month=month-1 if month > 1 else 12, start_day=1) }}" class="text-blue-600 hover:underline">← Previous Month</a>
    <a href="{{ url_for('dashboard.schedule', year=year if month < 12 else year+1, month=month+1 if month < 12 else 1, start_day=1) }}" class="text-blue-600 hover:underline">Next Month →</a>
    {% if session.user.role == 'admin' %}
      <button onclick="openToolsModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        Scheduling Tools
      </button>
    {% endif %}
  </div>
</div>

<!-- Height and Scroll Wrapper -->
<div style="max-height: 800px; overflow-y: auto; max-width: 100vw; overflow-x: auto;">
  <div id="schedule-scroll-wrapper" style="width: 100%; border-bottom: 1px solid #e5e7eb; margin-bottom: 0.5rem;">
    <table style="width: max-content; min-width: 1400px; table-layout: fixed;" class="border text-base whitespace-nowrap">
      <thead class="bg-gray-100" style="position: sticky; top: 0; z-index: 3; background: white;">
        <tr style="height: 44px;">
          <th style="min-width: 180px; position: sticky; left: 0; background: white; z-index: 2;" class="px-6 py-3 border">Doctor</th>
          {% set today_str = datetime.utcnow().strftime('%Y-%m-%d') %}
          {% for day in range(1, days_in_month + 1) %}
            {% set date = datetime(year, month, day) %}
            {% set date_str = date.strftime('%Y-%m-%d') %}
            <th data-date="{{ date_str }}" style="min-width: 220px;" class="px-6 py-3 border{% if date_str == today_str %} today-header{% endif %}">
              <div class="font-medium">{{ date.strftime('%a') }}</div>
              <div class="text-gray-600">{{ day }}</div>
            </th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for doctor in doctors %}
        <tr class="hover:bg-gray-50" style="height: 32px;">
          <td style="min-width: 180px; position: sticky; left: 0; background: white; z-index: 1; height: 32px;" class="px-6 py-1 border font-medium">
            <div class="flex items-center gap-2">
              <a href="{{ url_for('dashboard.doctor_profile', rad_id=doctor.id) }}" class="text-blue-600 hover:underline text-base">
                {{ doctor.name }}
              </a>
              {% if doctor.reads_routines %}
                <span class="inline-flex items-center justify-center text-xs font-bold text-purple-700 bg-purple-100 h-5 px-2 rounded" title="Routines">R</span>
              {% endif %}
            </div>
          </td>
          {% for day in range(1, days_in_month + 1) %}
            {% set date = datetime(year, month, day) %}
            {% set date_str = date.strftime('%Y-%m-%d') %}
            {% set schedule = calendar.get(date_str, {}).get(doctor.id) %}
            {% set details = schedule.schedule_details if schedule else '' %}
            {% set cell_class = '' %}
            {% if details %}
              {% set details_upper = details.upper() %}
              {% if 'OFF' in details_upper %}
                {% set cell_class = 'bg-red-400' %}
              {% elif 'VACATION' in details_upper %}
                {% set cell_class = 'bg-red-400' %}
              {% elif 'ONSITE' in details.lower() %}
                {% set cell_class = 'bg-orange-100' %}
              {% elif 'REACH AS NEEDED' in details_upper %}
                {% set cell_class = 'bg-yellow-100' %}
              {% elif 'ROUTINE' in details_upper %}
                {% set cell_class = 'bg-green-100' %}
              {% endif %}
            {% endif %}
            {% if schedule and schedule.start_time and not cell_class %}
              {% set raw_hour = schedule.start_time.split(':')[0]|int %}
              {% if raw_hour >= 13 or raw_hour < 6 %}
                {% set cell_class = 'bg-orange-100' %}
              {% else %}
                {% set cell_class = 'bg-green-100' %}
              {% endif %}
            {% endif %}
            <td style="min-width: 220px; height: 32px;" class="px-6 py-1 border align-top {{ cell_class }}">
              {% if schedule %}
                <div class="cell-content" style="cursor:pointer;" onclick="openScheduleModal('{{ doctor.id }}', '{{ date_str }}', '{{ schedule.start_time }}', '{{ schedule.end_time }}', `{{ schedule.schedule_details|e }}`)">
                  {% set is_off = schedule.schedule_details and schedule.schedule_details.strip().upper() == 'OFF' %}
                  {% set is_vac = schedule.schedule_details and schedule.schedule_details.strip().upper() == 'VACATION' %}
                  <span class="cell-time">
                    {% if is_off %}
                      <span class="text-black">OFF</span>
                    {% elif is_vac %}
                      <span class="text-black">Vacation</span>
                    {% else %}
                      {{ schedule.start_time|ampm }} - {{ schedule.end_time|ampm }}
                    {% endif %}
                  </span>
                  <span class="cell-desc" style="display:none;">{{ schedule.schedule_details }}</span>
                </div>
                {% if session.user.role == 'admin' %}
                  <form method="POST" action="{{ url_for('dashboard.delete_schedule', rad_id=doctor.id) }}" class="mt-1">
                    <input type="hidden" name="date" value="{{ date_str }}" />
                    <input type="hidden" name="year" value="{{ year }}" />
                    <input type="hidden" name="month" value="{{ month }}" />
                    <input type="hidden" name="start_day" value="{{ start_day }}" />
                    <button type="submit" class="text-red-600 hover:text-red-800 text-base font-semibold">Delete</button>
                  </form>
                {% endif %}
              {% else %}
                {% if session.user.role == 'admin' %}
                  <button onclick="openScheduleModal('{{ doctor.id }}', '{{ date_str }}', '', '', '')" class="text-blue-600 hover:text-blue-800 text-base font-semibold">
                    Add Shift
                  </button>
                {% endif %}
              {% endif %}
            </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Schedule Modal -->
<div id="scheduleModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg w-[90%] max-w-md p-6">
    <h3 class="text-lg font-semibold mb-4" id="modalTitle">Add Shift</h3>
    <form method="POST" action="{{ url_for('dashboard.update_schedule', rad_id='DOCTOR_ID_PLACEHOLDER') }}" class="space-y-3" id="scheduleForm">
      <input type="hidden" name="date" id="modalDate" />
      <input type="hidden" name="year" id="modalYear" value="{{ year }}" />
      <input type="hidden" name="month" id="modalMonth" value="{{ month }}" />
      <input type="hidden" name="start_day" id="modalStartDay" value="{{ start_day }}" />
      <div class="flex flex-col gap-2">
        <select id="modalNoTime" class="p-2 border rounded w-full">
          <option value="">-- Time Required --</option>
          <option value="OFF">OFF</option>
          <option value="Vacation">Vacation</option>
        </select>
        <div class="flex gap-2">
          <input type="time" name="start_time" id="modalStartTime" required class="flex-1 p-2 border rounded" />
          <input type="time" name="end_time" id="modalEndTime" required class="flex-1 p-2 border rounded" />
        </div>
      </div>
      <textarea name="schedule_details" id="modalDetails" placeholder="Schedule details..." class="w-full p-2 border rounded"></textarea>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeScheduleModal()" class="px-4 py-2 border rounded hover:bg-gray-100">
          Cancel
        </button>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" id="modalSaveBtn">
          Save
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Scheduling Tools Modal -->
<div id="toolsModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg w-[90%] max-w-4xl p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">Scheduling Tools</h3>
      <button onclick="closeToolsModal()" class="text-gray-500 hover:text-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Bulk Schedule -->
      <div class="bg-gray-50 p-4 rounded-lg">
        <h4 class="font-medium mb-3">Bulk Schedule</h4>
        <form method="POST" action="{{ url_for('dashboard.bulk_schedule') }}" class="space-y-3">
          <select name="doctor" required class="w-full p-2 border rounded">
            <option value="">Select Doctor</option>
            {% for doc in doctors %}
              <option value="{{ doc.id }}">{{ doc.name }}</option>
            {% endfor %}
          </select>
          <div class="flex gap-2">
            <input type="date" name="start_date" required class="flex-1 p-2 border rounded" />
            <input type="date" name="end_date" required class="flex-1 p-2 border rounded" />
          </div>
          <div class="flex gap-2">
            <input type="time" name="start_time" required class="flex-1 p-2 border rounded" />
            <input type="time" name="end_time" required class="flex-1 p-2 border rounded" />
          </div>
          <textarea name="schedule_details" placeholder="Schedule details..." class="w-full p-2 border rounded"></textarea>
          <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded">Apply Schedule</button>
        </form>
      </div>

      <!-- Pattern Schedule -->
      <div class="bg-gray-50 p-4 rounded-lg">
        <h4 class="font-medium mb-3">Pattern Schedule</h4>
        <form method="POST" action="{{ url_for('dashboard.pattern_schedule') }}" class="space-y-3">
          <select name="doctor" required class="w-full p-2 border rounded">
            <option value="">Select Doctor</option>
            {% for doc in doctors %}
              <option value="{{ doc.id }}">{{ doc.name }}</option>
            {% endfor %}
          </select>
          <div class="flex gap-2">
            <input type="date" name="start_date" required class="flex-1 p-2 border rounded" />
            <input type="date" name="end_date" required class="flex-1 p-2 border rounded" />
          </div>
          <div class="flex gap-2">
            <input type="time" name="start_time" required class="flex-1 p-2 border rounded" />
            <input type="time" name="end_time" required class="flex-1 p-2 border rounded" />
          </div>
          <div class="flex flex-wrap gap-2">
            <label class="flex items-center gap-1">
              <input type="checkbox" name="days" value="1" class="form-checkbox" />
              <span>Mon</span>
            </label>
            <label class="flex items-center gap-1">
              <input type="checkbox" name="days" value="2" class="form-checkbox" />
              <span>Tue</span>
            </label>
            <label class="flex items-center gap-1">
              <input type="checkbox" name="days" value="3" class="form-checkbox" />
              <span>Wed</span>
            </label>
            <label class="flex items-center gap-1">
              <input type="checkbox" name="days" value="4" class="form-checkbox" />
              <span>Thu</span>
            </label>
            <label class="flex items-center gap-1">
              <input type="checkbox" name="days" value="5" class="form-checkbox" />
              <span>Fri</span>
            </label>
            <label class="flex items-center gap-1">
              <input type="checkbox" name="days" value="6" class="form-checkbox" />
              <span>Sat</span>
            </label>
            <label class="flex items-center gap-1">
              <input type="checkbox" name="days" value="0" class="form-checkbox" />
              <span>Sun</span>
            </label>
          </div>
          <textarea name="schedule_details" placeholder="Schedule details..." class="w-full p-2 border rounded"></textarea>
          <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded">Apply Pattern</button>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
.today-col {
  background: #e0f2fe !important;
  /* border-top: 3px solid #2563eb !important; */
}

.cell-content {
  max-height: 40px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  word-break: break-all;
  font-size: 1.25rem;
  position: relative;
  cursor: pointer;
}

.today-header {
  color: #2563eb !important;
  border-bottom: 3px solid #2563eb !important;
  background: #e0f2fe !important;
}
</style>
<script>
  const serverToday = "{{ today_str }}";  // from Jinja
</script>

<script>
function openScheduleModal(doctorId, date, startTime, endTime, details) {
  document.getElementById('modalDate').value = date;
  document.getElementById('modalYear').value = "{{ year }}";
  document.getElementById('modalMonth').value = "{{ month }}";
  document.getElementById('modalStartDay').value = "{{ start_day }}";
  document.getElementById('scheduleForm').action = "{{ url_for('dashboard.update_schedule', rad_id='DOCTOR_ID_PLACEHOLDER') }}".replace('DOCTOR_ID_PLACEHOLDER', doctorId);
  document.getElementById('scheduleModal').classList.remove('hidden');
  document.getElementById('modalStartTime').value = startTime || '';
  document.getElementById('modalEndTime').value = endTime || '';
  document.getElementById('modalDetails').value = details || '';
  // Set modal title and button text
  if (startTime || endTime || details) {
    document.getElementById('modalTitle').textContent = 'Edit Shift';
    document.getElementById('modalSaveBtn').textContent = 'Update';
  } else {
    document.getElementById('modalTitle').textContent = 'Add Shift';
    document.getElementById('modalSaveBtn').textContent = 'Save';
  }
  // Pre-fill No Time dropdown
  const noTime = (details && (details.trim().toUpperCase() === 'OFF' || details.trim().toUpperCase() === 'VACATION')) ? details.trim() : '';
  document.getElementById('modalNoTime').value = noTime;
  handleNoTimeChange();
}

function closeScheduleModal() {
  document.getElementById('scheduleModal').classList.add('hidden');
}

function openToolsModal() {
  document.getElementById('toolsModal').classList.remove('hidden');
}

function closeToolsModal() {
  document.getElementById('toolsModal').classList.add('hidden');
}


function scrollToTodayColumn() {
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  const todayStr = `${yyyy}-${mm}-${dd}`;
  console.log('Looking for th[data-date="' + todayStr + '"]');
  const th = document.querySelector('th[data-date="' + todayStr + '"]');
  let wrapper = document.getElementById('schedule-scroll-wrapper');
  if (th && wrapper) {
    // Try scrolling the wrapper
    const thRect = th.getBoundingClientRect();
    const wrapperRect = wrapper.getBoundingClientRect();
    const scrollLeft = th.offsetLeft - wrapperRect.width / 2 + thRect.width / 2;
    wrapper.scrollLeft = scrollLeft;
    // Check if scroll worked
    if (wrapper.scrollLeft !== scrollLeft) {
      // Try scrolling the parent
      wrapper = wrapper.parentElement;
      if (wrapper) {
        wrapper.scrollLeft = scrollLeft;
        console.log('Tried scrolling parent wrapper.');
      }
    }
    console.log('Scrolled to today column.');
  } else {
    console.log('Today column or wrapper not found.', th, wrapper);
  }
}

window.addEventListener('DOMContentLoaded', function() {
  setTimeout(scrollToTodayColumn, 500);
  // Filter logic
  const filter = document.getElementById('scheduleFilter');
  function applyFilter() {
    const showTime = filter.value === 'time';
    document.querySelectorAll('.cell-time').forEach(el => el.style.display = showTime ? '' : 'none');
    document.querySelectorAll('.cell-desc').forEach(el => el.style.display = showTime ? 'none' : '');
  }
  filter.addEventListener('change', applyFilter);
  applyFilter();
});
window.addEventListener('resize', function() {
  setTimeout(scrollToTodayColumn, 500);
});

// Handle No Time dropdown change
function handleNoTimeChange() {
  const noTime = document.getElementById('modalNoTime').value;
  const start = document.getElementById('modalStartTime');
  const end = document.getElementById('modalEndTime');
  if (noTime === 'OFF' || noTime === 'Vacation') {
    start.value = '';
    end.value = '';
    start.disabled = true;
    end.disabled = true;
    start.removeAttribute('required');
    end.removeAttribute('required');
    document.getElementById('modalDetails').value = noTime;
  } else {
    start.disabled = false;
    end.disabled = false;
    start.setAttribute('required', 'required');
    end.setAttribute('required', 'required');
    if (document.getElementById('modalDetails').value === 'OFF' || document.getElementById('modalDetails').value === 'Vacation') {
      document.getElementById('modalDetails').value = '';
    }
  }
}
document.getElementById('modalNoTime').addEventListener('change', handleNoTimeChange);
</script>
{% endblock %} 