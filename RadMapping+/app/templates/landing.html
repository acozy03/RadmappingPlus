{% extends "layout.html" %}
{% block title %}Welcome to RadMapping+{% endblock %}

{% block content %}
<div class="w-full h-full flex items-center justify-center px-6 py-10">
  <div class="w-full max-w-3xl">
    <div id="landingHero" class="text-center space-y-6">
      <h1 class="text-5xl md:text-7xl font-bold tracking-tight text-gray-900">RadMapping+</h1>
    </div>

    <div class="mt-10">
      <form id="landingAskForm" class="w-full" onsubmit="sendLandingMessage(event)">
        <div class="flex gap-3 items-center bg-white rounded-2xl shadow-lg border border-gray-200 px-4 py-3">
          <input
            type="text"
            id="landingInput"
            class="w-full bg-transparent focus:outline-none text-gray-900"
            placeholder="Ask Veston anything..."
            required
          />
          <button
            type="submit"
            class="bg-blue-600 hover:bg-blue-700 text-white rounded-xl px-4 py-2 transition-colors"
          >
            Send
          </button>
        </div>
      </form>
    </div>

    <div id="chatPanel" class="hidden mt-8 bg-white rounded-2xl border border-gray-200 shadow-xl overflow-hidden">
      <div class="flex items-center justify-between px-5 py-4 border-b border-gray-200 bg-gray-50">
        <h2 class="font-semibold text-gray-900">Veston</h2>
        <button id="newChatButton" class="text-sm text-blue-600 hover:text-blue-700" type="button">New chat</button>
      </div>
      <div id="landingMessages" class="h-[50vh] overflow-y-auto p-5 space-y-4 bg-white"></div>
      <div class="border-t border-gray-200 p-4 bg-gray-50">
        <form id="chatPanelForm" class="flex gap-3" onsubmit="sendLandingMessage(event)">
          <input
            type="text"
            id="chatPanelInput"
            class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Continue the conversation..."
            required
          />
          <button
            type="submit"
            class="bg-blue-600 hover:bg-blue-700 text-white rounded-xl px-4 py-2 transition-colors"
          >
            Send
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
function appendMessage(message, role) {
  const container = document.getElementById('landingMessages');
  const row = document.createElement('div');
  row.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

  const bubble = document.createElement('div');
  bubble.className = role === 'user'
    ? 'max-w-[85%] rounded-2xl rounded-br-md bg-blue-600 text-white px-4 py-3'
    : 'max-w-[85%] rounded-2xl rounded-bl-md bg-gray-100 text-gray-900 px-4 py-3';
  bubble.innerHTML = message.replace(/\n/g, '<br>');

  row.appendChild(bubble);
  container.appendChild(row);
  container.scrollTop = container.scrollHeight;
}

function setLoadingMessage(show) {
  const container = document.getElementById('landingMessages');
  const existing = document.getElementById('landingLoadingMessage');

  if (show && !existing) {
    const row = document.createElement('div');
    row.id = 'landingLoadingMessage';
    row.className = 'flex justify-start';
    row.innerHTML = '<div class="max-w-[85%] rounded-2xl rounded-bl-md bg-gray-100 text-gray-500 px-4 py-3">Thinking...</div>';
    container.appendChild(row);
    container.scrollTop = container.scrollHeight;
  }

  if (!show && existing) {
    existing.remove();
  }
}

async function sendLandingMessage(event) {
  event.preventDefault();

  const fromLandingInput = event.target.id === 'landingAskForm';
  const activeInput = fromLandingInput
    ? document.getElementById('landingInput')
    : document.getElementById('chatPanelInput');

  const question = activeInput.value.trim();
  if (!question) {
    return;
  }

  document.getElementById('landingHero').classList.add('hidden');
  document.getElementById('chatPanel').classList.remove('hidden');

  appendMessage(question, 'user');
  activeInput.value = '';

  if (fromLandingInput) {
    document.getElementById('chatPanelInput').focus();
  }

  try {
    setLoadingMessage(true);
    const response = await fetch('/radmapping/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ question }),
    });

    const data = await response.json();
    setLoadingMessage(false);

    if (!response.ok || data.error) {
      appendMessage(data.error || 'I ran into an issue getting a response.', 'assistant');
      return;
    }

    const reply = data?.output?.reply || data?.response || data?.reply || 'No response was returned.';
    appendMessage(reply, 'assistant');
  } catch (error) {
    setLoadingMessage(false);
    appendMessage('I ran into a technical error. Please try again.', 'assistant');
  }
}

function resetLandingChat() {
  document.getElementById('landingMessages').innerHTML = '';
  document.getElementById('chatPanel').classList.add('hidden');
  document.getElementById('landingHero').classList.remove('hidden');
  document.getElementById('landingInput').value = '';
  document.getElementById('chatPanelInput').value = '';
  document.getElementById('landingInput').focus();
}

document.getElementById('newChatButton').addEventListener('click', resetLandingChat);
</script>
{% endblock %}
